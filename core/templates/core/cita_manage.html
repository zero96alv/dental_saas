{% extends 'core/base.html' %}
{% load tenant_urls %}
{% load static %}

{% block title %}Gestionar Cita #{{ cita.id }}{% endblock %}

{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Gestionar Cita #{{ cita.id }}</h2>
    <div>
      <a class="btn btn-secondary" href="{% tenant_url 'core:cita_list' %}"><i class="bi bi-arrow-left"></i> Volver a Citas</a>
      <a class="btn btn-outline-primary" href="{% tenant_url 'core:paciente_detail' cita.paciente.id %}"><i class="bi bi-person"></i> Ver Paciente</a>
    </div>
  </div>

  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#resumen" type="button" role="tab">Resumen</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab">Historial Clínico</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tratamientos" type="button" role="tab">Tratamientos</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pagos" type="button" role="tab">Pagos</button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <div class="alert alert-info d-none" id="cita-action-msg"></div>
    <div class="tab-pane fade show active" id="resumen" role="tabpanel">
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Datos de la Cita</h5>
              <p><strong>Paciente:</strong> {{ cita.paciente }}</p>
              <p><strong>Dentista:</strong> {{ cita.dentista }}</p>
              <p><strong>Fecha y hora:</strong> {{ cita.fecha_hora }}</p>
              <p><strong>Unidad:</strong> {{ cita.unidad_dental }}</p>
              <p><strong>Estado:</strong> <span id="cita-estado">{{ cita.get_estado_display }}</span></p>
              <div class="d-grid gap-2 d-md-flex flex-md-wrap" role="toolbar" aria-label="Acciones de Estado">
                <button class="btn btn-outline-secondary btn-sm" data-estado="PRO" id="btn-pro">
                  <i class="bi bi-calendar"></i> Programar
                </button>
                <button class="btn btn-primary btn-sm" data-estado="CON" id="btn-con">
                  <i class="bi bi-check-circle"></i> Confirmar
                </button>
                <button class="btn btn-warning btn-sm" data-estado="ATN" id="btn-atn">
                  <i class="bi bi-person-check"></i> Atender
                </button>
                <button class="btn btn-success btn-sm" data-estado="COM" id="btn-com">
                  <i class="bi bi-check-all"></i> Completar
                </button>
                <button class="btn btn-danger btn-sm" data-estado="CAN" id="btn-can">
                  <i class="bi bi-x-circle"></i> Cancelar
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-8">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Servicios</h5>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalAgregarServicio">
                  <i class="bi bi-gear-fill"></i> Administrar Servicios
                </button>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <h6>Planeados</h6>
                  <ul id="lista-servicios-planeados">
                    {% for s in cita.servicios_planeados.all %}
                      <li>{{ s.nombre }} - ${{ s.precio }}</li>
                    {% empty %}<li>Sin servicios planeados</li>{% endfor %}
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6>Realizados</h6>
                  <ul id="lista-servicios-realizados">
                    {% for s in cita.servicios_realizados %}
                      <li>{{ s.nombre }} - ${{ s.precio }}</li>
                    {% empty %}<li>Sin servicios realizados</li>{% endfor %}
                  </ul>
                </div>
              </div>
              <div class="mt-3 p-3 bg-light rounded">
                <div class="row">
                  <div class="col-6">
                    <p class="mb-1"><strong>Costo de servicios:</strong></p>
                    <p class="mb-0 text-primary fs-5" id="costo-servicios">${{ cita.costo_real|floatformat:2 }}</p>
                  </div>
                  <div class="col-6">
                    <p class="mb-1"><strong>Total pagado:</strong> <span id="total-pagado">${{ cita.total_pagado|floatformat:2 }}</span></p>
                    <p class="mb-0"><strong>Saldo pendiente:</strong> <span class="text-danger fs-5" id="saldo-pendiente">${{ cita.saldo_pendiente|floatformat:2 }}</span></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="historial" role="tabpanel">
      <div class="row">
        <!-- Panel de historial existente -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-clock-history"></i>
                Historial Clínico del Paciente
              </h5>
            </div>
            <div class="card-body">
              <div class="mb-3 d-flex flex-wrap gap-2">
                <a class="btn btn-outline-info btn-sm" href="{% tenant_url 'core:paciente_history' cita.paciente.id %}" target="_blank">
                  <i class="bi bi-clock-history"></i> Ver Cronología + Odontograma
                </a>
                <a class="btn btn-outline-success btn-sm" href="{% tenant_url 'core:paciente_historial_mejorado' cita.paciente.id %}" target="_blank">
                  <i class="bi bi-clipboard-heart"></i> Capturar Antecedentes Completos
                </a>
              </div>
              <div class="alert alert-info py-2">
                <small>
                  <i class="bi bi-info-circle"></i>
                  <strong>Sistema Dual:</strong> Use "Cronología" para ver historial + odontograma. Use "Antecedentes" para capturar escalas de dolor, antecedentes familiares y hábitos.
                </small>
              </div>
              
              <!-- Mostrar últimas entradas del historial -->
              <div class="historial-reciente">
                <h6>Entradas Recientes:</h6>
                {% for entrada in cita.paciente.historial_clinico.all|slice:":5" %}
                <div class="border-start border-3 border-primary ps-3 mb-3">
                  <div class="d-flex justify-content-between">
                    <strong>{{ entrada.get_tipo_registro_display|default:"Registro" }}</strong>
                    <small class="text-muted">{{ entrada.fecha_evento|date:"d/m/Y H:i" }}</small>
                  </div>
                  <p class="mb-1">{{ entrada.descripcion_evento|truncatewords:25 }}</p>
                  {% if entrada.registrado_por %}
                    <small class="text-muted">Por: {{ entrada.registrado_por }}</small>
                  {% endif %}
                  {% if entrada.cita %}
                    <small class="text-muted"> | Cita: {{ entrada.cita.id }}</small>
                  {% endif %}
                </div>
                {% empty %}
                <div class="alert alert-info">
                  <i class="bi bi-info-circle"></i>
                  No hay entradas en el historial clínico.
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Panel para agregar nueva entrada -->
        <div class="col-md-4">
          <div class="card border-primary">
            <div class="card-header bg-primary text-white">
              <h6 class="mb-0">
                <i class="bi bi-lightning-charge"></i>
                Nota Rápida de Consulta
              </h6>
            </div>
            <div class="card-body">
              <p class="small text-muted mb-3">
                <i class="bi bi-info-circle"></i> Para notas rápidas durante la atención.
                Para antecedentes completos, use el botón verde arriba.
              </p>
              <form id="form-historial" method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="historial">
                
                <div class="mb-3">
                  <label for="tipo_registro" class="form-label">Tipo de Registro</label>
                  <select class="form-select" id="tipo_registro" name="tipo_registro" required>
                    <option value="CONSULTA">Consulta General</option>
                    <option value="DIAGNOSTICO">Diagnóstico</option>
                    <option value="TRATAMIENTO">Tratamiento Realizado</option>
                    <option value="SEGUIMIENTO">Seguimiento</option>
                    <option value="OBSERVACION">Observación General</option>
                    <option value="EMERGENCIA">Emergencia</option>
                  </select>
                </div>
                
                <div class="mb-3">
                  <label for="descripcion_evento" class="form-label">Descripción</label>
                  <textarea class="form-control" id="descripcion_evento" name="descripcion_evento" rows="4" 
                            placeholder="Descripción detallada del evento clínico..." required></textarea>
                </div>
                
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i>
                    Agregar al Historial
                  </button>
                </div>
              </form>
              
              <hr>
              
              <div class="text-center">
                <h6>Acceso Rápido</h6>
                <a href="{% tenant_url 'core:historial_create' cliente_id=cita.paciente.id %}" class="btn btn-outline-secondary btn-sm">
                  <i class="bi bi-file-earmark-plus"></i>
                  Formulario Avanzado
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Nueva pestaña de Tratamientos -->
    <div class="tab-pane fade" id="tratamientos" role="tabpanel">
      <div class="row">
        <div class="col-12 mb-3">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="mb-3 text-center"><i class="bi bi-diagram-2 me-1"></i> Odontograma</h5>
              <div class="d-flex justify-content-center align-items-center mb-2 gap-2">
                <div class="btn-group btn-group-sm" role="group" aria-label="Zoom odontograma">
                  <button class="btn btn-outline-secondary" id="odo-zoom-out"><i class="bi bi-zoom-out"></i></button>
                  <button class="btn btn-outline-secondary" id="odo-zoom-reset"><i class="bi bi-aspect-ratio"></i></button>
                  <button class="btn btn-outline-secondary" id="odo-zoom-in"><i class="bi bi-zoom-in"></i></button>
                </div>
              </div>
              <div id="odontograma-stage" class="odontograma-wrapper" style="min-height: 760px; overflow: auto; border: 1px solid #e9ecef; border-radius: 8px; background: #f8f9fa; display:flex; justify-content:center;">
                <div id="odontograma-scale" style="transform-origin: 0 0;"></div>
              </div>
              <small class="text-muted d-block mt-2 text-center">Toque los dientes; se añadirán abajo al formulario.</small>

              <!-- Paleta flotante de diagnóstico -->
              <div id="diag-palette" class="card shadow-sm" style="position: sticky; bottom: 10px; margin-top: 10px; z-index: 5;">
                <div class="card-body py-2">
                  <div class="d-flex flex-wrap align-items-center gap-2">
                    <span class="small text-muted">Diagnóstico rápido:</span>
                    <button type="button" class="btn btn-sm btn-outline-success diag-btn" data-diag="SANO">Sano</button>
                    <button type="button" class="btn btn-sm btn-outline-danger diag-btn" data-diag="CARIES">Caries</button>
                    <button type="button" class="btn btn-sm btn-outline-warning diag-btn" data-diag="OBTURADA">Obturación</button>
                    <button type="button" class="btn btn-sm btn-outline-primary diag-btn" data-diag="CORONA">Corona</button>
                    <button type="button" class="btn btn-sm btn-outline-pink diag-btn" data-diag="ENDODONCIA">Endodoncia</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary diag-btn" data-diag="EXTRAIDA">Extracción</button>
                    <input type="color" id="diag-color" class="form-control form-control-color form-control-sm ms-auto" title="Color" value="#ffffff">
                    <button type="button" class="btn btn-sm btn-primary" id="diag-apply">Aplicar</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="diag-clear">Limpiar selección</button>
                  </div>
                </div>
              </div>

              <script>
                (function(){
                  let scale = 1.0;
                  const minScale = 0.6, maxScale = 2.0, step = 0.1;
                  const scaleEl = document.getElementById('odontograma-scale');
                  function applyScale(){ scaleEl.style.transform = `scale(${scale})`; }
                  document.getElementById('odo-zoom-in')?.addEventListener('click', function(){ scale = Math.min(maxScale, +(scale + step).toFixed(2)); applyScale(); });
                  document.getElementById('odo-zoom-out')?.addEventListener('click', function(){ scale = Math.max(minScale, +(scale - step).toFixed(2)); applyScale(); });
                  document.getElementById('odo-zoom-reset')?.addEventListener('click', function(){ scale = 1.0; applyScale(); });

                  const selected = new Set();

                  // Vincular clics en dientes (toggle multi-selección)
                  function bindToothClicks(){
                    const selector = '#odontograma-stage .diente, #odontograma-stage .diente-clinico, #odontograma-stage .diente-movil';
                    const nodos = document.querySelectorAll(selector);
                    console.log('Dientes enlazados:', nodos.length);
                    nodos.forEach(function(d){
                      d.addEventListener('click', function(e){
                        e.stopPropagation();
                        console.log('Click diente:', d.id);
                        const id = d.id || '';
                        const num = id.replace('diente-','');
                        if (!num) return;
                        if (d.classList.contains('selected')) {
                          d.classList.remove('selected');
                          selected.delete(num);
                        } else {
                          d.classList.add('selected');
                          selected.add(num);
                        }
                        // Eventos para integraciones existentes
                        document.dispatchEvent(new CustomEvent('dienteSeleccionado', { detail: { numeroDiente: num, elemento: d } }));
                        document.dispatchEvent(new CustomEvent('dienteMovilSeleccionado', { detail: { numeroFDI: num, elemento: d } }));
                      });
                    });
                  }

                  // Colorear desde API estados actuales
                  async function hydrateFromApi(){
                    try{
                      const url = '{% tenant_url "core:odontograma_api_get" cita.paciente.id %}';
                      const r = await fetch(url, { headers: { 'Accept':'application/json' } });
                      if(!r.ok) return;
                      const data = await r.json();
                      const mapa = data.dientes || {};
                      const keys = Object.keys(mapa);
                      const classMap = {
                        'SANO':'sano', 'CARIES':'caries', 'OBTURACION':'obturada', 'OBTURADA':'obturada', 'CORONA':'corona',
                        'EXTRAIDO':'extraida', 'EXTRAIDA':'extraida', 'IMPLANTE':'implante', 'ENDODONCIA':'endodoncia'
                      };
                      keys.forEach(k=>{
                        const info = mapa[k] || {};
                        const el = document.getElementById('diente-'+k);
                        if(!el) return;
                        el.classList.remove('sano','caries','obturada','corona','extraida','implante','endodoncia');
                        let nombre = (info.diagnostico_nombre||'').toUpperCase();
                        if(!nombre) nombre = 'SANO';
                        const cls = classMap[nombre] || 'sano';
                        if(cls) el.classList.add(cls);
                        const oc = el.querySelector('.superficie-oclusal') || el.querySelector('.superficie-dental') || el.querySelector('path');
                        if(oc && info.diagnostico_color){ oc.style.fill = info.diagnostico_color; }
                      });
                    }catch(_e){}
                  }

                  // Cargar por defecto la variante móvil (sin marco)
                  (async function(){
                    await loadVariant('movil_optimizado');
                    const style = document.createElement('style');
                    style.innerHTML = `
                      .odontograma-movil{padding:0!important;background:transparent!important;box-shadow:none!important;border-radius:0!important}
                      .odontograma-movil svg{background:transparent!important}
                    `;
                    scaleEl.appendChild(style);
                  })();

                  // Vincular paleta de diagnóstico
                  const DIAG_MAP = {
                    {% for diagnostico in diagnosticos %}
                      "{{ diagnostico.nombre|upper }}": {{ diagnostico.id }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                  };
                  function getCSRF(){
                    const v = document.querySelector('[name=csrfmiddlewaretoken]')?.value; return v || '';
                  }
                  function norm(s){ return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase(); }
                  const ALIAS = { 'OBTURADA':'OBTURACION', 'EXTRAIDA':'EXTRAIDO', 'ENDODONCIA':'ENDODONCIA', 'SANO':'SANO', 'CARIES':'CARIES', 'CORONA':'CORONA' };
                  function findDiagId(nombre){
                    const up = norm(nombre);
                    if (DIAG_MAP[up]) return DIAG_MAP[up];
                    const alias = ALIAS[up];
                    if (alias && DIAG_MAP[alias]) return DIAG_MAP[alias];
                    // Fallback: buscar por startsWith/contains
                    const key = Object.keys(DIAG_MAP).find(k=>norm(k)===up || norm(k).startsWith(up) || up.startsWith(norm(k)));
                    return key ? DIAG_MAP[key] : null;
                  }
                  async function applyDiagnosisToSelected(nombre, color){
                    const diagId = findDiagId(nombre);
                    console.log('Aplicar diagnóstico:', nombre, '->', diagId, 'a', Array.from(selected));
                    if (!diagId || selected.size===0) return;
                    const url = '{% tenant_url "core:odontograma_api_update" cita.paciente.id %}';
                    const headers = { 'Content-Type':'application/json', 'X-CSRFToken': getCSRF(), 'X-Requested-With':'XMLHttpRequest' };
                    const lista = Array.from(selected).map(n=>parseInt(n,10));
                    try{
                      // Pintar en UI
                      lista.forEach(num=>{
                        const el = document.getElementById('diente-'+num);
                        if (el){ el.classList.remove('sano','caries','obturada','corona','extraida','implante','endodonica','endodoncia'); el.classList.add(norm(nombre).toLowerCase()); }
                      });
                      await fetch(url, { method:'POST', headers, body: JSON.stringify({ lista_numeros: lista, diagnostico_id: diagId, color_seleccionado: color||'' }) });
                    }catch(e){ console.error('Error aplicando diagnóstico:', e); }
                  }
                  document.querySelectorAll('.diag-btn').forEach(btn=>{
                    btn.addEventListener('click', async function(){
                      const nombre = this.dataset.diag||'SANO';
                      document.querySelectorAll('.diag-btn').forEach(b=>b.classList.remove('active'));
                      this.classList.add('active');
                    });
                  });
                  document.getElementById('diag-apply')?.addEventListener('click', async function(){
                    const active = document.querySelector('.diag-btn.active');
                    const nombre = active ? active.dataset.diag : 'SANO';
                    const color = document.getElementById('diag-color')?.value || '';
                    await applyDiagnosisToSelected(nombre, color);
                  });
                  document.getElementById('diag-clear')?.addEventListener('click', function(){
                    const selector = '#odontograma-stage .diente.selected, #odontograma-stage .diente-clinico.selected, #odontograma-stage .diente-movil.selected';
                    document.querySelectorAll(selector).forEach(x=>x.classList.remove('selected'));
                    selected.clear();
                    document.querySelectorAll('.diag-btn').forEach(b=>b.classList.remove('active'));
                  });

                  // API de carga de variante
                  async function loadVariant(variant){
                    const url = '{% tenant_url "core:odontograma_partial" %}?variant=' + encodeURIComponent(variant);
                    const r = await fetch(url, { headers: { 'Accept':'text/html' } });
                    if(!r.ok){ console.error('Error cargando odontograma:', r.status); return; }
                    const html = await r.text();
                    scaleEl.innerHTML = html;
                    console.log('Odontograma cargado:', variant);
                    bindToothClicks();
                    hydrateFromApi();
                  }

                  bindToothClicks();
                  hydrateFromApi();

                  // Hacer 'selected' accesible globalmente para el botón de copiar
                  window.odontogramaSelected = selected;
                })();

                // Script para copiar dientes seleccionados al formulario
                document.getElementById('btn-copiar-seleccion')?.addEventListener('click', function(){
                  const selected = window.odontogramaSelected;
                  if(!selected || selected.size === 0){
                    alert('No hay dientes seleccionados en el odontograma');
                    return;
                  }
                  const nums = Array.from(selected).sort((a,b)=>a-b).join(',');
                  document.getElementById('dientes_tratados').value = nums;
                  console.log('Dientes copiados:', nums);
                  // Feedback visual
                  const btn = this;
                  const originalHTML = btn.innerHTML;
                  btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> ¡Copiado!';
                  btn.classList.remove('btn-outline-primary');
                  btn.classList.add('btn-success');
                  setTimeout(function(){
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                  }, 1500);
                });
              </script>
            </div>
          </div>
        </div>

        <!-- Formulario de tratamiento debajo -->
        <div class="col-12 mb-3">
          <div class="card h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-plus-circle"></i> Registrar Tratamiento</h6>
            </div>
            <div class="card-body">
              <form id="form-tratamiento" method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="tratamiento">

                <div class="mb-3">
                  <label for="servicios" class="form-label">
                    <i class="bi bi-bag-check"></i> Servicios Realizados
                  </label>
                  <select class="form-select" id="servicios" name="servicios" multiple size="5" required>
                    {% for servicio in cita.servicios_planeados.all %}
                      <option value="{{ servicio.id }}" selected>{{ servicio.nombre }} - ${{ servicio.precio }}</option>
                    {% endfor %}
                    {% comment %}Si no hay planeados, mostrar todos los servicios activos{% endcomment %}
                    {% if not cita.servicios_planeados.all %}
                      {% for servicio in servicios_disponibles %}
                        <option value="{{ servicio.id }}">{{ servicio.nombre }} - ${{ servicio.precio }}</option>
                      {% endfor %}
                    {% endif %}
                  </select>
                  <div class="form-text">
                    <i class="bi bi-info-circle"></i> Mantener Ctrl (Cmd en Mac) para seleccionar múltiples servicios.
                    Por defecto se muestran los servicios planeados.
                  </div>
                </div>

                <div class="mb-3">
                  <label for="dientes_tratados" class="form-label">
                    <i class="bi bi-heart-pulse"></i> Dientes Tratados
                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="btn-copiar-seleccion">
                      <i class="bi bi-clipboard-check"></i> Copiar dientes seleccionados
                    </button>
                  </label>
                  <input type="text" class="form-control" id="dientes_tratados" name="dientes_tratados" placeholder="Ej: 16,17,18" required>
                  <div class="form-text">Separar múltiples dientes con comas. O usa el botón para copiar los seleccionados en el odontograma arriba.</div>
                </div>

                <div class="mb-3">
                  <label for="descripcion" class="form-label">Tratamiento Realizado</label>
                  <textarea class="form-control" id="descripcion" name="descripcion" rows="3" placeholder="Descripción detallada del tratamiento" required></textarea>
                </div>
                <div class="mb-3">
                  <label for="estado_inicial" class="form-label">Estado Inicial</label>
                  <textarea class="form-control" id="estado_inicial" name="estado_inicial" rows="2" placeholder="Descripción del estado antes del tratamiento" required></textarea>
                </div>
                <div class="mb-3">
                  <label for="estado_final" class="form-label">Estado Final</label>
                  <textarea class="form-control" id="estado_final" name="estado_final" rows="2" placeholder="Descripción del estado después del tratamiento" required></textarea>
                </div>
                <div class="mb-3">
                  <label for="diagnostico_final_id" class="form-label">Diagnóstico Final</label>
                  <select class="form-select" id="diagnostico_final_id" name="diagnostico_final_id" required>
                    <option value="">Seleccionar diagnóstico...</option>
                    {% for diagnostico in diagnosticos %}
                      <option value="{{ diagnostico.id }}">{{ diagnostico.nombre }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-3">
                  <label for="trabajo_pendiente" class="form-label">Trabajo Pendiente</label>
                  <textarea class="form-control" id="trabajo_pendiente" name="trabajo_pendiente" rows="2" placeholder="Trabajo que queda pendiente (opcional)"></textarea>
                </div>
                <div class="mb-3 form-check">
                  <input type="checkbox" class="form-check-input" id="requiere_seguimiento" name="requiere_seguimiento">
                  <label class="form-check-label" for="requiere_seguimiento">Requiere seguimiento</label>
                </div>
                <div class="mb-3" id="fecha-seguimiento-container" style="display:none;">
                  <label for="fecha_seguimiento" class="form-label">Fecha de Seguimiento</label>
                  <input type="date" class="form-control" id="fecha_seguimiento" name="fecha_seguimiento">
                </div>
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle"></i> Registrar Tratamiento</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Lista de tratamientos realizados debajo, a ancho completo -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-clipboard-pulse"></i> Tratamientos Realizados</h5>
            </div>
            <div class="card-body">
              <div id="tratamientos-existentes">
                {% for tratamiento in cita.tratamientos_realizados.all %}
                  <div class="border rounded p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h6 class="mb-0">
                        <i class="bi bi-heart-pulse text-danger"></i> {{ tratamiento.dientes_formateados }}
                      </h6>
                      <small class="text-muted">{{ tratamiento.fecha_registro|date:"d/m/Y H:i" }}</small>
                    </div>

                    {% if tratamiento.servicios.all %}
                      <div class="mb-2">
                        <strong><i class="bi bi-bag-check text-success"></i> Servicios realizados:</strong>
                        <ul class="list-unstyled ms-3 mt-1">
                          {% for servicio in tratamiento.servicios.all %}
                            <li><span class="badge bg-success-subtle text-success">{{ servicio.nombre }} - ${{ servicio.precio }}</span></li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}

                    <p class="mb-2"><strong>Descripción:</strong> {{ tratamiento.descripcion|truncatewords:20 }}</p>
                    <p class="mb-2"><strong>Estado inicial:</strong> {{ tratamiento.estado_inicial_descripcion|truncatewords:15 }}</p>
                    <p class="mb-2"><strong>Estado final:</strong> {{ tratamiento.estado_final_descripcion|truncatewords:15 }}</p>
                    {% if tratamiento.trabajo_pendiente %}
                      <div class="alert alert-warning py-2"><small><strong>Pendiente:</strong> {{ tratamiento.trabajo_pendiente }}</small></div>
                    {% endif %}
                    {% if tratamiento.requiere_seguimiento %}
                      <div class="alert alert-info py-2"><small><strong>Seguimiento:</strong> {{ tratamiento.fecha_seguimiento_sugerida|date:"d/m/Y" }}</small></div>
                    {% endif %}
                    <small class="text-muted">Registrado por: {{ tratamiento.registrado_por }}</small>
                  </div>
                {% empty %}
                  <div class="alert alert-info"><i class="bi bi-info-circle"></i> No se han registrado tratamientos para esta cita.</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <script>
        // Vincular selección del odontograma con el campo de tratamiento
        document.addEventListener('dienteSeleccionado', function(e) {
          const input = document.getElementById('dientes_tratados');
          if (!input) return;
          const num = String(e.detail?.numeroDiente || '').trim();
          if (!num) return;
          const actuales = input.value.split(',').map(s=>s.trim()).filter(Boolean);
          if (!actuales.includes(num)) {
            actuales.push(num);
            input.value = actuales.join(',');
          }
          input.focus();
        });
      </script>
    </div>

    <div class="tab-pane fade" id="pagos" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Pagos de la Cita</h5>
          <ul>
            {% for p in cita.pagos.all %}
              <li>{{ p.fecha_pago }} - ${{ p.monto }} ({{ p.metodo_pago }})</li>
            {% empty %}
              <li>No hay pagos registrados.</li>
            {% endfor %}
          </ul>

          {% if cita.saldo_pendiente > 0 %}
            <a href="{% tenant_url 'core:procesar_pago' cita.id %}" class="btn btn-success">
              <i class="fas fa-dollar-sign me-1"></i>Registrar pago
            </a>
            <p class="text-muted mt-2 mb-0">
              <small>Saldo pendiente: <strong class="text-danger">${{ cita.saldo_pendiente|floatformat:2 }}</strong></small>
            </p>
          {% else %}
            <div class="alert alert-success mt-2 mb-0">
              <i class="fas fa-check-circle me-2"></i>
              <strong>Cita completamente pagada</strong>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para administrar servicios con dual-list -->
<div class="modal fade" id="modalAgregarServicio" tabindex="-1" aria-labelledby="modalAgregarServicioLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalAgregarServicioLabel">
          <i class="bi bi-gear-fill"></i> Administración de Servicios de la Cita
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Buscador -->
        <div class="row mb-3">
          <div class="col-12">
            <div class="input-group">
              <span class="input-group-text">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" class="form-control" id="buscar-servicio"
                     placeholder="Buscar servicios por nombre...">
            </div>
          </div>
        </div>

        <!-- Dual List -->
        <div class="row">
          <!-- Lista de servicios disponibles -->
          <div class="col-md-5">
            <div class="card h-100">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="bi bi-list-ul"></i> Servicios Disponibles
                  <span class="badge bg-secondary" id="count-disponibles">0</span>
                </h6>
              </div>
              <div class="card-body p-0">
                <div class="list-group list-group-flush" id="lista-disponibles" style="max-height: 400px; overflow-y: auto;">
                  {% for servicio in servicios_disponibles %}
                    {% if servicio not in cita.servicios_planeados.all %}
                    <div class="list-group-item list-group-item-action servicio-item"
                         data-servicio-id="{{ servicio.id }}"
                         data-servicio-nombre="{{ servicio.nombre }}"
                         data-servicio-precio="{{ servicio.precio }}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                          <strong>{{ servicio.nombre }}</strong>
                          <br>
                          <small class="text-muted">
                            <i class="bi bi-currency-dollar"></i> ${{ servicio.precio|floatformat:2 }}
                          </small>
                        </div>
                        <button type="button" class="btn btn-sm btn-success btn-agregar"
                                data-servicio-id="{{ servicio.id }}"
                                title="Agregar a la cita">
                          <i class="bi bi-arrow-right"></i>
                        </button>
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>

          <!-- Botones centrales -->
          <div class="col-md-2 d-flex flex-column justify-content-center align-items-center gap-2">
            <button type="button" class="btn btn-success" id="btn-agregar-todos" title="Agregar todos">
              <i class="bi bi-chevron-double-right"></i>
            </button>
            <button type="button" class="btn btn-danger" id="btn-quitar-todos" title="Quitar todos">
              <i class="bi bi-chevron-double-left"></i>
            </button>
            <div class="text-center mt-3">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i><br>
                Use los botones<br>
                o haga doble<br>
                click en el item
              </small>
            </div>
          </div>

          <!-- Lista de servicios seleccionados -->
          <div class="col-md-5">
            <div class="card h-100">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                  <i class="bi bi-check-circle"></i> Servicios Seleccionados
                  <span class="badge bg-light text-dark" id="count-seleccionados">0</span>
                </h6>
              </div>
              <div class="card-body p-0">
                <div class="list-group list-group-flush" id="lista-seleccionados" style="max-height: 400px; overflow-y: auto;">
                  {% for servicio in cita.servicios_planeados.all %}
                    <div class="list-group-item list-group-item-action list-group-item-success servicio-item-seleccionado"
                         data-servicio-id="{{ servicio.id }}"
                         data-servicio-nombre="{{ servicio.nombre }}"
                         data-servicio-precio="{{ servicio.precio }}">
                      <div class="d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-sm btn-danger btn-quitar"
                                data-servicio-id="{{ servicio.id }}"
                                title="Quitar de la cita">
                          <i class="bi bi-arrow-left"></i>
                        </button>
                        <div class="flex-grow-1 ms-2">
                          <strong>{{ servicio.nombre }}</strong>
                          <br>
                          <small class="text-dark">
                            <i class="bi bi-currency-dollar"></i> ${{ servicio.precio|floatformat:2 }}
                          </small>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Resumen de costos -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="alert alert-info mb-0">
              <div class="row text-center">
                <div class="col-md-4">
                  <strong><i class="bi bi-calculator"></i> Costo actual:</strong><br>
                  <span class="fs-5">$<span id="costo-actual">{{ cita.costo_real|floatformat:2 }}</span></span>
                </div>
                <div class="col-md-4">
                  <strong><i class="bi bi-plus-minus"></i> Diferencia:</strong><br>
                  <span class="fs-5" id="diferencia-costo">+$0.00</span>
                </div>
                <div class="col-md-4">
                  <strong><i class="bi bi-currency-dollar"></i> Nuevo total:</strong><br>
                  <span class="fs-5 text-primary"><strong>$<span id="nuevo-total">{{ cita.costo_real|floatformat:2 }}</span></strong></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
        <button type="button" class="btn btn-primary" id="btn-confirmar-agregar-servicio">
          <i class="bi bi-check-circle"></i> Guardar Cambios
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const msg = document.getElementById('cita-action-msg');
  function showMsg(text, ok=true){
    msg.classList.remove('d-none','alert-success','alert-danger');
    msg.classList.add(ok ? 'alert-success' : 'alert-danger');
    msg.textContent = text;
  }
  function getCookie(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  function getCSRF(){
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken') || '';
  }
  function activateTab(target){
    try {
      const btn = document.querySelector(`[data-bs-target="${target}"]`);
      if (btn && window.bootstrap && bootstrap.Tab){
        new bootstrap.Tab(btn).show();
      } else if (btn) { btn.click(); }
    } catch(_e){}
  }
  function cambiarEstado(estado){
    const csrftoken = getCSRF();
    fetch('{% tenant_url "core:cita_cambiar_estado" cita.id %}', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest', 'Accept':'application/json' },
      body: new URLSearchParams({ estado })
    }).then(async r => {
      if (!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }).then(data => {
      if (data.success){
        showMsg(data.message, true);
        document.getElementById('cita-estado').textContent = estadoMap[estado] || estado;
        // Flujos asociados
        if (estado === 'ATN') {
          activateTab('#tratamientos');
          document.getElementById('descripcion')?.focus();
        }
        if (estado === 'COM') {
          activateTab('#pagos');
        }
        if (estado === 'CAN') {
          // Deshabilitar acciones
          ['pro','con','atn','com','can'].forEach(s=>{ const b=document.getElementById('btn-'+s); if(b) b.disabled=true; });
        }
      } else {
        showMsg(data.error || 'Error al cambiar estado', false);
      }
    }).catch((e) => showMsg('Error de red', false));
  }
  const estadoMap = { PRO:'Programada', CON:'Confirmada', ATN:'Atendida', COM:'Completada', CAN:'Cancelada' };
  ['pro','con','atn','com','can'].forEach(suf=>{
    const btn = document.getElementById('btn-'+suf);
    if (btn){ btn.addEventListener('click', function(){ cambiarEstado(this.dataset.estado); }); }
  });
  
  // Manejar checkbox de seguimiento
  const seguimientoCheck = document.getElementById('requiere_seguimiento');
  const fechaSeguimientoContainer = document.getElementById('fecha-seguimiento-container');
  
  if (seguimientoCheck && fechaSeguimientoContainer) {
    seguimientoCheck.addEventListener('change', function() {
      fechaSeguimientoContainer.style.display = this.checked ? 'block' : 'none';
      if (this.checked) {
        // Sugerir fecha de seguimiento en 7 días
        const fechaSugerida = new Date();
        fechaSugerida.setDate(fechaSugerida.getDate() + 7);
        document.getElementById('fecha_seguimiento').value = fechaSugerida.toISOString().split('T')[0];
      }
    });
  }
  
  // Manejar formulario de tratamiento
  const formTratamiento = document.getElementById('form-tratamiento');
  if (formTratamiento) {
    formTratamiento.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Deshabilitar botón para evitar doble envío
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-clock"></i> Guardando...';
      
      const formData = new FormData(this);
      const csrftoken = getCSRF();
      
      fetch('{% tenant_url "core:cita_manage" cita.id %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest',
          'Accept':'application/json'
        },
        body: formData
      })
      .then(async r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(data => {
        if (data.success) {
          showMsg(data.message, true);
          // Limpiar formulario
          this.reset();
          fechaSeguimientoContainer && (fechaSeguimientoContainer.style.display = 'none');
          // Recargar la página después de un momento para mostrar el nuevo tratamiento
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          showMsg(data.error || 'Error al registrar tratamiento', false);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMsg('Error de conexión', false);
      })
      .finally(() => {
        // Rehabilitar botón
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      });
    });
  }
  
  // Manejar formulario de historial clínico
  const formHistorial = document.getElementById('form-historial');
  if (formHistorial) {
    formHistorial.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Deshabilitar botón para evitar doble envío
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-clock"></i> Guardando...';
      
      const formData = new FormData(this);
      const csrftoken = getCSRF();
      
      fetch('{% tenant_url "core:cita_manage" cita.id %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest',
          'Accept':'application/json'
        },
        body: formData
      })
      .then(async r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(data => {
        if (data.success) {
          showMsg(data.message, true);
          // Limpiar formulario
          this.reset();
          // Recargar la página después de un momento para mostrar la nueva entrada
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          showMsg(data.error || 'Error al agregar entrada al historial', false);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMsg('Error de conexión', false);
      })
      .finally(() => {
        // Rehabilitar botón
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      });
    });
  }
  
  // Manejar mostrar/ocultar fecha de seguimiento
  const checkboxSeguimiento = document.getElementById('requiere_seguimiento');
  const contenedorFecha = document.getElementById('fecha-seguimiento-container');
  
  if (checkboxSeguimiento && contenedorFecha) {
    checkboxSeguimiento.addEventListener('change', function() {
      if (this.checked) {
        contenedorFecha.style.display = 'block';
        // Sugerir una fecha 7 días después
        const fechaActual = new Date();
        fechaActual.setDate(fechaActual.getDate() + 7);
        const fechaSugerida = fechaActual.toISOString().split('T')[0];
        document.getElementById('fecha_seguimiento').value = fechaSugerida;
      } else {
        contenedorFecha.style.display = 'none';
        document.getElementById('fecha_seguimiento').value = '';
      }
    });
  }

  // ==========================================
  // Funcionalidad de administración de servicios con dual-list
  // ==========================================
  const listaDisponibles = document.getElementById('lista-disponibles');
  const listaSeleccionados = document.getElementById('lista-seleccionados');
  const buscarServicioInput = document.getElementById('buscar-servicio');
  const costoActualEl = document.getElementById('costo-actual');
  const diferenciaEl = document.getElementById('diferencia-costo');
  const nuevoTotalEl = document.getElementById('nuevo-total');
  const btnConfirmarAgregar = document.getElementById('btn-confirmar-agregar-servicio');

  // Contadores
  function actualizarContadores() {
    const countDisponibles = listaDisponibles.querySelectorAll('.servicio-item:not([style*="display: none"])').length;
    const countSeleccionados = listaSeleccionados.querySelectorAll('.servicio-item-seleccionado').length;

    document.getElementById('count-disponibles').textContent = countDisponibles;
    document.getElementById('count-seleccionados').textContent = countSeleccionados;
  }

  // Calcular costos
  function calcularCostos() {
    const costoActual = parseFloat(costoActualEl.textContent) || 0;
    let costoSeleccionados = 0;

    listaSeleccionados.querySelectorAll('.servicio-item-seleccionado').forEach(item => {
      const precio = parseFloat(item.dataset.servicioPrecio) || 0;
      costoSeleccionados += precio;
    });

    const diferencia = costoSeleccionados - costoActual;
    const nuevoTotal = costoSeleccionados;

    // Actualizar UI
    diferenciaEl.textContent = (diferencia >= 0 ? '+' : '') + '$' + Math.abs(diferencia).toFixed(2);
    diferenciaEl.className = 'fs-5 ' + (diferencia >= 0 ? 'text-success' : 'text-danger');
    nuevoTotalEl.textContent = nuevoTotal.toFixed(2);
  }

  // Mover servicio de disponibles a seleccionados
  function agregarServicio(servicioId) {
    const item = listaDisponibles.querySelector(`[data-servicio-id="${servicioId}"]`);
    if (!item) return;

    const nombre = item.dataset.servicioNombre;
    const precio = item.dataset.servicioPrecio;

    // Crear nuevo item en seleccionados
    const nuevoItem = document.createElement('div');
    nuevoItem.className = 'list-group-item list-group-item-action list-group-item-success servicio-item-seleccionado';
    nuevoItem.dataset.servicioId = servicioId;
    nuevoItem.dataset.servicioNombre = nombre;
    nuevoItem.dataset.servicioPrecio = precio;
    nuevoItem.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-sm btn-danger btn-quitar"
                data-servicio-id="${servicioId}"
                title="Quitar de la cita">
          <i class="bi bi-arrow-left"></i>
        </button>
        <div class="flex-grow-1 ms-2">
          <strong>${nombre}</strong>
          <br>
          <small class="text-dark">
            <i class="bi bi-currency-dollar"></i> $${parseFloat(precio).toFixed(2)}
          </small>
        </div>
      </div>
    `;

    // Agregar a lista seleccionados
    listaSeleccionados.appendChild(nuevoItem);

    // Remover de disponibles
    item.remove();

    // Actualizar contadores y costos
    actualizarContadores();
    calcularCostos();
  }

  // Mover servicio de seleccionados a disponibles
  function quitarServicio(servicioId) {
    const item = listaSeleccionados.querySelector(`[data-servicio-id="${servicioId}"]`);
    if (!item) return;

    const nombre = item.dataset.servicioNombre;
    const precio = item.dataset.servicioPrecio;

    // Crear nuevo item en disponibles
    const nuevoItem = document.createElement('div');
    nuevoItem.className = 'list-group-item list-group-item-action servicio-item';
    nuevoItem.dataset.servicioId = servicioId;
    nuevoItem.dataset.servicioNombre = nombre;
    nuevoItem.dataset.servicioPrecio = precio;
    nuevoItem.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div class="flex-grow-1">
          <strong>${nombre}</strong>
          <br>
          <small class="text-muted">
            <i class="bi bi-currency-dollar"></i> $${parseFloat(precio).toFixed(2)}
          </small>
        </div>
        <button type="button" class="btn btn-sm btn-success btn-agregar"
                data-servicio-id="${servicioId}"
                title="Agregar a la cita">
          <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    `;

    // Agregar a lista disponibles
    listaDisponibles.appendChild(nuevoItem);

    // Remover de seleccionados
    item.remove();

    // Actualizar contadores y costos
    actualizarContadores();
    calcularCostos();
  }

  // Event listeners usando delegación de eventos
  listaDisponibles.addEventListener('click', function(e) {
    const btnAgregar = e.target.closest('.btn-agregar');
    if (btnAgregar) {
      e.preventDefault();
      agregarServicio(btnAgregar.dataset.servicioId);
    }
  });

  listaSeleccionados.addEventListener('click', function(e) {
    const btnQuitar = e.target.closest('.btn-quitar');
    if (btnQuitar) {
      e.preventDefault();
      quitarServicio(btnQuitar.dataset.servicioId);
    }
  });

  // Doble click para mover items
  listaDisponibles.addEventListener('dblclick', function(e) {
    const item = e.target.closest('.servicio-item');
    if (item) {
      agregarServicio(item.dataset.servicioId);
    }
  });

  listaSeleccionados.addEventListener('dblclick', function(e) {
    const item = e.target.closest('.servicio-item-seleccionado');
    if (item) {
      quitarServicio(item.dataset.servicioId);
    }
  });

  // Botones agregar/quitar todos
  document.getElementById('btn-agregar-todos')?.addEventListener('click', function() {
    const itemsDisponibles = listaDisponibles.querySelectorAll('.servicio-item:not([style*="display: none"])');
    itemsDisponibles.forEach(item => {
      agregarServicio(item.dataset.servicioId);
    });
  });

  document.getElementById('btn-quitar-todos')?.addEventListener('click', function() {
    const itemsSeleccionados = listaSeleccionados.querySelectorAll('.servicio-item-seleccionado');
    itemsSeleccionados.forEach(item => {
      quitarServicio(item.dataset.servicioId);
    });
  });

  // Búsqueda en tiempo real
  buscarServicioInput?.addEventListener('input', function() {
    const termino = this.value.toLowerCase();

    listaDisponibles.querySelectorAll('.servicio-item').forEach(item => {
      const nombre = item.dataset.servicioNombre.toLowerCase();
      if (nombre.includes(termino)) {
        item.style.display = '';
      } else {
        item.style.display = 'none';
      }
    });

    actualizarContadores();
  });

  // Confirmar cambios
  btnConfirmarAgregar?.addEventListener('click', function() {
    const serviciosIds = Array.from(listaSeleccionados.querySelectorAll('.servicio-item-seleccionado'))
      .map(item => item.dataset.servicioId);

    // Deshabilitar botón
    this.disabled = true;
    this.innerHTML = '<i class="bi bi-clock"></i> Guardando...';

    // Enviar petición
    const formData = new FormData();
    formData.append('action', 'agregar_servicios');
    serviciosIds.forEach(id => formData.append('servicios', id));

    fetch('{% tenant_url "core:cita_manage" cita.id %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRF(),
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
      },
      body: formData
    })
    .then(async r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(data => {
      if (data.success) {
        showMsg(data.message || 'Servicios actualizados correctamente', true);

        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAgregarServicio'));
        modal.hide();

        // Recargar página para mostrar cambios
        setTimeout(() => window.location.reload(), 1000);
      } else {
        showMsg(data.error || 'Error al actualizar servicios', false);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showMsg('Error de conexión', false);
    })
    .finally(() => {
      // Rehabilitar botón
      this.disabled = false;
      this.innerHTML = '<i class="bi bi-check-circle"></i> Guardar Cambios';
    });
  });

  // Inicializar contadores y costos al abrir el modal
  document.getElementById('modalAgregarServicio')?.addEventListener('shown.bs.modal', function() {
    actualizarContadores();
    calcularCostos();
  });

})();
</script>
{% endblock %}
