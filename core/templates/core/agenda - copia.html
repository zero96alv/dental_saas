{% extends 'core/base.html' %}
{% load tenant_urls %}
{% load static %}

{% block title %}Agenda de Citas{% endblock %}

{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
{% endblock %}


{% block content %}
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="dentistaFilter" class="form-label">Filtrar por Dentista:</label>
            <select id="dentistaFilter" class="form-select">
                <option value="">Todos los Dentistas</option>
                {% for dentista in dentistas %}
                    <option value="{{ dentista.pk }}" {% if request.GET.dentista_id == dentista.pk|stringformat:"s" %}selected{% endif %}>{{ dentista }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div id='calendar'></div>

    <!-- Modal para Añadir/Editar Cita -->
    <div class="modal fade" id="citaModal" tabindex="-1" aria-labelledby="citaModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form id="citaForm" method="POST">
              <div class="modal-header">
                <h5 class="modal-title" id="citaModalLabel">Nueva Cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                    {% csrf_token %}
                    <div id="form-errors" class="alert alert-danger" style="display: none;"></div>
                    {{ cita_form.as_p }}
              </div>
              <div class="modal-footer">
                <a href="#" class="btn btn-info me-auto" id="finalizeCitaButton" style="display: none;">Finalizar Consulta</a>
                <button type="button" class="btn btn-danger" id="deleteCitaButton" style="display: none;">Eliminar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="submit" class="btn btn-primary" id="saveCitaButton">Guardar</button>
              </div>
          </form>
          <form id="deleteCitaForm" method="POST" style="display: none;">
              {% csrf_token %}
          </form>
        </div>
      </div>
    </div>


    <!-- Modal para Finalizar Cita -->
    <div class="modal fade" id="finalizarCitaModal" tabindex="-1" aria-labelledby="finalizarCitaModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="finalizarCitaModalLabel">Finalizar Consulta</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div id="finalizarCitaModalBody">
            <!-- Contenido del formulario se cargará aquí -->
          </div>
        </div>
      </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const citaModal = new bootstrap.Modal(document.getElementById('citaModal'));
        const finalizarCitaModal = new bootstrap.Modal(document.getElementById('finalizarCitaModal'));
        const finalizarCitaModalBody = document.getElementById('finalizarCitaModalBody');
        const citaForm = document.getElementById('citaForm');
        const deleteCitaForm = document.getElementById('deleteCitaForm');
        const citaModalLabel = document.getElementById('citaModalLabel');
        
        const deleteCitaButton = document.getElementById('deleteCitaButton');
        const finalizeCitaButton = document.getElementById('finalizeCitaButton');
        
        const dentistaFilter = document.getElementById('dentistaFilter');
        const dentistaField = document.getElementById('id_dentista');
        const serviciosField = document.getElementById('id_servicios_planeados');

        // Inicializar Select2
        $('#id_cliente').select2({ theme: 'bootstrap-5', dropdownParent: $('#citaModal') });
        $('#id_dentista').select2({ theme: 'bootstrap-5', dropdownParent: $('#citaModal') });
        $('#id_servicios_planeados').select2({ theme: 'bootstrap-5', dropdownParent: $('#citaModal') });

        let eventsUrl = "{% tenant_url 'core:agenda_events' %}";

        const calendar = new FullCalendar.Calendar(calendarEl, {
          locale: 'es',
          initialView: 'timeGridWeek',
          slotMinTime: '08:00:00',
          slotMaxTime: '20:00:00',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          buttonText: { today: 'Hoy', month: 'Mes', week: 'Semana', day: 'Día' },
          timeZone: 'America/Mexico_City',
          events: eventsUrl,
          selectable: true,
          
          select: function(info) {
            citaForm.reset();
            citaForm.action = "{% tenant_url 'core:cita_create' %}"; // URL para crear
            $('#id_cliente').val(null).trigger('change');
            $('#id_dentista').val(null).trigger('change');
            $('#id_servicios_planeados').empty().trigger('change');

            citaModalLabel.innerText = 'Nueva Cita';
            deleteCitaButton.style.display = 'none';
            finalizeCitaButton.style.display = 'none';

            const startDate = new Date(info.startStr);
            const formattedDate = startDate.getFullYear() + '-' + 
                                  ('0' + (startDate.getMonth() + 1)).slice(-2) + '-' + 
                                  ('0' + startDate.getDate()).slice(-2) + 'T' + 
                                  ('0' + startDate.getHours()).slice(-2) + ':' + 
                                  ('0' + startDate.getMinutes()).slice(-2);
            document.getElementById('id_fecha_hora').value = formattedDate;
            citaModal.show();
          },

          eventClick: function(info) {
            const citaId = info.event.id;
            const detailUrl = `/dashboard/api/citas/${citaId}/`;
            
            fetch(detailUrl)
              .then(response => response.json())
              .then(data => {
                if (data.error) {
                  alert(data.error);
                  return;
                }
                
                citaForm.reset();
                citaForm.action = `/dashboard/citas/${citaId}/update/`; // URL para actualizar
                
                $('#id_cliente').val(data.cliente).trigger('change');
                $('#id_dentista').val(data.dentista).trigger('change');
                document.getElementById('id_fecha_hora').value = data.fecha_hora;
                document.getElementById('id_motivo').value = data.motivo;

                updateServiciosField(data.dentista, data.servicios_planeados);

                citaModalLabel.innerText = 'Editar Cita';
                deleteCitaButton.style.display = 'block';
                deleteCitaForm.action = `/dashboard/citas/${citaId}/delete/`;
                
                finalizeCitaButton.dataset.url = `/dashboard/citas/${citaId}/finalizar/content/`;
                finalizeCitaButton.style.display = 'block';
                
                citaModal.show();
              });
          }
        });
        calendar.render();

        dentistaField.addEventListener('change', function() {
            const dentistaId = this.value;
            updateServiciosField(dentistaId);
            updateHorarioDentista(dentistaId);
        });

        dentistaFilter.addEventListener('change', function() {
            const dentistaId = this.value;
            updateHorarioDentista(dentistaId);
            if (dentistaId) {
                calendar.setOption('events', `${eventsUrl}?dentista_id=${dentistaId}`);
            } else {
                calendar.setOption('events', eventsUrl);
            }
        });

        function updateHorarioDentista(dentistaId) {
            if (!dentistaId) {
                calendar.setOption('businessHours', {
                    daysOfWeek: [ 1, 2, 3, 4, 5 ], // Lunes a Viernes por defecto
                    startTime: '08:00',
                    endTime: '20:00',
                });
                return;
            }

            const url = `/dashboard/api/dentista/${dentistaId}/horario/`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        // Mantener un horario por defecto si falla
                        calendar.setOption('businessHours', true); 
                    } else {
                        calendar.setOption('businessHours', data);
                    }
                });
        }

        function updateServiciosField(dentistaId, selectedServices = []) {
            if (!dentistaId) {
                $(serviciosField).empty().trigger('change');
                return;
            }

            const url = `/dashboard/api/dentista/${dentistaId}/servicios/`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    $(serviciosField).empty();
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }
                    data.forEach(servicio => {
                        const isSelected = selectedServices.includes(servicio.id);
                        const option = new Option(servicio.nombre, servicio.id, isSelected, isSelected);
                        serviciosField.appendChild(option);
                    });
                    $(serviciosField).trigger('change');
                });
        }

        deleteCitaButton.addEventListener('click', function() {
            if (confirm('¿Estás seguro de que quieres eliminar esta cita?')) {
                deleteCitaForm.submit();
            }
        });

        finalizeCitaButton.addEventListener('click', function(e) {
            e.preventDefault();
            const url = this.dataset.url;
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    finalizarCitaModalBody.innerHTML = html;
                    citaModal.hide();
                    finalizarCitaModal.show();
                });
        });

        dentistaFilter.addEventListener('change', function() {
            const dentistaId = this.value;
            if (dentistaId) {
                calendar.setOption('events', `${eventsUrl}?dentista_id=${dentistaId}`);
            } else {
                calendar.setOption('events', eventsUrl);
            }
        });
      });
    </script>
{% endblock %}