{% extends 'core/base.html' %}
{% load tenant_urls %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Agenda de Citas{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<!-- Toastify CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<style>
/* Estilos personalizados para FullCalendar */
.fc {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.fc-toolbar {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 1rem;
    border-radius: 0.5rem 0.5rem 0 0;
    margin-bottom: 0 !important;
}

.fc-toolbar-title {
    color: white !important;
    font-weight: 600;
    font-size: 1.5rem;
}

.fc-button {
    background-color: rgba(255, 255, 255, 0.2) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    color: white !important;
    border-radius: 0.375rem !important;
    padding: 0.5rem 0.75rem !important;
    font-weight: 500 !important;
}

.fc-button:hover {
    background-color: rgba(255, 255, 255, 0.3) !important;
    border-color: rgba(255, 255, 255, 0.5) !important;
}

.fc-button:disabled {
    opacity: 0.5 !important;
    background-color: rgba(255, 255, 255, 0.1) !important;
}

.fc-button-active {
    background-color: rgba(255, 255, 255, 0.4) !important;
    border-color: rgba(255, 255, 255, 0.6) !important;
}

/* Calendario principal */
.fc-view-harness {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0 0 0.5rem 0.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.fc-daygrid-day {
    border: 1px solid #e9ecef !important;
    transition: background-color 0.2s ease;
}

.fc-daygrid-day:hover {
    background-color: rgba(0, 123, 255, 0.05) !important;
}

.fc-day-today {
    background-color: rgba(0, 123, 255, 0.1) !important;
}

.fc-col-header-cell {
    background: #f8f9fa !important;
    border-bottom: 2px solid #dee2e6 !important;
    font-weight: 600;
    color: #495057;
    padding: 0.75rem 0.5rem;
}

.fc-daygrid-day-number {
    color: #495057;
    font-weight: 500;
    padding: 0.5rem;
}

/* Eventos personalizados */
.fc-event {
    border: none !important;
    border-radius: 0.375rem !important;
    padding: 0.25rem 0.5rem !important;
    font-size: 0.85rem !important;
    font-weight: 500 !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    cursor: pointer !important;
}

.fc-event:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
}

/* Estados de citas */
.cita-programada {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
}

.cita-confirmada {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
}

.cita-atendida {
    background-color: #fd7e14 !important;
    border-color: #fd7e14 !important;
}

.cita-completada {
    background-color: #198754 !important;
    border-color: #198754 !important;
}

.cita-cancelada {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    text-decoration: line-through;
    opacity: 0.7;
}

/* Header mejorado */
.agenda-header {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 0.5rem;
}

.agenda-stats {
    background: white;
    border-radius: 0.5rem;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
}

.stat-item {
    text-align: center;
    padding: 0.5rem;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
}

.stat-label {
    font-size: 0.9rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

/* Filtros mejorados */
.filtros-container {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
    border: 1px solid #e9ecef;
}

/* Vista responsiva */
@media (max-width: 768px) {
    .fc-toolbar {
        flex-direction: column;
        gap: 1rem;
    }
    
    .fc-toolbar-chunk {
        display: flex;
        justify-content: center;
    }
    
    .agenda-header {
        padding: 1rem 0;
    }
    
    .agenda-stats {
        padding: 1rem;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
}

/* Loading y estados */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    border-radius: 0.5rem;
}

.loading-spinner {
    width: 3rem;
    height: 3rem;
    border: 0.25rem solid #f3f3f3;
    border-top: 0.25rem solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.calendar-container {
    position: relative;
    background: white;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* Selector de pacientes inteligente */
.search-results-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1060;
    margin-top: 0.25rem;
    max-height: 400px;
    overflow-y: auto;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.search-results-container {
    padding: 0.5rem 0;
}

.patient-search-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.15s ease;
}

.patient-search-item:last-child {
    border-bottom: none;
}

.patient-search-item:hover {
    background-color: #f8f9fa;
}

.patient-search-item.active {
    background-color: #e7f3ff;
}

.patient-search-name {
    font-weight: 600;
    color: #212529;
    margin-bottom: 0.25rem;
}

.patient-search-info {
    font-size: 0.875rem;
    color: #6c757d;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
}

.patient-search-badges {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
    margin-top: 0.25rem;
}

.selected-patient-card {
    background: linear-gradient(135deg, #e7f3ff, #f0f8ff);
    border: 2px solid #0d6efd;
    border-radius: 0.5rem;
    padding: 1rem;
}

.search-empty-state {
    padding: 2rem 1rem;
    text-align: center;
    color: #6c757d;
}

.search-empty-state i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
}

.search-loading {
    padding: 1rem;
    text-align: center;
}

.search-loading .spinner-border {
    width: 1.5rem;
    height: 1.5rem;
}

/* Responsive */
@media (max-width: 768px) {
    .search-results-dropdown {
        max-height: 300px;
    }

    .patient-search-info {
        font-size: 0.8rem;
        gap: 0.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header mejorado -->
    <div class="agenda-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-6 mb-2">
                        <i class="fas fa-calendar-alt me-3"></i>
                        Agenda de Citas
                    </h1>
                    <p class="lead mb-0">Gesti√≥n integral de citas m√©dicas</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-lg" onclick="openNewAppointmentModal()">
                        <i class="fas fa-plus me-2"></i>Nueva Cita
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Estad√≠sticas r√°pidas -->
    <div class="agenda-stats">
        <div class="row" id="agenda-stats-content">
            <div class="col-md-2 col-6">
                <div class="stat-item">
                    <div class="stat-number text-primary" id="stat-hoy">-</div>
                    <div class="stat-label">Hoy</div>
                </div>
            </div>
            <div class="col-md-2 col-6">
                <div class="stat-item">
                    <div class="stat-number text-info" id="stat-semana">-</div>
                    <div class="stat-label">Esta Semana</div>
                </div>
            </div>
            <div class="col-md-2 col-6">
                <div class="stat-item">
                    <div class="stat-number text-warning" id="stat-pendientes">-</div>
                    <div class="stat-label">Pendientes</div>
                </div>
            </div>
            <div class="col-md-2 col-6">
                <div class="stat-item">
                    <div class="stat-number text-success" id="stat-completadas">-</div>
                    <div class="stat-label">Completadas</div>
                </div>
            </div>
            <div class="col-md-2 col-6">
                <div class="stat-item">
                    <div class="stat-number text-danger" id="stat-canceladas">-</div>
                    <div class="stat-label">Canceladas</div>
                </div>
            </div>
            <div class="col-md-2 col-6">
                <div class="stat-item">
                    <div class="stat-number text-secondary" id="stat-total">-</div>
                    <div class="stat-label">Total Mes</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtros mejorados -->
    <div class="filtros-container">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="dentistaFilter" class="form-label fw-semibold">
                    <i class="fas fa-user-md me-1"></i>Filtrar por Dentista
                </label>
                <select id="dentistaFilter" class="form-select">
                    <option value="">üë®‚Äç‚öïÔ∏è Todos los Dentistas</option>
                    {% for dentista in dentistas %}
                        <option value="{{ dentista.pk }}">
                            Dr. {{ dentista.usuario.first_name }} {{ dentista.usuario.last_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="estadoFilter" class="form-label fw-semibold">
                    <i class="fas fa-filter me-1"></i>Estado de Citas
                </label>
                <select id="estadoFilter" class="form-select">
                    <option value="">üîç Todas las Citas</option>
                    <option value="PRO">‚è≥ Programadas</option>
                    <option value="CON">‚úÖ Confirmadas</option>
                    <option value="ATN">üîÑ Atendidas</option>
                    <option value="COM">‚úîÔ∏è Completadas</option>
                    <option value="CAN">‚ùå Canceladas</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="fechaFilter" class="form-label fw-semibold">
                    <i class="fas fa-calendar me-1"></i>Ir a Fecha
                </label>
                <input type="date" id="fechaFilter" class="form-control" />
            </div>
            <div class="col-md-2">
                <div class="d-grid">
                    <button class="btn btn-outline-primary" onclick="limpiarFiltros()">
                        <i class="fas fa-refresh me-1"></i>Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contenedor del calendario -->
    <div class="calendar-container">
        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <div class="text-center">
                <div class="loading-spinner mb-3"></div>
                <div class="fw-semibold">Cargando agenda...</div>
            </div>
        </div>
        <div id="calendar"></div>
    </div>

        <!-- Debug info -->
        <div id="debug-info" class="alert alert-info mb-3" style="display: none;">
            <strong>Debug:</strong> <span id="debug-text">Cargando...</span>
        </div>
        
        <div id="calendar"></div>

        <!-- Modal para A√±adir/Editar Cita -->
        <div class="modal fade" id="citaModal" tabindex="-1" aria-labelledby="citaModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form id="citaForm" method="POST">
                        {% csrf_token %}
                        <div class="modal-header">
                            <div>
                                <h5 class="modal-title" id="citaModalLabel">Nueva Cita</h5>
                                <div class="text-primary fw-semibold" id="citaModalDate" style="font-size: 1.1em;"></div>
                            </div>
                            <div id="status-indicator" class="ms-auto" style="display: none;">
                                <div class="dropdown">
                                    <button class="btn btn-sm dropdown-toggle" type="button" id="statusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span class="badge rounded-pill" id="status-badge"></span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="statusDropdown">
                                        <li><a class="dropdown-item change-status-btn" href="#" data-estado="PRO">Programada</a></li>
                                        <li><a class="dropdown-item change-status-btn" href="#" data-estado="CON">Confirmada</a></li>
                                        <li><a class="dropdown-item change-status-btn" href="#" data-estado="ATN">Atendida</a></li>
                                        <li><a class="dropdown-item change-status-btn" href="#" data-estado="COM">Completada</a></li>
                                        <li><a class="dropdown-item change-status-btn" href="#" data-estado="CAN">Cancelada</a></li>
                                    </ul>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="form-errors" class="alert alert-danger" style="display: none;"></div>
                            
                            <!-- Campo de fecha cuando no se selecciona desde calendario -->
                            <div class="mb-3" id="fecha-picker-container" style="display: none;">
                                <label for="id_fecha_cita" class="form-label requiredField">
                                    <i class="fas fa-calendar"></i> Fecha de la Cita
                                </label>
                                <input type="date" id="id_fecha_cita" name="fecha_cita" class="form-control">
                                <small class="text-muted">Seleccione una fecha o haga clic en el calendario</small>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <!-- Nuevo Selector de Pacientes Inteligente -->
                                    <div class="mb-3">
                                        <label for="searchPaciente" class="form-label requiredField">
                                            <i class="fas fa-user-injured"></i> Buscar Paciente
                                        </label>
                                        <div class="position-relative">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                                <input type="text"
                                                       id="searchPaciente"
                                                       class="form-control"
                                                       placeholder="Escribe nombre, email o tel√©fono..."
                                                       autocomplete="off">
                                                <button class="btn btn-outline-primary" type="button" id="addPacienteBtn" title="Nuevo Paciente">
                                                    <i class="fas fa-plus"></i> Nuevo
                                                </button>
                                            </div>

                                            <!-- Dropdown de resultados -->
                                            <div id="pacienteSearchResults" class="search-results-dropdown" style="display: none;">
                                                <div class="search-results-container">
                                                    <div id="searchResultsContent">
                                                        <!-- Los resultados se cargar√°n aqu√≠ din√°micamente -->
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Paciente seleccionado -->
                                            <div id="pacienteSelected" class="selected-patient-card mt-2" style="display: none;">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1">
                                                            <i class="fas fa-user-check text-success"></i>
                                                            <span id="selectedPacienteNombre"></span>
                                                        </h6>
                                                        <small class="text-muted">
                                                            <i class="fas fa-envelope"></i> <span id="selectedPacienteEmail"></span> ‚Ä¢
                                                            <i class="fas fa-phone"></i> <span id="selectedPacienteTelefono"></span>
                                                        </small>
                                                        <div class="mt-1">
                                                            <span id="selectedPacienteBadges"></span>
                                                        </div>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" id="clearPacienteBtn">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Hidden input con el ID del paciente seleccionado -->
                                            <input type="hidden" id="id_paciente" name="paciente" required>
                                        </div>
                                    </div>
                                    {{ cita_form.dentista|as_crispy_field }}
                                    {{ cita_form.unidad_dental|as_crispy_field }}
                                    <div class="mb-3">
                                        <label for="id_hora" class="form-label">Hora</label>
                                        <select id="id_hora" name="hora" class="form-select">
                                            <option value="">Primero seleccione un dentista</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <!-- Buscador de Servicios -->
                                    <div class="mb-2">
                                        <label class="form-label">
                                            <i class="fas fa-tooth me-1"></i> Servicios
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input type="text"
                                                   id="search-servicios"
                                                   class="form-control"
                                                   placeholder="Buscar servicio..."
                                                   autocomplete="off">
                                        </div>
                                    </div>

                                    <!-- Servicios Disponibles (Lista Clickeable) -->
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">Disponibles</small>
                                            <small class="text-muted" id="disponibles-count">0</small>
                                        </div>
                                        <div id="servicios-disponibles-list"
                                             class="border rounded bg-light"
                                             style="height: 120px; overflow-y: auto;">
                                            <!-- Se llenar√° din√°micamente con JavaScript -->
                                        </div>
                                    </div>

                                    <!-- Servicios Seleccionados -->
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-success fw-bold">
                                                <i class="fas fa-check-circle me-1"></i>Seleccionados
                                            </small>
                                            <span class="badge bg-success" id="servicios-count">0</span>
                                        </div>
                                        <div id="lista-servicios-seleccionados"
                                             class="border rounded bg-white"
                                             style="min-height: 80px; max-height: 140px; overflow-y: auto;">
                                            <div class="text-muted text-center py-3" id="empty-servicios-msg">
                                                <i class="fas fa-arrow-up mb-1"></i>
                                                <div><small>Click en servicios arriba para agregar</small></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Select oculto para env√≠o de formulario (colocado fuera del div visible) -->
                                    <div style="display: none;">
                                        {{ cita_form.servicios_planeados }}
                                    </div>

                                    {{ cita_form.motivo|as_crispy_field }}
                                    {{ cita_form.notas|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-warning me-auto" id="editarCitaBtn" style="display: none;">Editar</button>
                            <button type="button" class="btn btn-danger" id="cancelarCitaBtn" style="display: none;">Cancelar Cita</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary" id="guardarCitaBtn">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Crear Paciente -->
        <div class="modal fade" id="pacienteModal" tabindex="-1" aria-labelledby="pacienteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="pacienteFormInline" method="POST">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="pacienteModalLabel">Nuevo Paciente</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="paciente-errors" class="alert alert-danger d-none"></div>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label">Nombre</label>
                                    <input class="form-control" name="nombre" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Apellido</label>
                                    <input class="form-control" name="apellido" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email <small class="text-muted">(opcional)</small></label>
                                    <input type="email" class="form-control" name="email" placeholder="correo@ejemplo.com">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Tel√©fono <small class="text-muted">(opcional)</small></label>
                                    <input class="form-control" name="telefono" placeholder="55 1234 5678">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Fecha de nacimiento (opcional)</label>
                                    <input type="date" class="form-control" name="fecha_nacimiento">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar Paciente</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js"></script>
<!-- Toastify JS -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    console.log('Inicializando agenda optimizada...');
    mostrarLoadingInicial();
    
    // Esperar un momento para que se carguen completamente las librer√≠as
    setTimeout(function() {
        try {
            initializeModernAgenda();
        } catch(error) {
            console.error('Error inicializando agenda:', error);
            ocultarLoading();
            alert('Error cargando la agenda. Por favor, recargue la p√°gina.');
        }
    }, 500);
});

function mostrarLoadingInicial() {
    var loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
    }
}

function ocultarLoading() {
    var loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}
    
    // Funci√≥n para inicializar la agenda moderna (llamada despu√©s de cargar librer√≠as)
    function initializeModernAgenda() {
        console.log('Inicializando agenda moderna...');
        
        document.getElementById('debug-text').innerText = 'Inicializando agenda moderna...';
        
        // Verificar que todas las dependencias est√©n cargadas
        if (typeof jQuery === 'undefined') {
            console.error('jQuery no cargado');
            showBasicFallback();
            return;
        }
        
        if (typeof FullCalendar === 'undefined') {
            console.error('FullCalendar no cargado');
            showBasicFallback();
            return;
        }
        
        // Inicializar variables jQuery
        var $ = jQuery;
        var calendarEl = document.getElementById('calendar');
        var citaModal = new bootstrap.Modal(document.getElementById('citaModal'));
        var pacienteModal = new bootstrap.Modal(document.getElementById('pacienteModal'));
        var citaModalEl = document.getElementById('citaModal');
        var citaForm = document.getElementById('citaForm');
        var modalTitle = document.getElementById('citaModalLabel');
        var modalDate = document.getElementById('citaModalDate');
        var statusIndicator = $('#status-indicator');
        var statusBadge = document.getElementById('status-badge');
        
        // Selects
        var pacienteSelect = $('#id_paciente');
        var dentistaSelect = $('#id_dentista');
        var unidadDentalSelect = $('#id_unidad_dental');
        var horaSelect = $('#id_hora');
        var serviciosSelect = $('#id_servicios_planeados');
        var listaServiciosSeleccionados = $('#lista-servicios-seleccionados');
        var hiddenServiciosInput = $('#id_servicios_seleccionados_hidden');
        
        var currentCitaId = null;
        
        try {
            // Configurar selects nativos (sin Select2 para mayor compatibilidad)
            // Los selects ya funcionan nativamente

            // ========================================
            // NUEVO SELECTOR DE SERVICIOS CON B√öSQUEDA
            // ========================================
            var serviciosDisponiblesList = $('#servicios-disponibles-list');
            var listaServiciosSeleccionados = $('#lista-servicios-seleccionados');
            var searchServiciosInput = $('#search-servicios');
            var selectedServiciosIds = []; // Array para guardar IDs de servicios seleccionados
            var allServicios = []; // Cache de todos los servicios

            // Cargar todos los servicios al inicio
            function loadAllServicios() {
                allServicios = [];
                serviciosSelect.find('option').each(function() {
                    const option = $(this);
                    const servicioId = option.val();
                    const servicioNombre = option.text().trim();

                    if (servicioId) {
                        allServicios.push({
                            id: servicioId,
                            nombre: servicioNombre
                        });
                    }
                });
            }

            // Funci√≥n para renderizar servicios disponibles (NO seleccionados)
            function renderServiciosDisponibles(searchTerm = '') {
                serviciosDisponiblesList.empty();

                const searchLower = searchTerm.toLowerCase();
                let disponiblesCount = 0;

                allServicios.forEach(function(servicio) {
                    // Filtrar: solo mostrar NO seleccionados y que coincidan con b√∫squeda
                    if (selectedServiciosIds.includes(servicio.id)) {
                        return; // Ya est√° seleccionado, no mostrar
                    }

                    if (searchTerm && !servicio.nombre.toLowerCase().includes(searchLower)) {
                        return; // No coincide con b√∫squeda
                    }

                    disponiblesCount++;

                    const itemDiv = $('<div class="servicio-disponible-item"></div>');
                    itemDiv.attr('data-servicio-id', servicio.id);
                    itemDiv.css({
                        'padding': '8px 12px',
                        'border-bottom': '1px solid #e9ecef',
                        'cursor': 'pointer',
                        'display': 'block',
                        'transition': 'background-color 0.2s'
                    });
                    itemDiv.html(
                        '<i class="fas fa-plus-circle text-primary me-2"></i>' +
                        '<span style="font-size: 0.9rem;">' + servicio.nombre + '</span>'
                    );

                    itemDiv.hover(
                        function() { $(this).css('background-color', '#d1ecf1'); },
                        function() { $(this).css('background-color', 'transparent'); }
                    );

                    serviciosDisponiblesList.append(itemDiv);
                });

                // Actualizar contador de disponibles
                $('#disponibles-count').text(disponiblesCount);

                if (disponiblesCount === 0) {
                    const emptyMsg = $('<div></div>');
                    emptyMsg.css({
                        'padding': '20px',
                        'text-align': 'center',
                        'color': '#6c757d',
                        'font-size': '0.85rem'
                    });

                    if (searchTerm) {
                        emptyMsg.html('<i class="fas fa-search mb-1"></i><br>No se encontraron servicios');
                    } else if (selectedServiciosIds.length === allServicios.length) {
                        emptyMsg.css('color', '#28a745');
                        emptyMsg.html('<i class="fas fa-check-circle mb-1"></i><br>Todos seleccionados');
                    } else {
                        emptyMsg.html('No hay servicios disponibles');
                    }

                    serviciosDisponiblesList.append(emptyMsg);
                }
            }

            // B√∫squeda de servicios
            searchServiciosInput.on('input', function() {
                const searchTerm = $(this).val();
                renderServiciosDisponibles(searchTerm);
            });

            // Click en servicio disponible para agregarlo
            serviciosDisponiblesList.on('click', '.servicio-disponible-item', function() {
                const servicioId = String($(this).data('servicio-id')); // Convertir a string
                addServicio(servicioId);
            });

            // Funci√≥n para agregar un servicio
            function addServicio(servicioId) {
                servicioId = String(servicioId); // Asegurar que es string
                if (!selectedServiciosIds.includes(servicioId)) {
                    selectedServiciosIds.push(servicioId);
                    updateServiciosList();
                    renderServiciosDisponibles(searchServiciosInput.val());
                }
            }

            // Funci√≥n para remover un servicio
            function removeServicio(servicioId) {
                servicioId = String(servicioId); // Asegurar que es string
                const index = selectedServiciosIds.indexOf(servicioId);
                if (index > -1) {
                    selectedServiciosIds.splice(index, 1);
                    updateServiciosList();
                    renderServiciosDisponibles(searchServiciosInput.val());
                }
            }

            // L√≥gica de servicios con select multiple mejorado
            function updateServiciosList() {
                // Actualizar contador
                $('#servicios-count').text(selectedServiciosIds.length);

                // Actualizar el select oculto para env√≠o del formulario
                serviciosSelect.val(selectedServiciosIds);

                // Limpiar lista
                listaServiciosSeleccionados.empty();

                if (selectedServiciosIds.length === 0) {
                    // Mostrar mensaje de placeholder
                    const emptyMsg = $('<div id="empty-servicios-msg"></div>');
                    emptyMsg.css({
                        'padding': '20px',
                        'text-align': 'center',
                        'color': '#6c757d',
                        'font-size': '0.85rem'
                    });
                    emptyMsg.html(
                        '<i class="fas fa-arrow-up mb-2" style="font-size: 1.5rem; display: block;"></i>' +
                        'Click en servicios arriba para agregar'
                    );
                    listaServiciosSeleccionados.append(emptyMsg);
                } else {
                    // Renderizar servicios seleccionados
                    selectedServiciosIds.forEach(function(servicioId) {
                        const servicio = allServicios.find(s => s.id === servicioId);

                        if (!servicio) {
                            console.warn('Servicio no encontrado:', servicioId);
                            return;
                        }

                        // Crear item con bot√≥n para remover
                        const itemDiv = $('<div class="servicio-seleccionado-item"></div>');
                        itemDiv.css({
                            'padding': '8px 12px',
                            'border-bottom': '1px solid #e9ecef',
                            'display': 'flex',
                            'justify-content': 'space-between',
                            'align-items': 'center',
                            'background-color': '#ffffff'
                        });
                        itemDiv.html(
                            '<span style="font-size: 0.9rem;">' +
                            '<i class="fas fa-check-circle text-success me-2"></i>' +
                            servicio.nombre +
                            '</span>' +
                            '<button type="button" class="btn btn-sm btn-danger remove-servicio-btn" data-servicio-id="' + servicioId + '" title="Quitar servicio">' +
                            '<i class="fas fa-times"></i>' +
                            '</button>'
                        );
                        itemDiv.attr('data-service-id', servicioId);
                        listaServiciosSeleccionados.append(itemDiv);
                    });
                }
            }

            // Remover servicio al hacer clic en la X
            listaServiciosSeleccionados.on('click', '.remove-servicio-btn', function(e) {
                e.preventDefault();
                const servicioId = $(this).data('servicio-id');
                removeServicio(servicioId);
            });

            // NO inicializar aqu√≠ - se har√° al abrir el modal
            // loadAllServicios();
            // renderServiciosDisponibles();

            // ========================================
            // NUEVO SELECTOR INTELIGENTE DE PACIENTES
            // ========================================
            var searchPacienteInput = $('#searchPaciente');
            var searchResultsDiv = $('#pacienteSearchResults');
            var searchResultsContent = $('#searchResultsContent');
            var pacienteSelectedDiv = $('#pacienteSelected');
            var hiddenPacienteInput = $('#id_paciente');
            var clearPacienteBtn = $('#clearPacienteBtn');
            var searchTimeout;
            var selectedPaciente = null;

            // Funci√≥n para buscar pacientes
            function searchPacientes(query) {
                console.log('Buscando pacientes:', query);

                if (!query || query.length < 2) {
                    searchResultsDiv.hide();
                    if (query.length === 0) {
                        searchResultsContent.html(
                            '<div class="search-empty-state">' +
                            '<i class="fas fa-search"></i>' +
                            '<p class="mb-0">Escribe al menos 2 caracteres para buscar</p>' +
                            '</div>'
                        );
                        searchResultsDiv.show();
                    }
                    return;
                }

                // Mostrar loading
                searchResultsContent.html(
                    '<div class="search-loading">' +
                    '<div class="spinner-border text-primary" role="status">' +
                    '<span class="visually-hidden">Buscando...</span>' +
                    '</div>' +
                    '<p class="mt-2 mb-0 text-muted">Buscando pacientes...</p>' +
                    '</div>'
                );
                searchResultsDiv.show();

                // Hacer petici√≥n AJAX
                const tenantPrefix = '{{ request.tenant_prefix|default:"" }}';
                const apiUrl = tenantPrefix ? `${tenantPrefix}/api/pacientes/` : '/api/pacientes/';

                $.ajax({
                    url: apiUrl,
                    data: { q: query, limit: 20 },
                    success: function(response) {
                        console.log('Resultados:', response);

                        if (!response.success || response.pacientes.length === 0) {
                            searchResultsContent.html(
                                '<div class="search-empty-state">' +
                                '<i class="fas fa-user-slash"></i>' +
                                '<p class="mb-0">No se encontraron pacientes</p>' +
                                '<small class="text-muted">Intenta con otro t√©rmino o crea un nuevo paciente</small>' +
                                '</div>'
                            );
                            return;
                        }

                        // Renderizar resultados
                        var html = '';
                        response.pacientes.forEach(function(paciente) {
                            var badges = '';

                            // Badge de saldo
                            if (paciente.saldo_global > 0) {
                                badges += `<span class="badge bg-danger">üí∞ $${paciente.saldo_global.toFixed(2)}</span>`;
                            }

                            // Badge de historial
                            if (paciente.tiene_historial) {
                                badges += '<span class="badge bg-success">‚úÖ Historial</span>';
                            } else {
                                badges += '<span class="badge bg-warning text-dark">‚è≥ Sin Historial</span>';
                            }

                            // Badge de portal
                            if (paciente.tiene_acceso_portal) {
                                badges += '<span class="badge bg-info">üîê Portal</span>';
                            }

                            var edadText = paciente.edad ? `${paciente.edad} a√±os` : 'Edad no registrada';

                            html += `
                                <div class="patient-search-item" data-paciente-id="${paciente.id}" data-paciente='${JSON.stringify(paciente)}'>
                                    <div class="patient-search-name">
                                        <i class="fas fa-user-circle text-primary"></i> ${paciente.nombre_completo}
                                    </div>
                                    <div class="patient-search-info">
                                        <span><i class="fas fa-envelope"></i> ${paciente.email}</span>
                                        ${paciente.telefono ? `<span><i class="fas fa-phone"></i> ${paciente.telefono}</span>` : ''}
                                        <span><i class="fas fa-birthday-cake"></i> ${edadText}</span>
                                    </div>
                                    <div class="patient-search-badges">
                                        ${badges}
                                    </div>
                                </div>
                            `;
                        });

                        searchResultsContent.html(html);

                        // Agregar evento de clic a cada resultado
                        $('.patient-search-item').on('click', function() {
                            var pacienteData = $(this).data('paciente');
                            selectPaciente(pacienteData);
                        });
                    },
                    error: function(xhr) {
                        console.error('Error en b√∫squeda:', xhr);
                        searchResultsContent.html(
                            '<div class="search-empty-state text-danger">' +
                            '<i class="fas fa-exclamation-triangle"></i>' +
                            '<p class="mb-0">Error al buscar pacientes</p>' +
                            '<small>Por favor, intenta de nuevo</small>' +
                            '</div>'
                        );
                    }
                });
            }

            // Funci√≥n para seleccionar un paciente
            function selectPaciente(paciente) {
                console.log('Paciente seleccionado:', paciente);

                selectedPaciente = paciente;
                hiddenPacienteInput.val(paciente.id);

                // Mostrar tarjeta de paciente seleccionado
                $('#selectedPacienteNombre').text(paciente.nombre_completo);
                $('#selectedPacienteEmail').text(paciente.email);
                $('#selectedPacienteTelefono').text(paciente.telefono || 'No registrado');

                // Badges
                var badges = '';
                if (paciente.saldo_global > 0) {
                    badges += `<span class="badge bg-danger">Saldo: $${paciente.saldo_global.toFixed(2)}</span> `;
                }
                if (paciente.tiene_historial) {
                    badges += '<span class="badge bg-success">‚úÖ Historial Completo</span> ';
                } else {
                    badges += '<span class="badge bg-warning text-dark">‚ö†Ô∏è Historial Pendiente</span> ';
                }

                $('#selectedPacienteBadges').html(badges);

                // Mostrar/ocultar elementos
                pacienteSelectedDiv.show();
                searchResultsDiv.hide();
                searchPacienteInput.val('').prop('disabled', true);
            }

            // Funci√≥n para limpiar selecci√≥n
            function clearPacienteSelection() {
                selectedPaciente = null;
                hiddenPacienteInput.val('');
                pacienteSelectedDiv.hide();
                searchPacienteInput.val('').prop('disabled', false).focus();
            }

            // Event listeners para el buscador
            searchPacienteInput.on('input', function() {
                clearTimeout(searchTimeout);
                var query = $(this).val().trim();

                searchTimeout = setTimeout(function() {
                    searchPacientes(query);
                }, 300); // Delay de 300ms para evitar muchas peticiones
            });

            searchPacienteInput.on('focus', function() {
                if ($(this).val().length >= 2) {
                    searchResultsDiv.show();
                }
            });

            // Cerrar resultados al hacer clic fuera
            $(document).on('click', function(e) {
                if (!$(e.target).closest('#searchPaciente, #pacienteSearchResults').length) {
                    searchResultsDiv.hide();
                }
            });

            // Bot√≥n para limpiar selecci√≥n
            clearPacienteBtn.on('click', clearPacienteSelection);

            // L√≥gica de pacientes
            $('#addPacienteBtn').on('click', function(){
                $('#pacienteFormInline')[0].reset();
                $('#paciente-errors').addClass('d-none').empty();
                pacienteModal.show();
            });

            $('#pacienteFormInline').on('submit', function(e){
                e.preventDefault();
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const payload = {
                    nombre: this.nombre.value,
                    apellido: this.apellido.value,
                    email: this.email.value,
                    telefono: this.telefono.value,
                    fecha_nacimiento: this.fecha_nacimiento.value
                };
                fetch('{% tenant_url "core:crear_paciente_ajax" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify(payload)
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        // Usar el nuevo selector inteligente
                        var nuevoPaciente = {
                            id: data.paciente_id,
                            nombre_completo: data.paciente_nombre,
                            email: payload.email,
                            telefono: payload.telefono || '',
                            edad: null,
                            saldo_global: 0,
                            tiene_historial: false,
                            tiene_acceso_portal: false
                        };

                        selectPaciente(nuevoPaciente);
                        pacienteModal.hide();
                        Toastify({ text: data.message, duration: 3000, className: 'info' }).showToast();
                    } else {
                        $('#paciente-errors').removeClass('d-none').text(data.error || 'Error al crear paciente');
                    }
                }).catch(() => {
                    $('#paciente-errors').removeClass('d-none').text('Error de red al crear paciente');
                });
            });

            // Configuraci√≥n del calendario para FullCalendar 5.x
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: function(fetchInfo, successCallback, failureCallback) {
                    mostrarLoading();
                    fetch('{% tenant_url "core:agenda_events" %}?' + new URLSearchParams({
                        dentista: $('#dentistaFilter').val() || '',
                        estado: $('#estadoFilter').val() || '',
                        start: fetchInfo.startStr,
                        end: fetchInfo.endStr
                    }))
                    .then(async (response) => {
                        if (!response.ok) throw new Error('HTTP ' + response.status);
                        const ct = (response.headers.get('content-type') || '').toLowerCase();
                        if (!ct.includes('application/json')) {
                            const text = await response.text();
                            throw new Error('Invalid JSON: ' + text.slice(0, 200));
                        }
                        return response.json();
                    })
                    .then(data => {
                        ocultarLoading();
                        // Mapear estado desde extendedProps y aplicar clase
                        const events = data.map(event => {
                            const estado = (event.extendedProps && event.extendedProps.estado) ? event.extendedProps.estado : 'PRO';
                            return { ...event, className: 'cita-' + estado.toLowerCase(), estado };
                        });
                        actualizarEstadisticas(events);
                        successCallback(events);
                    })
                    .catch(error => {
                        ocultarLoading();
                        console.error('Error cargando eventos:', error);
                        failureCallback(error);
                    });
                },
                selectable: true,
                editable: true,
                eventDidMount: function(info) {
                    // Tooltip mejorado
                    info.el.title = `${info.event.title}\nEstado: ${info.event.extendedProps.estado_display}\nHora: ${info.event.start.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}`;
                },
                
                dateClick: function(info) {
                    console.log('Date clicked:', info.dateStr);
                    openNewAppointmentModal(info.dateStr);
                },
                
                eventClick: function(info) {
                    editAppointment(info.event.id);
                },
                
                datesSet: function(dateInfo) {
                    // Se ejecuta cuando cambia la vista
                    actualizarFiltroFecha(dateInfo.start);
                }
            });
            
            // Funciones para loading
            function mostrarLoading() {
                $('#loading-overlay').show();
            }
            
            function ocultarLoading() {
                $('#loading-overlay').hide();
            }
            
            // Funci√≥n para actualizar estad√≠sticas
            function actualizarEstadisticas(events) {
                const hoy = new Date().toDateString();
                const inicioSemana = new Date();
                inicioSemana.setDate(inicioSemana.getDate() - inicioSemana.getDay());
                
                const stats = {
                    hoy: 0,
                    semana: 0,
                    pendientes: 0,
                    completadas: 0,
                    canceladas: 0,
                    total: events.length
                };
                
                events.forEach(event => {
                    const eventDate = new Date(event.start);
                    
                    // Estad√≠sticas por fecha
                    if (eventDate.toDateString() === hoy) {
                        stats.hoy++;
                    }
                    
                    if (eventDate >= inicioSemana) {
                        stats.semana++;
                    }
                    
                    // Estad√≠sticas por estado
                    switch(event.estado) {
                        case 'PRO':
                        case 'CON':
                            stats.pendientes++;
                            break;
                        case 'COM':
                            stats.completadas++;
                            break;
                        case 'CAN':
                            stats.canceladas++;
                            break;
                    }
                });
                
                // Actualizar DOM
                $('#stat-hoy').text(stats.hoy);
                $('#stat-semana').text(stats.semana);
                $('#stat-pendientes').text(stats.pendientes);
                $('#stat-completadas').text(stats.completadas);
                $('#stat-canceladas').text(stats.canceladas);
                $('#stat-total').text(stats.total);
            }
            
            // Filtros
            $('#dentistaFilter, #estadoFilter').on('change', function() {
                calendar.refetchEvents();
            });
            
            $('#fechaFilter').on('change', function() {
                const selectedDate = this.value;
                if (selectedDate) {
                    calendar.gotoDate(selectedDate);
                }
            });
            
            // Funci√≥n para limpiar filtros
            window.limpiarFiltros = function() {
                $('#dentistaFilter').val('');
                $('#estadoFilter').val('');
                $('#fechaFilter').val('');
                calendar.today();
                calendar.refetchEvents();
            };
            
            // Actualizar filtro de fecha cuando cambia la vista
            function actualizarFiltroFecha(date) {
                const fechaStr = date.toISOString().split('T')[0];
                $('#fechaFilter').val(fechaStr);
            }
            
            // Funciones auxiliares - MUST BE DEFINED BEFORE CALENDAR INIT
            function openNewAppointmentModal(dateStr) {
                console.log('=== OPENING NEW APPOINTMENT MODAL ===');
                console.log('dateStr received:', dateStr);

                citaForm.reset();
                currentCitaId = null;
                modalTitle.textContent = 'Nueva Cita';

                const fechaPickerContainer = $('#fecha-picker-container');
                const fechaPickerInput = $('#id_fecha_cita');

                if (dateStr) {
                    // Fecha proporcionada desde calendario - usar directamente el string YYYY-MM-DD
                    console.log('Processing date from calendar:', dateStr);

                    // Parsear la fecha manualmente para evitar problemas de zona horaria
                    const [year, month, day] = dateStr.split('-').map(Number);
                    const selectedDate = new Date(year, month - 1, day);

                    console.log('Parsed date object:', selectedDate);

                    // Guardar la fecha en formato ISO (YYYY-MM-DD) en el dataset del form
                    citaForm.dataset.selectedDate = dateStr;

                    // Mostrar la fecha formateada en el modal
                    const dateDisplay = selectedDate.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    modalDate.textContent = 'üìÖ ' + dateDisplay;

                    fechaPickerContainer.hide();
                    console.log('Date successfully saved in form dataset:', citaForm.dataset.selectedDate);
                } else {
                    // Sin fecha - mostrar selector
                    console.log('No date provided - showing date picker');
                    modalDate.textContent = 'Seleccione la fecha de la cita';
                    citaForm.dataset.selectedDate = '';
                    fechaPickerContainer.show();
                    // Set min date to today
                    const today = new Date().toISOString().split('T')[0];
                    fechaPickerInput.attr('min', today);
                }

                // Limpiar selector de pacientes
                clearPacienteSelection();

                dentistaSelect.val('');
                unidadDentalSelect.val('');
                horaSelect.empty().append('<option value="">Primero seleccione fecha y dentista</option>').prop('disabled', true);

                // Limpiar servicios y buscador
                selectedServiciosIds = [];
                searchServiciosInput.val('');

                // Recargar servicios desde el select actual
                loadAllServicios();

                updateServiciosList();
                renderServiciosDisponibles();

                statusIndicator.hide();
                $('#editarCitaBtn').hide();
                $('#cancelarCitaBtn').hide();
                $('#guardarCitaBtn').show();
                citaModal.show();
            }
            
            // Manejar cambio en el selector de fecha manual
            $('#id_fecha_cita').on('change', function() {
                const selectedDate = $(this).val();
                if (selectedDate) {
                    citaForm.dataset.selectedDate = selectedDate;
                    const date = new Date(selectedDate + 'T00:00:00');
                    modalDate.textContent = 'üìÖ ' + date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    console.log('Manual date selected:', selectedDate);
                    
                    // Si ya hay dentista seleccionado, cargar horarios
                    const dentistaId = dentistaSelect.val();
                    if (dentistaId) {
                        loadAvailableHours(dentistaId, selectedDate);
                    }
                }
            });
            
            window.openNewAppointmentModal = openNewAppointmentModal;
            
            function editAppointment(citaId) {
                currentCitaId = citaId;
                modalTitle.textContent = 'Editar Cita';
                
                // Cargar datos de la cita
                // Build tenant-aware API URL
                const tenantPrefix = '{{ request.tenant_prefix|default:"" }}';
                const citaApiUrl = tenantPrefix ? `${tenantPrefix}/api/citas/${citaId}/` : `/api/citas/${citaId}/`;
                fetch(citaApiUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const cita = data.cita;
                            
                            // Llenar formulario
                            pacienteSelect.val(cita.paciente_id);
                            dentistaSelect.val(cita.dentista_id).trigger('change');
                            unidadDentalSelect.val(cita.unidad_dental_id);
                            
                            // Formatear fecha para el modal
                            const fecha = new Date(cita.fecha_hora);
                            modalDate.textContent = fecha.toLocaleDateString('es-ES', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            });
                            
                            // Cargar horarios y seleccionar la hora
                            setTimeout(() => {
                                horaSelect.val(fecha.toTimeString().substr(0, 5));
                            }, 500);
                            
                            $('#id_motivo').val(cita.motivo || '');
                            $('#id_notas').val(cita.notas || '');
                            
                            // Mostrar estado
                            updateStatusBadge(cita.estado);
                            statusIndicator.show();
                            
                            // Cargar servicios
                            loadSelectedServices(cita.servicios_planeados || []);
                            
                            $('#editarCitaBtn, #cancelarCitaBtn').show();
                            $('#guardarCitaBtn').text('Actualizar');
                        }
                    })
                    .catch(error => {
                        console.error('Error cargando cita:', error);
                        alert('Error al cargar los datos de la cita');
                    });
                
                citaModal.show();
            }
            
            function updateStatusBadge(estado) {
                const estados = {
                    'PRO': { text: 'Programada', class: 'bg-secondary' },
                    'CON': { text: 'Confirmada', class: 'bg-primary' },
                    'ATN': { text: 'Atendida', class: 'bg-warning' },
                    'COM': { text: 'Completada', class: 'bg-success' },
                    'CAN': { text: 'Cancelada', class: 'bg-danger' }
                };
                
                const estadoInfo = estados[estado] || { text: estado, class: 'bg-secondary' };
                statusBadge.textContent = estadoInfo.text;
                statusBadge.className = 'badge rounded-pill ' + estadoInfo.class;
            }
            
            function loadSelectedServices(servicios) {
                listaServiciosSeleccionados.empty();
                serviciosSelect.find('option').prop('disabled', false);
                
                servicios.forEach(servicio => {
                    const li = '<li class="list-group-item list-group-item-sm py-1 px-2 d-flex justify-content-between align-items-center" data-service-id="' + servicio.id + '">' +
                                '<span>' + servicio.nombre + '</span>' +
                                '<button type="button" class="btn-close remove-service-btn" aria-label="Eliminar"></button>' +
                            '</li>';
                    listaServiciosSeleccionados.append(li);
                    serviciosSelect.find('option[value="' + servicio.id + '"]').prop('disabled', true);
                });
                
                updateHiddenInput();
            }
            
            // Manejo de cambio de estado
            $('.change-status-btn').on('click', function(e) {
                e.preventDefault();
                const nuevoEstado = $(this).data('estado');
                
                if (!currentCitaId) return;
                
                fetch('/citas/' + currentCitaId + '/estado/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    body: JSON.stringify({ estado: nuevoEstado })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateStatusBadge(nuevoEstado);
                        calendar.refetchEvents();
                        
                        if (typeof Toastify !== 'undefined') {
                            Toastify({ 
                                text: 'Estado actualizado', 
                                duration: 3000, 
                                className: 'info' 
                            }).showToast();
                        }
                    }
                });
            });
            
            // REMOVED: Duplicate dentista change handler - using the one at line 1032
            
            console.log('Agenda moderna inicializada correctamente');
            ocultarLoading();
            
            // Event listeners
            dentistaSelect.on('change', function() {
                const dentistaId = $(this).val();
                const selectedDate = citaForm.dataset.selectedDate;
                console.log('=== DENTISTA CHANGED ==>');
                console.log('  Dentista ID:', dentistaId);
                console.log('  Selected Date:', selectedDate);
                console.log('  Form dataset:', citaForm.dataset);

                // Recargar servicios (pueden cambiar seg√∫n el dentista)
                console.log('  -> Reloading services for dentista:', dentistaId);
                loadAllServicios();
                renderServiciosDisponibles(searchServiciosInput.val());

                if (dentistaId && selectedDate) {
                    console.log('  -> Loading hours for', dentistaId, 'on', selectedDate);
                    horaSelect.prop('disabled', false);
                    loadAvailableHours(dentistaId, selectedDate);
                } else if (!selectedDate) {
                    console.warn('  -> No date selected');
                    horaSelect.empty().append('<option value="">Seleccione una fecha primero</option>').prop('disabled', true);
                } else {
                    console.warn('  -> No dentista selected');
                    horaSelect.empty().append('<option value="">Seleccione dentista</option>').prop('disabled', true);
                }
            });

            function loadAvailableHours(dentistaId, fecha, selectedHour) {
                console.log('Loading hours for dentista:', dentistaId, 'fecha:', fecha);
                horaSelect.empty().append('<option value="">Cargando...</option>').prop('disabled', true);
                
                // Build URL with tenant prefix from request
                const tenantPrefix = '{{ request.tenant_prefix|default:"" }}';
                const baseUrl = tenantPrefix ? `${tenantPrefix}/api/dentista/${dentistaId}/horarios-disponibles/` : `/api/dentista/${dentistaId}/horarios-disponibles/`;
                
                console.log('Tenant prefix:', tenantPrefix);
                console.log('Fetching from URL:', baseUrl, 'with params:', { fecha: fecha });
                
                $.ajax({
                    url: baseUrl,
                    data: { fecha: fecha },
                    success: function(response) {
                        console.log('Hours loaded successfully:', response);
                        horaSelect.empty().append('<option value="">Seleccione horario</option>');
                        let opciones = response.horarios_disponibles || [];
                        
                        // Filtro adicional en frontend para el d√≠a actual (respaldo)
                        try {
                            const hoyStr = new Date().toISOString().split('T')[0];
                            if (fecha === hoyStr) {
                                const now = new Date();
                                const minutosActual = now.getHours() * 60 + now.getMinutes();
                                opciones = opciones.filter(h => {
                                    const [hh, mm] = h.split(':').map(Number);
                                    return (hh * 60 + mm) >= minutosActual;
                                });
                            }
                        } catch (_e) {}
                        
                        if (opciones.length === 0) {
                            horaSelect.empty().append('<option value="">No hay horarios disponibles</option>');
                            horaSelect.prop('disabled', true);
                            return;
                        }
                        
                        if (selectedHour && opciones.indexOf(selectedHour) === -1) {
                            opciones.unshift(selectedHour);
                        }
                        opciones.forEach(function(h) { horaSelect.append('<option value="' + h + '\">' + h + '</option>'); });
                        if (selectedHour) horaSelect.val(selectedHour);
                        horaSelect.prop('disabled', false);
                    },
                    error: function(xhr, status, error) { 
                        console.error('Error loading hours:', xhr.status, status, error);
                        console.error('Response:', xhr.responseText);
                        horaSelect.empty().append('<option value="">Error al cargar horarios</option>');
                        horaSelect.prop('disabled', true);
                        
                        // Show user-friendly error
                        if (xhr.status === 401) {
                            Toastify({ text: 'Su sesi√≥n ha expirado. Por favor, recargue la p√°gina e inicie sesi√≥n.', duration: 5000, className: 'error' }).showToast();
                            setTimeout(function() {
                                window.location.href = "{% tenant_url 'login' %}?next=" + encodeURIComponent(window.location.pathname);
                            }, 3000);
                        } else if (xhr.status === 404) {
                            Toastify({ text: 'Dentista no encontrado', duration: 3000, className: 'error' }).showToast();
                        } else if (xhr.status === 500) {
                            Toastify({ text: 'Error del servidor al cargar horarios', duration: 3000, className: 'error' }).showToast();
                        }
                    }
                });
            }
            
            // Form submission
            citaForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitAppointmentForm();
            });
            
            function submitAppointmentForm() {
                // Validaci√≥n personalizada antes de enviar
                const selectedDate = citaForm.dataset.selectedDate;
                const selectedTime = horaSelect.val();
                const selectedPaciente = $('#id_paciente').val();

                // Validar campos obligatorios
                if (!selectedPaciente) {
                    Toastify({ text: 'Por favor seleccione un paciente', duration: 3000, className: 'error' }).showToast();
                    return;
                }

                if (!selectedDate) {
                    Toastify({ text: 'Por favor seleccione una fecha desde el calendario', duration: 3000, className: 'error' }).showToast();
                    return;
                }

                if (!selectedTime) {
                    Toastify({ text: 'Por favor seleccione una hora', duration: 3000, className: 'error' }).showToast();
                    return;
                }

                if (selectedServiciosIds.length === 0) {
                    Toastify({ text: 'Por favor seleccione al menos un servicio', duration: 3000, className: 'error' }).showToast();
                    return;
                }

                const formData = new FormData(citaForm);
                const url = currentCitaId ? '/citas/' + currentCitaId + '/update/' : '{% tenant_url "core:cita_create" %}';
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                formData.append('csrfmiddlewaretoken', csrftoken);

                const localDateTime = selectedDate + 'T' + selectedTime + ':00';
                formData.append('fecha_hora', localDateTime);

                $.ajax({
                    url: url,
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: { "X-CSRFToken": csrftoken },
                    success: function(response) {
                        if (response.success) {
                            citaModal.hide();
                            Toastify({ text: response.message, duration: 3000, className: 'info' }).showToast();
                            calendar.refetchEvents();
                        } else {
                            showFormErrors(response.errors);
                        }
                    },
                    error: function(xhr) {
                        console.error('Error al guardar cita:', xhr.status, xhr.responseJSON);

                        if (xhr.status === 403) {
                            Toastify({ text: 'Su sesi√≥n ha expirado. Redirigiendo...', duration: 3000, className: 'error' }).showToast();
                            setTimeout(function() { window.location.href = "{% tenant_url 'login' %}?next=" + encodeURIComponent(window.location.pathname); }, 2000);
                        } else if (xhr.status === 400 && xhr.responseJSON) {
                            // Error de validaci√≥n - mostrar errores espec√≠ficos
                            if (xhr.responseJSON.errors) {
                                showFormErrors(xhr.responseJSON.errors);
                            } else if (xhr.responseJSON.error) {
                                Toastify({ text: xhr.responseJSON.error, duration: 5000, className: 'error' }).showToast();
                            } else {
                                Toastify({ text: 'Error de validaci√≥n. Revisa los datos ingresados.', duration: 5000, className: 'error' }).showToast();
                            }
                        } else {
                            Toastify({ text: 'Error de comunicaci√≥n con el servidor.', duration: 3000, className: 'error' }).showToast();
                        }
                    }
                });
            }
            
            function showFormErrors(errors) {
                const formErrorsDiv = $('#form-errors');
                formErrorsDiv.html('<h6>Por favor, corrige los siguientes errores:</h6><ul></ul>').show();
                const errorList = formErrorsDiv.find('ul');
                if (typeof errors === 'object' && errors !== null) {
                    for (const field in errors) {
                        errors[field].forEach(function(error) {
                            let fieldName = field.replace(/_/g, ' ');
                            fieldName = fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
                            errorList.append('<li><strong>' + fieldName + ':</strong> ' + error + '</li>');
                        });
                    }
                } else {
                    errorList.append('<li>Error desconocido.</li>');
                }
            }
            
            document.getElementById('debug-text').innerText = 'Renderizando calendario...';
            calendar.render();
            
            document.getElementById('debug-text').innerText = 'Calendario moderno cargado exitosamente!';
            
            // Ocultar debug despu√©s de 3 segundos
            setTimeout(function() {
                document.getElementById('debug-info').style.display = 'none';
            }, 3000);
            
        } catch (error) {
            console.error('Error creando calendario:', error);
            document.getElementById('debug-text').innerText = 'Error: ' + error.message;
            showBasicFallback();
            return;
        }
    }

    // Funci√≥n para mostrar fallback b√°sico cuando falla el calendario moderno
    function showBasicFallback() {
        console.log('Mostrando fallback b√°sico');
        var calendarEl = document.getElementById('calendar');
        
        calendarEl.innerHTML = 
            '<div class="alert alert-warning">' +
            '<h4><i class="fas fa-exclamation-triangle"></i> Calendario No Disponible</h4>' +
            '<p>El calendario avanzado no se puede cargar en este dispositivo.</p>' +
            '<p><strong>Opciones disponibles:</strong></p>' +
            '</div>' +
            '<div class="row">' +
            '<div class="col-md-6 mb-3">' +
            '<div class="card">' +
            '<div class="card-body text-center">' +
            '<i class="fas fa-plus-circle fa-3x text-primary mb-3"></i>' +
            '<h5>Gestionar Citas</h5>' +
            '<p>Ver y gestionar todas las citas</p>' +
            '<a href="{% tenant_url 'core:cita_list' %}" class="btn btn-primary btn-lg">Ir a Lista de Citas</a>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<div class="col-md-6 mb-3">' +
            '<div class="card">' +
            '<div class="card-body text-center">' +
            '<i class="fas fa-list fa-3x text-success mb-3"></i>' +
            '<h5>Calendario Simplificado</h5>' +
            '<p>Versi√≥n compatible con dispositivos antiguos</p>' +
            '<a href="{% tenant_url 'core:agenda_legacy' %}" class="btn btn-success btn-lg">Usar Versi√≥n Simple</a>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';
    }
    </script>
{% endblock %}