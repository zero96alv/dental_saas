{% extends "core/base.html" %}
{% load tenant_urls %}

{% block title %}Valor del Inventario{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-bar-chart-line-fill me-2"></i> Valor del Inventario</h2>
        <button class="btn btn-success" onclick="exportarExcel()">
            <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
        </button>
    </div>

    <!-- Resumen Estadístico -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-muted">Valor Total del Inventario</h5>
                    <h2 class="text-primary">${{ valor_total_inventario|floatformat:2 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-muted">Insumos en Stock</h5>
                    <h2 class="text-info">{{ cantidad_items }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-muted">Insumos sin Costo</h5>
                    <h2 class="{% if cantidad_sin_costo > 0 %}text-warning{% else %}text-success{% endif %}">
                        {{ cantidad_sin_costo }}
                    </h2>
                </div>
            </div>
        </div>
    </div>

    {% if cantidad_sin_costo > 0 %}
    <div class="alert alert-warning" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>Atención:</strong> Hay {{ cantidad_sin_costo }} insumo{{ cantidad_sin_costo|pluralize }} con lotes sin costo capturado.
        <a href="{% tenant_url 'core:compras_sin_costos' %}" class="alert-link">Capturar costos</a>
    </div>
    {% endif %}

    <!-- Tabla de Insumos -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">Detalle por Insumo</h5>
        </div>
        <div class="card-body">
            {% if datos_insumos %}
            <div class="table-responsive">
                <table class="table table-hover table-striped" id="tablaInventario">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Insumo</th>
                            <th scope="col">Proveedor</th>
                            <th scope="col" class="text-center">Stock</th>
                            <th scope="col" class="text-end">Valor Total</th>
                            <th scope="col" class="text-center">Estado Costo</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in datos_insumos %}
                        <tr>
                            <td>
                                <strong>{{ item.nombre }}</strong>
                            </td>
                            <td>{{ item.proveedor }}</td>
                            <td class="text-center">
                                <span class="badge bg-secondary">
                                    {{ item.stock }} {{ item.unidad_medida }}
                                </span>
                            </td>
                            <td class="text-end">
                                <strong class="{% if item.valor_total > 0 %}text-success{% else %}text-muted{% endif %}">
                                    ${{ item.valor_total|floatformat:2 }}
                                </strong>
                            </td>
                            <td class="text-center">
                                {% if item.tiene_costo %}
                                    {% if item.lotes_sin_costo > 0 %}
                                        <span class="badge bg-warning text-dark" title="Algunos lotes sin costo">
                                            <i class="bi bi-exclamation-triangle"></i> Parcial
                                        </span>
                                    {% else %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Completo
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-x-circle"></i> Sin Costo
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="3" class="text-end">TOTAL:</th>
                            <th class="text-end">
                                <h5 class="mb-0 text-primary">${{ valor_total_inventario|floatformat:2 }}</h5>
                            </th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <p class="text-muted mt-3">No hay insumos en stock.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="mt-3">
        <a href="{% tenant_url 'core:insumo_list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver a Inventario
        </a>
    </div>
</div>

<script>
    function exportarExcel() {
        // Crear tabla exportable
        let html = '<table>';
        html += '<thead><tr><th>Insumo</th><th>Proveedor</th><th>Stock</th><th>Unidad</th><th>Valor Total</th><th>Estado</th></tr></thead>';
        html += '<tbody>';

        {% for item in datos_insumos %}
        html += '<tr>';
        html += '<td>{{ item.nombre|escapejs }}</td>';
        html += '<td>{{ item.proveedor|escapejs }}</td>';
        html += '<td>{{ item.stock }}</td>';
        html += '<td>{{ item.unidad_medida|escapejs }}</td>';
        html += '<td>${{ item.valor_total|floatformat:2 }}</td>';
        html += '<td>{% if item.tiene_costo %}Con Costo{% else %}Sin Costo{% endif %}</td>';
        html += '</tr>';
        {% endfor %}

        html += '</tbody></table>';

        // Crear blob y descargar
        const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `valor_inventario_${new Date().toISOString().slice(0,10)}.xls`;
        a.click();
        window.URL.revokeObjectURL(url);
    }
</script>
{% endblock %}
