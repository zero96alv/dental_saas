{% extends "core/base.html" %}
{% block title %}Servicios más vendidos por periodo{% endblock %}
{% block content %}
<div class="container-fluid">
  <h2 class="mb-3"><i class="bi bi-bar-chart-line me-2"></i> Servicios más vendidos</h2>
  <div class="card mb-3">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end" data-default-inicio="{{ fecha_inicio|date:'Y-m-d' }}" data-default-fin="{{ fecha_fin|date:'Y-m-d' }}">
        <div class="col-md-3">
          <label class="form-label">Periodo</label>
          {{ form.periodo }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha inicio</label>
          {{ form.fecha_inicio }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha fin</label>
          {{ form.fecha_fin }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Dentista</label>
          {{ form.dentista }}
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-primary"><i class="bi bi-funnel me-1"></i> Aplicar</button>
        </div>
      </form>
    </div>
  </div>

  {% if resultados %}
    {% for bloque in resultados %}
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>{{ bloque.periodo }}</strong>
          <small class="text-muted">Top {{ bloque.items|length }} servicios</small>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-lg-6">
              <canvas id="chart_{{ forloop.counter }}" height="220"></canvas>
            </div>
            <div class="col-lg-6">
              <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Servicio</th>
                      <th class="text-end">Cantidad</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for it in bloque.items %}
                      <tr>
                        <td>{{ it.servicio }}</td>
                        <td class="text-end">{{ it.cantidad }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info">No hay datos para el periodo seleccionado.</div>
  {% endif %}
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const formEl = document.querySelector('form[method="get"][data-default-inicio]');
  if (formEl) {
    const inicio = document.getElementById('id_fecha_inicio');
    const fin = document.getElementById('id_fecha_fin');
    const defInicio = formEl.getAttribute('data-default-inicio');
    const defFin = formEl.getAttribute('data-default-fin');
    if (inicio && !inicio.value && defInicio) inicio.value = defInicio;
    if (fin && !fin.value && defFin) fin.value = defFin;
  }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  // Configurar charts para cada bloque
  const resultados = {{ resultados|safe|default:'[]' }};
  resultados.forEach((bloque, idx) => {
    const labels = bloque.items.map(i => i.servicio);
    const values = bloque.items.map(i => i.cantidad);
    const ctx = document.getElementById('chart_' + (idx+1));
    if (!ctx) return;
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Cantidad',
          data: values,
          backgroundColor: 'rgba(13,110,253,.5)',
          borderColor: 'rgba(13,110,253,1)',
          borderWidth: 1,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } },
          y: { beginAtZero: true, precision: 0 }
        }
      }
    });
  });
})();
</script>
{% endblock %}

