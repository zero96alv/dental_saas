{% extends "core/base.html" %}
{% load tenant_urls %}

{% block title %}Ingresos por Dentista{% endblock %}

{% block extra_css %}
<style>
    .kpi-card {
        border-radius: 10px;
        transition: transform 0.2s, box-shadow 0.2s;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    .kpi-value {
        font-size: 2rem;
        font-weight: bold;
        margin: 0.5rem 0;
    }
    .kpi-label {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .kpi-subtitle {
        font-size: 0.85rem;
        margin-top: 0.5rem;
    }
    .kpi-icon {
        font-size: 2.5rem;
        opacity: 0.2;
        position: absolute;
        right: 15px;
        top: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4"><i class="bi bi-person-lines-fill me-2"></i>Ingresos por Dentista</h2>

    <!-- KPI Cards -->
    <div class="row mb-4">
        <!-- Total Ingresos -->
        <div class="col-md-3 mb-3">
            <div class="card kpi-card" style="background-color: #2196f3; color: white;">
                <div class="card-body position-relative">
                    <i class="bi bi-currency-dollar kpi-icon" style="color: rgba(255,255,255,0.2);"></i>
                    <div class="kpi-label" style="color: rgba(255,255,255,0.9); font-weight: 500;">INGRESOS TOTALES</div>
                    <div class="kpi-value" style="color: white;">${{ total_ingresos|floatformat:0 }}</div>
                    <div class="kpi-subtitle" style="color: rgba(255,255,255,0.9);">
                        <i class="bi bi-calendar-range"></i>
                        En el periodo
                    </div>
                </div>
            </div>
        </div>

        <!-- Promedio por Dentista -->
        <div class="col-md-3 mb-3">
            <div class="card kpi-card" style="background-color: #4caf50; color: white;">
                <div class="card-body position-relative">
                    <i class="bi bi-calculator kpi-icon" style="color: rgba(255,255,255,0.2);"></i>
                    <div class="kpi-label" style="color: rgba(255,255,255,0.9); font-weight: 500;">PROMEDIO / DENTISTA</div>
                    <div class="kpi-value" style="color: white;">${{ promedio_por_dentista|floatformat:0 }}</div>
                    <div class="kpi-subtitle" style="color: rgba(255,255,255,0.9);">
                        <i class="bi bi-people-fill"></i>
                        {{ total_dentistas }} dentista{{ total_dentistas|pluralize }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Dentista Top -->
        <div class="col-md-3 mb-3">
            <div class="card kpi-card" style="background-color: #ff9800; color: white;">
                <div class="card-body position-relative">
                    <i class="bi bi-trophy-fill kpi-icon" style="color: rgba(255,255,255,0.2);"></i>
                    <div class="kpi-label" style="color: rgba(255,255,255,0.9); font-weight: 500;">DENTISTA TOP</div>
                    <div class="kpi-value" style="font-size: 1.3rem; color: white;">{{ dentista_top_nombre|truncatechars:20 }}</div>
                    <div class="kpi-subtitle" style="color: rgba(255,255,255,0.9);">
                        <i class="bi bi-star-fill"></i>
                        ${{ dentista_top_ingresos|floatformat:0 }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Citas -->
        <div class="col-md-3 mb-3">
            <div class="card kpi-card" style="background-color: #9c27b0; color: white;">
                <div class="card-body position-relative">
                    <i class="bi bi-calendar-check-fill kpi-icon" style="color: rgba(255,255,255,0.2);"></i>
                    <div class="kpi-label" style="color: rgba(255,255,255,0.9); font-weight: 500;">CITAS ATENDIDAS</div>
                    <div class="kpi-value" style="color: white;">{{ total_citas_count }}</div>
                    <div class="kpi-subtitle" style="color: rgba(255,255,255,0.9);">
                        <i class="bi bi-clipboard-check"></i>
                        Completadas en el periodo
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-funnel me-2"></i>Filtros
        </div>
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end" data-default-inicio="{{ fecha_inicio|date:'Y-m-d' }}" data-default-fin="{{ fecha_fin|date:'Y-m-d' }}">
                <div class="col-md-3">
                    <label class="form-label">Periodo</label>
                    {{ form.periodo }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha inicio</label>
                    {{ form.fecha_inicio }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha fin</label>
                    {{ form.fecha_fin }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Dentista</label>
                    {{ form.dentista }}
                </div>
                <div class="col-12 text-end">
                    <button class="btn btn-primary">
                        <i class="bi bi-funnel me-1"></i>Aplicar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Resultados por Periodo -->
    {% if resultados %}
        {% for bloque in resultados %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #f8f9fa;">
                <strong><i class="bi bi-calendar-event me-2"></i>{{ bloque.periodo }}</strong>
                <span class="badge bg-primary">{{ bloque.items|length }} dentista{{ bloque.items|length|pluralize }}</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Gráfica Comparativa -->
                    <div class="col-lg-6 mb-3">
                        <div style="position: relative; height: 300px;">
                            <canvas id="chart_{{ forloop.counter }}"></canvas>
                        </div>
                    </div>
                    <!-- Tabla con Métricas -->
                    <div class="col-lg-6">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Dentista</th>
                                        <th class="text-center">Citas</th>
                                        <th class="text-end">Ingresos</th>
                                        <th class="text-end">$/Cita</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for it in bloque.items %}
                                    <tr>
                                        <td>
                                            <i class="bi bi-circle-fill" style="color: {{ forloop.counter|default:'#2196f3' }}; font-size: 0.5rem;"></i>
                                            <strong>{{ it.dentista }}</strong>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary">{{ it.citas }}</span>
                                        </td>
                                        <td class="text-end text-success">
                                            <strong>${{ it.total|floatformat:2 }}</strong>
                                        </td>
                                        <td class="text-end text-muted">
                                            ${{ it.promedio_cita|floatformat:0 }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No hay datos para el periodo seleccionado.
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    // Prefijar fechas si están vacías
    const formEl = document.querySelector('form[method="get"][data-default-inicio]');
    if (formEl) {
        const inicio = document.getElementById('id_fecha_inicio');
        const fin = document.getElementById('id_fecha_fin');
        const defInicio = formEl.getAttribute('data-default-inicio');
        const defFin = formEl.getAttribute('data-default-fin');
        if (inicio && !inicio.value && defInicio) inicio.value = defInicio;
        if (fin && !fin.value && defFin) fin.value = defFin;
    }

    // Configuración de colores
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#666';

    // Configurar charts para cada bloque
    const resultados = {{ resultados|safe|default:'[]' }};

    // Colores para dentistas
    const colors = [
        'rgba(33, 150, 243, 0.8)',
        'rgba(76, 175, 80, 0.8)',
        'rgba(255, 152, 0, 0.8)',
        'rgba(156, 39, 176, 0.8)',
        'rgba(244, 67, 54, 0.8)',
        'rgba(0, 188, 212, 0.8)',
        'rgba(255, 193, 7, 0.8)',
        'rgba(103, 58, 183, 0.8)',
        'rgba(233, 30, 99, 0.8)',
        'rgba(96, 125, 139, 0.8)'
    ];

    resultados.forEach((bloque, idx) => {
        const labels = bloque.items.map(i => i.dentista);
        const ingresos = bloque.items.map(i => i.total);
        const citas = bloque.items.map(i => i.citas);

        const ctx = document.getElementById('chart_' + (idx+1));
        if (!ctx) return;

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Ingresos ($)',
                        data: ingresos,
                        backgroundColor: colors.slice(0, ingresos.length),
                        borderColor: colors.slice(0, ingresos.length).map(c => c.replace('0.8', '1')),
                        borderWidth: 2,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Citas Atendidas',
                        data: citas,
                        type: 'line',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            padding: 15,
                            font: { size: 12, weight: 'bold' },
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.datasetIndex === 0) {
                                    label += '$' + context.parsed.y.toFixed(2);
                                } else {
                                    label += context.parsed.y + ' citas';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            autoSkip: false,
                            maxRotation: 45,
                            minRotation: 45,
                            font: { size: 10 }
                        },
                        grid: { display: false }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Ingresos ($)',
                            font: { weight: 'bold' }
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Citas',
                            font: { weight: 'bold' }
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    });
});
</script>
{% endblock %}
