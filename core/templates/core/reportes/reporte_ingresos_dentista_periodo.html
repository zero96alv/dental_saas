{% extends "core/base.html" %}
{% block title %}Ingresos por dentista por periodo{% endblock %}
{% block content %}
<div class="container-fluid">
  <h2 class="mb-3"><i class="bi bi-person-lines-fill me-2"></i> Ingresos por dentista</h2>
  <div class="card mb-3">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Periodo</label>
          {{ form.periodo }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha inicio</label>
          {{ form.fecha_inicio }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha fin</label>
          {{ form.fecha_fin }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Dentista</label>
          {{ form.dentista }}
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-primary"><i class="bi bi-funnel me-1"></i> Aplicar</button>
        </div>
      </form>
    </div>
  </div>

  {% if resultados %}
    {% for bloque in resultados %}
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>{{ bloque.periodo }}</strong>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-lg-6">
              <canvas id="chart_ing_{{ forloop.counter }}" height="220"></canvas>
            </div>
            <div class="col-lg-6">
              <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Dentista</th>
                      <th class="text-end">Ingresos</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for it in bloque.items %}
                      <tr>
                        <td>{{ it.dentista }}</td>
                        <td class="text-end">${{ it.total|floatformat:2 }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info">No hay datos para el periodo seleccionado.</div>
  {% endif %}
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const resultados = {{ resultados|safe|default:'[]' }};
  resultados.forEach((bloque, idx) => {
    const labels = bloque.items.map(i => i.dentista);
    const values = bloque.items.map(i => i.total);
    const ctx = document.getElementById('chart_ing_' + (idx+1));
    if (!ctx) return;
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Ingresos',
          data: values,
          backgroundColor: 'rgba(25,135,84,.5)',
          borderColor: 'rgba(25,135,84,1)',
          borderWidth: 1,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: (ctx) => '$' + ctx.raw.toFixed(2) } }
        },
        scales: {
          x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } },
          y: { beginAtZero: true }
        }
      }
    });
  });
})();
</script>
{% endblock %}

