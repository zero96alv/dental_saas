{% extends 'core/base.html' %}
{% load tenant_urls %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Agenda de Citas{% endblock %}

{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
{% endblock %}

{% block content %}
    <div class="container">
        <h1>Agenda de Citas</h1>
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="dentistaFilter" class="form-label">Filtrar por Dentista:</label>
                <select id="dentistaFilter" class="form-select">
                    <option value="">Todos los Dentistas</option>
                    {% for dentista in dentistas %}
                        <option value="{{ dentista.pk }}">{{ dentista }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Debug info -->
        <div id="debug-info" class="alert alert-info mb-3" style="display: none;">
            <strong>Debug:</strong> <span id="debug-text">Cargando...</span>
        </div>
        
        <div id="calendar"></div>

        <!-- Modal para Añadir/Editar Cita -->
        <div class="modal fade" id="citaModal" tabindex="-1" aria-labelledby="citaModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form id="citaForm" method="POST">
                        {% csrf_token %}
                        <div class="modal-header">
                            <div>
                                <h5 class="modal-title" id="citaModalLabel">Nueva Cita</h5>
                                <small class="text-muted" id="citaModalDate"></small>
                            </div>
                            <div id="status-indicator" class="ms-auto" style="display: none;">
                                <div class="dropdown">
                                    <button class="btn btn-sm dropdown-toggle" type="button" id="statusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span class="badge rounded-pill" id="status-badge"></span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="statusDropdown">
                                        <li><a class="dropdown-item change-status-btn" href="#" data-estado="PRO">Programada</a></li>
                                        <li><a class="dropdown-item change-status-btn" href="#" data-estado="CON">Confirmada</a></li>
                                        <li><a class="dropdown-item change-status-btn" href="#" data-estado="ATN">Atendida</a></li>
                                        <li><a class="dropdown-item change-status-btn" href="#" data-estado="COM">Completada</a></li>
                                        <li><a class="dropdown-item change-status-btn" href="#" data-estado="CAN">Cancelada</a></li>
                                    </ul>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="form-errors" class="alert alert-danger" style="display: none;"></div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_paciente" class="form-label requiredField">Paciente</label>
                                        <div class="input-group">
                                            {{ cita_form.paciente }}
                                            <button class="btn btn-outline-secondary" type="button" id="addPacienteBtn" title="Nuevo Paciente"><i class="fas fa-plus"></i> Nuevo</button>
                                        </div>
                                    </div>
                                    {{ cita_form.dentista|as_crispy_field }}
                                    {{ cita_form.unidad_dental|as_crispy_field }}
                                    <div class="mb-3">
                                        <label for="id_hora" class="form-label">Hora</label>
                                        <select id="id_hora" class="form-select" required>
                                            <option value="">Primero seleccione un dentista</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_servicios_planeados" class="form-label">Añadir Servicios</label>
                                        {{ cita_form.servicios_planeados }}
                                    </div>
                                    <h6>Servicios Seleccionados</h6>
                                    <ul id="lista-servicios-seleccionados" class="list-group mb-3" style="min-height: 80px; max-height: 120px; overflow-y: auto;"></ul>
                                    {{ cita_form.motivo|as_crispy_field }}
                                    {{ cita_form.notas|as_crispy_field }}
                                    <input type="hidden" id="id_servicios_seleccionados_hidden">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-warning me-auto" id="editarCitaBtn" style="display: none;">Editar</button>
                            <button type="button" class="btn btn-danger" id="cancelarCitaBtn" style="display: none;">Cancelar Cita</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary" id="guardarCitaBtn">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Crear Paciente -->
        <div class="modal fade" id="pacienteModal" tabindex="-1" aria-labelledby="pacienteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="pacienteFormInline" method="POST">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="pacienteModalLabel">Nuevo Paciente</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="paciente-errors" class="alert alert-danger d-none"></div>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label">Nombre</label>
                                    <input class="form-control" name="nombre" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Apellido</label>
                                    <input class="form-control" name="apellido" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Teléfono</label>
                                    <input class="form-control" name="telefono" placeholder="55 1234 5678">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Fecha de nacimiento</label>
                                    <input type="date" class="form-control" name="fecha_nacimiento" required>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar Paciente</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <!-- Detección temprana de dispositivos antiguos -->
    <script>
    // Función para detectar dispositivos antiguos
    function detectarDispositivoAntiguo() {
        var ua = navigator.userAgent;
        var isOldIOS = /iPad.*OS [89]_/.test(ua); // iOS 8 o 9
        var isOldAndroid = /Android [4-5]/.test(ua); // Android 4.x o 5.x
        var isOldSafari = /Version\/[89].*Safari/.test(ua); // Safari 8 o 9
        var isOldChrome = /Chrome\/[4-5][0-9]/.test(ua); // Chrome 40-59
        
        // Detectar falta de APIs modernas
        var noIntl = typeof Intl === 'undefined';
        var noFetch = typeof fetch === 'undefined';
        var noPromises = typeof Promise === 'undefined';
        var noArrowFunctions = false;
        
        // Test para arrow functions
        try {
            eval('(() => {})');
        } catch(e) {
            noArrowFunctions = true;
        }
        
        // Si es un dispositivo/navegador antiguo o le faltan APIs críticas
        if (isOldIOS || isOldAndroid || isOldSafari || isOldChrome || noIntl || noPromises || noArrowFunctions) {
            console.log('Dispositivo antiguo detectado, redirigiendo...');
            // Redirección inmediata
            window.location.href = '{% tenant_url "core:agenda_legacy" %}';
            return true;
        }
        
        return false;
    }
    
    // Ejecutar detección inmediata
    if (detectarDispositivoAntiguo()) {
        // Si redirige, no ejecutar el resto del código
    } else {
        console.log('Dispositivo moderno detectado, cargando calendario completo');
        // Para dispositivos modernos, cargar todas las librerías dinámicamente
        loadModernCalendar();
    }
    
    function loadModernCalendar() {
        // Mostrar debug
        document.getElementById('debug-info').style.display = 'block';
        document.getElementById('debug-text').innerText = 'Cargando librerías...';
        
        // Cargar librerías dinámicamente para dispositivos modernos
        var scripts = [
            'https://code.jquery.com/jquery-3.5.1.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/locale/es.min.js',
            'https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js',
            'https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js',
            'https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js',
            'https://cdn.jsdelivr.net/npm/toastify-js'
        ];
        
        var styles = [
            'https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css',
            'https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css'
        ];
        
        // Cargar estilos
        styles.forEach(function(href) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = href;
            document.head.appendChild(link);
        });
        
        // Cargar scripts secuencialmente
        function loadScript(index) {
            if (index >= scripts.length) {
                // Todos los scripts cargados, inicializar
                setTimeout(initializeModernAgenda, 1000);
                return;
            }
            
            document.getElementById('debug-text').innerText = 'Cargando librería ' + (index + 1) + '/' + scripts.length;
            
            var script = document.createElement('script');
            script.src = scripts[index];
            script.onload = function() {
                loadScript(index + 1);
            };
            script.onerror = function() {
                console.error('Error cargando script:', scripts[index]);
                document.getElementById('debug-text').innerText = 'Error cargando librerías. Usando fallback.';
                setTimeout(showBasicFallback, 2000);
            };
            document.head.appendChild(script);
        }
        
        // Iniciar carga
        loadScript(0);
    }
    
    // Función para inicializar la agenda moderna (llamada después de cargar librerías)
    function initializeModernAgenda() {
        console.log('Inicializando agenda moderna...');
        
        document.getElementById('debug-text').innerText = 'Inicializando agenda moderna...';
        
        // Verificar que todas las dependencias estén cargadas
        if (typeof jQuery === 'undefined') {
            console.error('jQuery no cargado');
            showBasicFallback();
            return;
        }
        
        if (typeof FullCalendar === 'undefined') {
            console.error('FullCalendar no cargado');
            showBasicFallback();
            return;
        }
        
        // Inicializar variables jQuery
        var $ = jQuery;
        var calendarEl = document.getElementById('calendar');
        var citaModal = new bootstrap.Modal(document.getElementById('citaModal'));
        var pacienteModal = new bootstrap.Modal(document.getElementById('pacienteModal'));
        var citaModalEl = document.getElementById('citaModal');
        var citaForm = document.getElementById('citaForm');
        var modalTitle = document.getElementById('citaModalLabel');
        var modalDate = document.getElementById('citaModalDate');
        var statusIndicator = $('#status-indicator');
        var statusBadge = document.getElementById('status-badge');
        
        // Selects
        var pacienteSelect = $('#id_paciente');
        var dentistaSelect = $('#id_dentista');
        var unidadDentalSelect = $('#id_unidad_dental');
        var horaSelect = $('#id_hora');
        var serviciosSelect = $('#id_servicios_planeados');
        var listaServiciosSeleccionados = $('#lista-servicios-seleccionados');
        var hiddenServiciosInput = $('#id_servicios_seleccionados_hidden');
        
        var currentCitaId = null;
        
        try {
            // Configurar Select2
            pacienteSelect.select2({ theme: "bootstrap-5", placeholder: 'Seleccione...', dropdownParent: citaModalEl });
            dentistaSelect.select2({ theme: "bootstrap-5", placeholder: 'Seleccione...', dropdownParent: citaModalEl });
            unidadDentalSelect.select2({ theme: "bootstrap-5", placeholder: 'Seleccione...', dropdownParent: citaModalEl });
            serviciosSelect.select2({ theme: "bootstrap-5", placeholder: 'Añadir...', dropdownParent: citaModalEl });

            // Lógica de servicios
            function updateHiddenInput() {
                const ids = listaServiciosSeleccionados.find('li').map((i, el) => $(el).data('service-id')).get();
                hiddenServiciosInput.val(ids.join(','));
            }

            serviciosSelect.on('select2:select', function(e) {
                const data = e.params.data;
                if (data.id && !listaServiciosSeleccionados.find('li[data-service-id="' + data.id + '"]').length) {
                    const li = '<li class="list-group-item list-group-item-sm py-1 px-2 d-flex justify-content-between align-items-center" data-service-id="' + data.id + '">' +
                                    '<span>' + data.text + '</span>' +
                                    '<button type="button" class="btn-close remove-service-btn" aria-label="Eliminar"></button>' +
                                '</li>';
                    listaServiciosSeleccionados.append(li);
                    updateHiddenInput();
                    $(this).find('option[value="' + data.id + '"]').prop('disabled', true);
                    $(this).val(null).trigger('change');
                }
            });

            listaServiciosSeleccionados.on('click', '.remove-service-btn', function() {
                const li = $(this).closest('li');
                const serviceId = li.data('service-id');
                serviciosSelect.find('option[value="' + serviceId + '"]').prop('disabled', false);
                li.remove();
                updateHiddenInput();
                serviciosSelect.trigger('change');
            });

            // Lógica de pacientes
            $('#addPacienteBtn').on('click', function(){
                $('#pacienteFormInline')[0].reset();
                $('#paciente-errors').addClass('d-none').empty();
                pacienteModal.show();
            });

            $('#pacienteFormInline').on('submit', function(e){
                e.preventDefault();
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const payload = {
                    nombre: this.nombre.value,
                    apellido: this.apellido.value,
                    email: this.email.value,
                    telefono: this.telefono.value,
                    fecha_nacimiento: this.fecha_nacimiento.value
                };
                fetch('{% tenant_url "core:crear_paciente_ajax" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify(payload)
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        const option = new Option(data.paciente_nombre, data.paciente_id, true, true);
                        pacienteSelect.append(option).trigger('change');
                        pacienteModal.hide();
                        Toastify({ text: data.message, duration: 3000, className: 'info' }).showToast();
                    } else {
                        $('#paciente-errors').removeClass('d-none').text(data.error || 'Error al crear paciente');
                    }
                }).catch(() => {
                    $('#paciente-errors').removeClass('d-none').text('Error de red al crear paciente');
                });
            });

            // Configuración del calendario para FullCalendar 5.x
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: '{% tenant_url "core:agenda_events" %}',
                selectable: true,
                editable: true,
                
                dateClick: function(info) {
                    openNewAppointmentModal(info.dateStr);
                },
                
                eventClick: function(info) {
                    editAppointment(info.event.id);
                }
            });
            
            // Funciones auxiliares
            function openNewAppointmentModal(dateStr) {
                citaForm.reset();
                currentCitaId = null;
                modalTitle.textContent = 'Nueva Cita';
                const selectedDate = new Date(dateStr + 'T00:00:00');
                modalDate.textContent = 'Para el ' + selectedDate.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                citaForm.dataset.selectedDate = dateStr;

                [pacienteSelect, dentistaSelect, unidadDentalSelect, serviciosSelect].forEach(function(s) { s.val(null).trigger('change'); });
                horaSelect.empty().append('<option value="">Seleccione dentista</option>').prop('disabled', true);
                listaServiciosSeleccionados.empty();
                updateHiddenInput();
                
                statusIndicator.hide();
                $('#editarCitaBtn').hide();
                $('#cancelarCitaBtn').hide();
                $('#guardarCitaBtn').show();
                citaModal.show();
            }
            
            // Event listeners
            dentistaSelect.on('change', function() {
                const dentistaId = $(this).val();
                const selectedDate = citaForm.dataset.selectedDate;
                if (dentistaId && selectedDate) {
                    loadAvailableHours(dentistaId, selectedDate);
                } else {
                    horaSelect.empty().append('<option value="">Seleccione dentista</option>').prop('disabled', true);
                }
            });

            function loadAvailableHours(dentistaId, fecha, selectedHour) {
                horaSelect.empty().append('<option value="">Cargando...</option>').prop('disabled', true);
                $.ajax({
                    url: '{% tenant_url 'core:api_horarios_disponibles' dentista_id=0 %}'.replace('0', dentistaId),
                    data: { fecha: fecha },
                    success: function(response) {
                        horaSelect.empty().append('<option value="">Seleccione horario</option>');
                        const opciones = response.horarios_disponibles || [];
                        if (selectedHour && opciones.indexOf(selectedHour) === -1) {
                            opciones.unshift(selectedHour);
                        }
                        opciones.forEach(function(h) { horaSelect.append('<option value="' + h + '">' + h + '</option>'); });
                        if (selectedHour) horaSelect.val(selectedHour);
                        horaSelect.prop('disabled', false);
                    },
                    error: function() { horaSelect.empty().append('<option value="">Error al cargar</option>'); }
                });
            }
            
            // Form submission
            citaForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitAppointmentForm();
            });
            
            function submitAppointmentForm() {
                const formData = new FormData(citaForm);
                const url = currentCitaId ? '/citas/' + currentCitaId + '/update/' : '{% tenant_url "core:cita_create" %}';
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                formData.append('csrfmiddlewaretoken', csrftoken);
                
                const selectedDate = citaForm.dataset.selectedDate;
                const selectedTime = horaSelect.val();
                if (selectedDate && selectedTime) {
                    const localDateTime = selectedDate + 'T' + selectedTime + ':00';
                    formData.append('fecha_hora', localDateTime);
                }
                
                const serviciosIds = hiddenServiciosInput.val().split(',');
                formData.delete('servicios_planeados'); 
                serviciosIds.forEach(function(id) {
                    if (id) formData.append('servicios_planeados', id);
                });

                $.ajax({
                    url: url,
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: { "X-CSRFToken": csrftoken },
                    success: function(response) {
                        if (response.success) {
                            citaModal.hide();
                            Toastify({ text: response.message, duration: 3000, className: 'info' }).showToast();
                            calendar.refetchEvents();
                        } else {
                            showFormErrors(response.errors);
                        }
                    },
                    error: function(xhr) {
                        if (xhr.status === 403) {
                            Toastify({ text: 'Su sesión ha expirado. Redirigiendo...', duration: 3000, className: 'error' }).showToast();
                            setTimeout(function() { window.location.href = "{% tenant_url 'login' %}?next=" + encodeURIComponent(window.location.pathname); }, 2000);
                        } else {
                            Toastify({ text: 'Error de comunicación con el servidor.', duration: 3000, className: 'error' }).showToast();
                        }
                    }
                });
            }
            
            function showFormErrors(errors) {
                const formErrorsDiv = $('#form-errors');
                formErrorsDiv.html('<h6>Por favor, corrige los siguientes errores:</h6><ul></ul>').show();
                const errorList = formErrorsDiv.find('ul');
                if (typeof errors === 'object' && errors !== null) {
                    for (const field in errors) {
                        errors[field].forEach(function(error) {
                            let fieldName = field.replace(/_/g, ' ');
                            fieldName = fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
                            errorList.append('<li><strong>' + fieldName + ':</strong> ' + error + '</li>');
                        });
                    }
                } else {
                    errorList.append('<li>Error desconocido.</li>');
                }
            }
            
            document.getElementById('debug-text').innerText = 'Renderizando calendario...';
            calendar.render();
            
            document.getElementById('debug-text').innerText = 'Calendario moderno cargado exitosamente!';
            
            // Ocultar debug después de 3 segundos
            setTimeout(function() {
                document.getElementById('debug-info').style.display = 'none';
            }, 3000);
            
        } catch (error) {
            console.error('Error creando calendario:', error);
            document.getElementById('debug-text').innerText = 'Error: ' + error.message;
            showBasicFallback();
            return;
        }
    }

    // Función para mostrar fallback básico cuando falla el calendario moderno
    function showBasicFallback() {
        console.log('Mostrando fallback básico');
        var calendarEl = document.getElementById('calendar');
        
        calendarEl.innerHTML = 
            '<div class="alert alert-warning">' +
            '<h4><i class="fas fa-exclamation-triangle"></i> Calendario No Disponible</h4>' +
            '<p>El calendario avanzado no se puede cargar en este dispositivo.</p>' +
            '<p><strong>Opciones disponibles:</strong></p>' +
            '</div>' +
            '<div class="row">' +
            '<div class="col-md-6 mb-3">' +
            '<div class="card">' +
            '<div class="card-body text-center">' +
            '<i class="fas fa-plus-circle fa-3x text-primary mb-3"></i>' +
            '<h5>Gestionar Citas</h5>' +
            '<p>Ver y gestionar todas las citas</p>' +
            '<a href="{% tenant_url 'core:cita_list' %}" class="btn btn-primary btn-lg">Ir a Lista de Citas</a>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<div class="col-md-6 mb-3">' +
            '<div class="card">' +
            '<div class="card-body text-center">' +
            '<i class="fas fa-list fa-3x text-success mb-3"></i>' +
            '<h5>Calendario Simplificado</h5>' +
            '<p>Versión compatible con dispositivos antiguos</p>' +
            '<a href="{% tenant_url 'core:agenda_legacy' %}" class="btn btn-success btn-lg">Usar Versión Simple</a>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';
    }
    </script>
{% endblock %}