{% load math_filters %}
<div id="odontograma-clinico-mejorado" class="odontograma-clinico-mejorado">
    <style>
        .odontograma-clinico-mejorado {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background: #f5f3e8;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .odontograma-clinico-mejorado svg {
            width: 100%;
            height: auto;
            background: #f5f3e8;
            border-radius: 8px;
        }
        
        /* Fondo de enc铆as m谩s realista */
        .encia-superior {
            fill: url(#gradientEnciaSuperior);
            opacity: 0.7;
        }
        
        .encia-inferior {
            fill: url(#gradientEnciaInferior);
            opacity: 0.7;
        }
        
        /* L铆nea de divisi贸n central */
        .linea-central {
            stroke: #333;
            stroke-width: 2;
            opacity: 0.8;
        }
        
        /* Dientes con formas anat贸micas realistas */
        .diente-mejorado {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .diente-mejorado:hover {
            filter: drop-shadow(0 0 6px rgba(0, 123, 255, 0.8));
            transform: scale(1.05);
        }
        
        .diente-mejorado.selected {
            filter: drop-shadow(0 0 12px rgba(255, 193, 7, 1));
            transform: scale(1.08);
        }
        
        /* Superficie dental base */
        .superficie-dental-mejorada {
            fill: #ffffff;
            stroke: #333;
            stroke-width: 1;
        }
        
        /* Formas espec铆ficas por tipo de diente */
        
        /* MOLARES - Formas cuadradas con m煤ltiples c煤spides */
        .molar-superior .superficie-dental-mejorada {
            fill: #fafafa;
        }
        
        .molar-inferior .superficie-dental-mejorada {
            fill: #f8f8f8;
        }
        
        /* PREMOLARES - Formas ovaladas con dos c煤spides */
        .premolar-superior .superficie-dental-mejorada {
            fill: #fcfcfc;
        }
        
        .premolar-inferior .superficie-dental-mejorada {
            fill: #fafafa;
        }
        
        /* CANINOS - Formas triangulares puntiagudas */
        .canino-superior .superficie-dental-mejorada {
            fill: #fdfdfd;
        }
        
        .canino-inferior .superficie-dental-mejorada {
            fill: #fbfbfb;
        }
        
        /* INCISIVOS - Formas rectangulares */
        .incisivo-superior .superficie-dental-mejorada {
            fill: #ffffff;
        }
        
        .incisivo-inferior .superficie-dental-mejorada {
            fill: #fcfcfc;
        }
        
        /* Estados de diagn贸stico */
        .diente-mejorado.sano .superficie-dental-mejorada { fill: #4caf50; }
        .diente-mejorado.caries .superficie-dental-mejorada { fill: #f44336; }
        .diente-mejorado.obturada .superficie-dental-mejorada { fill: #ff9800; }
        .diente-mejorado.corona .superficie-dental-mejorada { fill: #2196f3; }
        .diente-mejorado.extraida .superficie-dental-mejorada { 
            fill: #9e9e9e; 
            stroke-dasharray: 3,2;
            opacity: 0.5;
        }
        .diente-mejorado.implante .superficie-dental-mejorada { fill: #00bcd4; }
        .diente-mejorado.endodoncia .superficie-dental-mejorada { fill: #e91e63; }
        
        /* Numeraci贸n de dientes */
        .numero-mejorado {
            font-family: 'Arial', sans-serif;
            font-size: 10px;
            font-weight: bold;
            fill: #333;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
        }
        
        /* Etiquetas direccionales */
        .etiqueta-direccional {
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            font-weight: bold;
            fill: #2d3748;
            text-anchor: middle;
        }
        
        .etiqueta-lateral {
            font-family: 'Arial', sans-serif;
            font-size: 11px;
            font-weight: 600;
            fill: #4a5568;
            text-anchor: middle;
        }
        
        /* L铆neas de c煤spides para detalle anat贸mico */
        .linea-cuspide {
            stroke: #ddd;
            stroke-width: 0.5;
            opacity: 0.8;
        }
        
        .linea-cuspide-principal {
            stroke: #ccc;
            stroke-width: 0.7;
            opacity: 0.9;
        }
    </style>
    
    <div class="text-center mb-3">
        <h4 style="color: #2d3748; margin-bottom: 6px; font-weight: 700;">
            Ψ Odontograma Cl铆nico Profesional Mejorado
        </h4>
        <p style="color: #4a5568; font-size: 0.9rem;">
            Formato est谩ndar de historia cl铆nica dental - Vista oclusal anat贸mica
        </p>
    </div>
    
    <svg viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg">
        <!-- Definir gradientes para enc铆as -->
        <defs>
            <radialGradient id="gradientEnciaSuperior" cx="50%" cy="30%" r="70%">
                <stop offset="0%" style="stop-color:#f2d4b3;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#e6c2a6;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#d4a574;stop-opacity:1" />
            </radialGradient>
            <radialGradient id="gradientEnciaInferior" cx="50%" cy="70%" r="70%">
                <stop offset="0%" style="stop-color:#f2d4b3;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#e6c2a6;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#d4a574;stop-opacity:1" />
            </radialGradient>
        </defs>
        
        <!-- Fondo principal -->
        <rect width="800" height="500" fill="#f5f3e8"/>
        
        <!-- ==================== REA DE ENCAS Y FORMA DE BOCA ==================== -->
        
        <!-- Enc铆a superior con forma de herradura -->
        <path d="M 100 150 Q 200 80 400 80 Q 600 80 700 150 Q 680 200 600 210 Q 500 220 400 220 Q 300 220 200 210 Q 120 200 100 150 Z" class="encia-superior"/>
        
        <!-- Enc铆a inferior con forma de herradura -->
        <path d="M 100 350 Q 120 300 200 290 Q 300 280 400 280 Q 500 280 600 290 Q 680 300 700 350 Q 600 420 400 420 Q 200 420 100 350 Z" class="encia-inferior"/>
        
        <!-- L铆nea central de divisi贸n -->
        <line x1="400" y1="40" x2="400" y2="460" class="linea-central"/>
        
        <!-- Etiquetas direccionales -->
        <text x="400" y="30" class="etiqueta-direccional">Superior</text>
        <text x="400" y="485" class="etiqueta-direccional">Inferior</text>
        <text x="70" y="255" class="etiqueta-lateral">Derecha Paciente</text>
        <text x="730" y="255" class="etiqueta-lateral">Izquierda Paciente</text>
        
        <!-- ==================== DIENTES SUPERIORES CON FORMAS ANATMICAS ==================== -->
        
        <!-- CUADRANTE SUPERIOR DERECHO (18-11) -->
        
        <!-- Diente 18 - Tercer Molar Superior -->
        <g class="diente-mejorado molar-superior" id="diente-18">
            <rect x="110" y="135" width="22" height="20" rx="3" class="superficie-dental-mejorada"/>
            <line x1="115" y1="140" x2="127" y2="140" class="linea-cuspide"/>
            <line x1="121" y1="137" x2="121" y2="153" class="linea-cuspide"/>
            <line x1="115" y1="150" x2="127" y2="150" class="linea-cuspide"/>
            <text x="121" y="145" class="numero-mejorado">18</text>
        </g>
        
        <!-- Diente 17 - Segundo Molar Superior -->
        <g class="diente-mejorado molar-superior" id="diente-17">
            <rect x="140" y="125" width="20" height="18" rx="3" class="superficie-dental-mejorada"/>
            <line x1="144" y1="130" x2="156" y2="130" class="linea-cuspide"/>
            <line x1="150" y1="127" x2="150" y2="141" class="linea-cuspide"/>
            <line x1="144" y1="138" x2="156" y2="138" class="linea-cuspide"/>
            <text x="150" y="134" class="numero-mejorado">17</text>
        </g>
        
        <!-- Diente 16 - Primer Molar Superior -->
        <g class="diente-mejorado molar-superior" id="diente-16">
            <rect x="168" y="115" width="18" height="16" rx="2" class="superficie-dental-mejorada"/>
            <line x1="171" y1="119" x2="183" y2="119" class="linea-cuspide"/>
            <line x1="177" y1="117" x2="177" y2="129" class="linea-cuspide"/>
            <line x1="171" y1="127" x2="183" y2="127" class="linea-cuspide"/>
            <text x="177" y="123" class="numero-mejorado">16</text>
        </g>
        
        <!-- Diente 15 - Segundo Premolar Superior -->
        <g class="diente-mejorado premolar-superior" id="diente-15">
            <ellipse cx="203" cy="110" rx="11" ry="8" class="superficie-dental-mejorada"/>
            <line x1="198" y1="110" x2="208" y2="110" class="linea-cuspide"/>
            <text x="203" y="110" class="numero-mejorado">15</text>
        </g>
        
        <!-- Diente 14 - Primer Premolar Superior -->
        <g class="diente-mejorado premolar-superior" id="diente-14">
            <ellipse cx="230" cy="108" rx="10" ry="7" class="superficie-dental-mejorada"/>
            <line x1="226" y1="108" x2="234" y2="108" class="linea-cuspide"/>
            <text x="230" y="108" class="numero-mejorado">14</text>
        </g>
        
        <!-- Diente 13 - Canino Superior -->
        <g class="diente-mejorado canino-superior" id="diente-13">
            <path d="M 252 112 Q 260 102 268 112 Q 266 122 260 124 Q 254 122 252 112 Z" class="superficie-dental-mejorada"/>
            <text x="260" y="115" class="numero-mejorado">13</text>
        </g>
        
        <!-- Diente 12 - Incisivo Lateral Superior -->
        <g class="diente-mejorado incisivo-superior" id="diente-12">
            <rect x="280" y="110" width="12" height="8" rx="2" class="superficie-dental-mejorada"/>
            <text x="286" y="114" class="numero-mejorado">12</text>
        </g>
        
        <!-- Diente 11 - Incisivo Central Superior -->
        <g class="diente-mejorado incisivo-superior" id="diente-11">
            <rect x="305" y="108" width="14" height="10" rx="2" class="superficie-dental-mejorada"/>
            <text x="312" y="113" class="numero-mejorado">11</text>
        </g>
        
        <!-- CUADRANTE SUPERIOR IZQUIERDO (21-28) -->
        
        <!-- Diente 21 - Incisivo Central Superior -->
        <g class="diente-mejorado incisivo-superior" id="diente-21">
            <rect x="481" y="108" width="14" height="10" rx="2" class="superficie-dental-mejorada"/>
            <text x="488" y="113" class="numero-mejorado">21</text>
        </g>
        
        <!-- Diente 22 - Incisivo Lateral Superior -->
        <g class="diente-mejorado incisivo-superior" id="diente-22">
            <rect x="508" y="110" width="12" height="8" rx="2" class="superficie-dental-mejorada"/>
            <text x="514" y="114" class="numero-mejorado">22</text>
        </g>
        
        <!-- Diente 23 - Canino Superior -->
        <g class="diente-mejorado canino-superior" id="diente-23">
            <path d="M 532 112 Q 540 102 548 112 Q 546 122 540 124 Q 534 122 532 112 Z" class="superficie-dental-mejorada"/>
            <text x="540" y="115" class="numero-mejorado">23</text>
        </g>
        
        <!-- Diente 24 - Primer Premolar Superior -->
        <g class="diente-mejorado premolar-superior" id="diente-24">
            <ellipse cx="570" cy="108" rx="10" ry="7" class="superficie-dental-mejorada"/>
            <line x1="566" y1="108" x2="574" y2="108" class="linea-cuspide"/>
            <text x="570" y="108" class="numero-mejorado">24</text>
        </g>
        
        <!-- Diente 25 - Segundo Premolar Superior -->
        <g class="diente-mejorado premolar-superior" id="diente-25">
            <ellipse cx="597" cy="110" rx="11" ry="8" class="superficie-dental-mejorada"/>
            <line x1="592" y1="110" x2="602" y2="110" class="linea-cuspide"/>
            <text x="597" y="110" class="numero-mejorado">25</text>
        </g>
        
        <!-- Diente 26 - Primer Molar Superior -->
        <g class="diente-mejorado molar-superior" id="diente-26">
            <rect x="614" y="115" width="18" height="16" rx="2" class="superficie-dental-mejorada"/>
            <line x1="617" y1="119" x2="629" y2="119" class="linea-cuspide"/>
            <line x1="623" y1="117" x2="623" y2="129" class="linea-cuspide"/>
            <line x1="617" y1="127" x2="629" y2="127" class="linea-cuspide"/>
            <text x="623" y="123" class="numero-mejorado">26</text>
        </g>
        
        <!-- Diente 27 - Segundo Molar Superior -->
        <g class="diente-mejorado molar-superior" id="diente-27">
            <rect x="640" y="125" width="20" height="18" rx="3" class="superficie-dental-mejorada"/>
            <line x1="644" y1="130" x2="656" y2="130" class="linea-cuspide"/>
            <line x1="650" y1="127" x2="650" y2="141" class="linea-cuspide"/>
            <line x1="644" y1="138" x2="656" y2="138" class="linea-cuspide"/>
            <text x="650" y="134" class="numero-mejorado">27</text>
        </g>
        
        <!-- Diente 28 - Tercer Molar Superior -->
        <g class="diente-mejorado molar-superior" id="diente-28">
            <rect x="668" y="135" width="22" height="20" rx="3" class="superficie-dental-mejorada"/>
            <line x1="673" y1="140" x2="685" y2="140" class="linea-cuspide"/>
            <line x1="679" y1="137" x2="679" y2="153" class="linea-cuspide"/>
            <line x1="673" y1="150" x2="685" y2="150" class="linea-cuspide"/>
            <text x="679" y="145" class="numero-mejorado">28</text>
        </g>
        
        <!-- ==================== DIENTES INFERIORES CON FORMAS ANATMICAS ==================== -->
        
        <!-- CUADRANTE INFERIOR DERECHO (48-41) -->
        
        <!-- Diente 48 - Tercer Molar Inferior -->
        <g class="diente-mejorado molar-inferior" id="diente-48">
            <rect x="110" y="345" width="22" height="20" rx="3" class="superficie-dental-mejorada"/>
            <line x1="115" y1="350" x2="127" y2="350" class="linea-cuspide"/>
            <line x1="121" y1="347" x2="121" y2="363" class="linea-cuspide"/>
            <line x1="115" y1="360" x2="127" y2="360" class="linea-cuspide"/>
            <text x="121" y="355" class="numero-mejorado">48</text>
        </g>
        
        <!-- Diente 47 - Segundo Molar Inferior -->
        <g class="diente-mejorado molar-inferior" id="diente-47">
            <rect x="140" y="355" width="20" height="18" rx="3" class="superficie-dental-mejorada"/>
            <line x1="144" y1="360" x2="156" y2="360" class="linea-cuspide"/>
            <line x1="150" y1="357" x2="150" y2="371" class="linea-cuspide"/>
            <line x1="144" y1="368" x2="156" y2="368" class="linea-cuspide"/>
            <text x="150" y="364" class="numero-mejorado">47</text>
        </g>
        
        <!-- Diente 46 - Primer Molar Inferior -->
        <g class="diente-mejorado molar-inferior" id="diente-46">
            <rect x="168" y="365" width="18" height="16" rx="2" class="superficie-dental-mejorada"/>
            <line x1="171" y1="369" x2="183" y2="369" class="linea-cuspide"/>
            <line x1="177" y1="367" x2="177" y2="379" class="linea-cuspide"/>
            <line x1="171" y1="377" x2="183" y2="377" class="linea-cuspide"/>
            <text x="177" y="373" class="numero-mejorado">46</text>
        </g>
        
        <!-- Diente 45 - Segundo Premolar Inferior -->
        <g class="diente-mejorado premolar-inferior" id="diente-45">
            <ellipse cx="203" cy="382" rx="11" ry="8" class="superficie-dental-mejorada"/>
            <line x1="198" y1="382" x2="208" y2="382" class="linea-cuspide"/>
            <text x="203" y="382" class="numero-mejorado">45</text>
        </g>
        
        <!-- Diente 44 - Primer Premolar Inferior -->
        <g class="diente-mejorado premolar-inferior" id="diente-44">
            <ellipse cx="230" cy="384" rx="10" ry="7" class="superficie-dental-mejorada"/>
            <line x1="226" y1="384" x2="234" y2="384" class="linea-cuspide"/>
            <text x="230" y="384" class="numero-mejorado">44</text>
        </g>
        
        <!-- Diente 43 - Canino Inferior -->
        <g class="diente-mejorado canino-inferior" id="diente-43">
            <path d="M 252 386 Q 260 376 268 386 Q 266 396 260 398 Q 254 396 252 386 Z" class="superficie-dental-mejorada"/>
            <text x="260" y="389" class="numero-mejorado">43</text>
        </g>
        
        <!-- Diente 42 - Incisivo Lateral Inferior -->
        <g class="diente-mejorado incisivo-inferior" id="diente-42">
            <rect x="280" y="387" width="12" height="8" rx="2" class="superficie-dental-mejorada"/>
            <text x="286" y="391" class="numero-mejorado">42</text>
        </g>
        
        <!-- Diente 41 - Incisivo Central Inferior -->
        <g class="diente-mejorado incisivo-inferior" id="diente-41">
            <rect x="305" y="388" width="14" height="10" rx="2" class="superficie-dental-mejorada"/>
            <text x="312" y="393" class="numero-mejorado">41</text>
        </g>
        
        <!-- CUADRANTE INFERIOR IZQUIERDO (31-38) -->
        
        <!-- Diente 31 - Incisivo Central Inferior -->
        <g class="diente-mejorado incisivo-inferior" id="diente-31">
            <rect x="481" y="388" width="14" height="10" rx="2" class="superficie-dental-mejorada"/>
            <text x="488" y="393" class="numero-mejorado">31</text>
        </g>
        
        <!-- Diente 32 - Incisivo Lateral Inferior -->
        <g class="diente-mejorado incisivo-inferior" id="diente-32">
            <rect x="508" y="387" width="12" height="8" rx="2" class="superficie-dental-mejorada"/>
            <text x="514" y="391" class="numero-mejorado">32</text>
        </g>
        
        <!-- Diente 33 - Canino Inferior -->
        <g class="diente-mejorado canino-inferior" id="diente-33">
            <path d="M 532 386 Q 540 376 548 386 Q 546 396 540 398 Q 534 396 532 386 Z" class="superficie-dental-mejorada"/>
            <text x="540" y="389" class="numero-mejorado">33</text>
        </g>
        
        <!-- Diente 34 - Primer Premolar Inferior -->
        <g class="diente-mejorado premolar-inferior" id="diente-34">
            <ellipse cx="570" cy="384" rx="10" ry="7" class="superficie-dental-mejorada"/>
            <line x1="566" y1="384" x2="574" y2="384" class="linea-cuspide"/>
            <text x="570" y="384" class="numero-mejorado">34</text>
        </g>
        
        <!-- Diente 35 - Segundo Premolar Inferior -->
        <g class="diente-mejorado premolar-inferior" id="diente-35">
            <ellipse cx="597" cy="382" rx="11" ry="8" class="superficie-dental-mejorada"/>
            <line x1="592" y1="382" x2="602" y2="382" class="linea-cuspide"/>
            <text x="597" y="382" class="numero-mejorado">35</text>
        </g>
        
        <!-- Diente 36 - Primer Molar Inferior -->
        <g class="diente-mejorado molar-inferior" id="diente-36">
            <rect x="614" y="365" width="18" height="16" rx="2" class="superficie-dental-mejorada"/>
            <line x1="617" y1="369" x2="629" y2="369" class="linea-cuspide"/>
            <line x1="623" y1="367" x2="623" y2="379" class="linea-cuspide"/>
            <line x1="617" y1="377" x2="629" y2="377" class="linea-cuspide"/>
            <text x="623" y="373" class="numero-mejorado">36</text>
        </g>
        
        <!-- Diente 37 - Segundo Molar Inferior -->
        <g class="diente-mejorado molar-inferior" id="diente-37">
            <rect x="640" y="355" width="20" height="18" rx="3" class="superficie-dental-mejorada"/>
            <line x1="644" y1="360" x2="656" y2="360" class="linea-cuspide"/>
            <line x1="650" y1="357" x2="650" y2="371" class="linea-cuspide"/>
            <line x1="644" y1="368" x2="656" y2="368" class="linea-cuspide"/>
            <text x="650" y="364" class="numero-mejorado">37</text>
        </g>
        
        <!-- Diente 38 - Tercer Molar Inferior -->
        <g class="diente-mejorado molar-inferior" id="diente-38">
            <rect x="668" y="345" width="22" height="20" rx="3" class="superficie-dental-mejorada"/>
            <line x1="673" y1="350" x2="685" y2="350" class="linea-cuspide"/>
            <line x1="679" y1="347" x2="679" y2="363" class="linea-cuspide"/>
            <line x1="673" y1="360" x2="685" y2="360" class="linea-cuspide"/>
            <text x="679" y="355" class="numero-mejorado">38</text>
        </g>
        
    </svg>
</div>

<script>
(function() {
    'use strict';
    
    function log(mensaje) {
        console.log(`[ODONTOGRAMA CLNICO MEJORADO] ${mensaje}`);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        log('Iniciando odontograma cl铆nico mejorado sin paneles');
        
        const dientes = document.querySelectorAll('.diente-mejorado');
        log(`Configurando ${dientes.length} dientes con formas anat贸micas mejoradas`);
        
        dientes.forEach(function(diente, index) {
            const dienteId = diente.id;
            const numeroFDI = dienteId.replace('diente-', '');
            const cuadrante = Math.floor(numeroFDI / 10);
            const posicion = numeroFDI % 10;
            
            // Determinar el tipo de diente
            let tipoDiente = '';
            if (posicion === 1 || posicion === 2) {
                tipoDiente = 'Incisivo';
            } else if (posicion === 3) {
                tipoDiente = 'Canino';
            } else if (posicion === 4 || posicion === 5) {
                tipoDiente = 'Premolar';
            } else if (posicion === 6 || posicion === 7 || posicion === 8) {
                tipoDiente = 'Molar';
            }
            
            diente.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                log(`Diente seleccionado: ${numeroFDI} (${tipoDiente}, Cuadrante ${cuadrante})`);
                
                // Remover selecci贸n anterior
                document.querySelectorAll('.diente-mejorado').forEach(d => {
                    d.classList.remove('selected');
                });
                
                // Seleccionar diente actual
                diente.classList.add('selected');
                
                // Disparar evento personalizado
                const eventoSeleccion = new CustomEvent('dienteMejoradoSeleccionado', {
                    detail: {
                        numeroFDI: numeroFDI,
                        cuadrante: cuadrante,
                        posicion: posicion,
                        tipoDiente: tipoDiente,
                        elemento: diente
                    }
                });
                
                document.dispatchEvent(eventoSeleccion);
            });
            
            diente.addEventListener('mouseenter', function() {
                log(`Hover en diente FDI ${numeroFDI} (${tipoDiente})`);
            });
        });
        
        log('Odontograma cl铆nico mejorado inicializado correctamente');
    });
    
    // Funci贸n global para aplicar diagn贸sticos
    window.aplicarDiagnosticoMejorado = function(numeroFDI, diagnostico) {
        const diente = document.getElementById(`diente-${numeroFDI}`);
        if (diente) {
            // Remover diagn贸sticos anteriores
            diente.classList.remove('sano', 'caries', 'obturada', 'corona', 'extraida', 'implante', 'endodoncia');
            
            // Aplicar nuevo diagn贸stico
            if (diagnostico) {
                diente.classList.add(diagnostico);
                log(`Diagn贸stico aplicado: Diente ${numeroFDI} - ${diagnostico}`);
            }
        }
    };
    
    // Funci贸n global para limpiar selecciones
    window.limpiarSeleccionMejorado = function() {
        document.querySelectorAll('.diente-mejorado').forEach(diente => {
            diente.classList.remove('selected', 'sano', 'caries', 'obturada', 'corona', 'extraida', 'implante', 'endodoncia');
        });
        log('Selecci贸n y diagn贸sticos limpiados');
    };
    
})();
</script>