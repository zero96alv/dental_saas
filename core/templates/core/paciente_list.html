{% extends 'core/base.html' %}
{% load tenant_urls %}
{% load static %}

{% block title %}Lista de Pacientes{% endblock %}

{% block extra_css %}
<style>
.estado-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.badge-pendiente {
    background-color: #6c757d;
    color: white;
}

.badge-completo {
    background-color: #198754;
    color: white;
}

.badge-actualizar {
    background-color: #ffc107;
    color: black;
}

.filtros-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
}

.estadisticas-card {
    background-color: #007bff;
    color: white;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
}

.saldo-positivo {
    color: #dc3545;
    font-weight: bold;
}

.saldo-cero {
    color: #6c757d;
}

.portal-access {
    color: #198754;
}

.no-portal {
    color: #6c757d;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.acciones-container {
    min-width: 320px;
    margin: 0 auto;
}

.acciones-container .btn {
    font-size: 0.8rem;
    padding: 0.375rem 0.5rem;
    border-radius: 0.25rem;
    white-space: nowrap;
    min-width: 70px;
    text-align: center;
}

.acciones-container .btn i {
    font-size: 0.75rem;
}

/* Colores mejorados para mejor contraste */
.btn-outline-primary:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-success {
    background-color: #198754;
    border-color: #198754;
}

.btn-warning {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
}

.btn-info {
    background-color: #0dcaf0;
    border-color: #0dcaf0;
    color: #000;
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
}

/* Mejorar espaciado en celdas */
.table td {
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
}

@media (max-width: 768px) {
    .acciones-container {
        min-width: auto;
        flex-direction: column;
    }
    .acciones-container .btn {
        font-size: 0.7rem;
        padding: 0.25rem 0.375rem;
        margin-bottom: 0.25rem;
        min-width: 60px;
    }
    .acciones-container .btn i {
        font-size: 0.7rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="text-primary mb-1">
                <i class="fas fa-users me-2"></i>Lista de Pacientes
            </h1>
            <p class="text-muted mb-0">Gestión integral de pacientes y historial clínico</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% tenant_url 'core:paciente_create' %}" class="btn btn-primary">
                <i class="fas fa-user-plus me-2"></i>Añadir Paciente
            </a>
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filtros-collapse">
                <i class="fas fa-filter me-2"></i>Filtros
            </button>
        </div>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="estadisticas-card p-3 mb-4">
        <div class="row text-center">
            <div class="col-md-2">
                <div class="fs-4 fw-bold">{{ estadisticas.total }}</div>
                <small>Total</small>
            </div>
            <div class="col-md-2">
                <div class="fs-4 fw-bold">{{ estadisticas.con_historial }}</div>
                <small>Con Historial</small>
            </div>
            <div class="col-md-2">
                <div class="fs-4 fw-bold">{{ estadisticas.sin_historial }}</div>
                <small>Sin Historial</small>
            </div>
            <div class="col-md-2">
                <div class="fs-4 fw-bold">{{ estadisticas.con_portal }}</div>
                <small>Con Portal</small>
            </div>
            <div class="col-md-2">
                <div class="fs-4 fw-bold">{{ estadisticas.con_saldo }}</div>
                <small>Con Saldo</small>
            </div>
            <div class="col-md-2">
                <div class="fs-4 fw-bold">{{ page_obj.paginator.count }}</div>
                <small>Mostrados</small>
            </div>
        </div>
    </div>

    <!-- Formulario de filtros -->
    <div class="collapse{% if request.GET %} show{% endif %}" id="filtros-collapse">
        <div class="filtros-card p-3">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    {{ form.busqueda.label_tag }}
                    {{ form.busqueda }}
                </div>
                <div class="col-md-2">
                    {{ form.estado_historial.label_tag }}
                    {{ form.estado_historial }}
                </div>
                <div class="col-md-2">
                    {{ form.ordenar_por.label_tag }}
                    {{ form.ordenar_por }}
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="form-check">
                        {{ form.con_saldo_pendiente }}
                        {{ form.con_saldo_pendiente.label_tag }}
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="form-check">
                        {{ form.con_acceso_portal }}
                        {{ form.con_acceso_portal.label_tag }}
                    </div>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Buscar
                    </button>
                    <a href="{% tenant_url 'core:paciente_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>Limpiar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de pacientes -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Paciente</th>
                            <th>Contacto</th>
                            <th class="text-center">Historial Clínico</th>
                            <th class="text-center">Portal</th>
                            <th class="text-end">Saldo</th>
                            <th class="text-center" style="width: 380px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for paciente in pacientes %}
                        <tr>
                            <td>
                                <div>
                                    <strong>{{ paciente.nombre }} {{ paciente.apellido }}</strong><br>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        {% if paciente.fecha_nacimiento %}
                                            {{ paciente.edad }} años
                                        {% else %}
                                            Edad no registrada
                                        {% endif %}
                                    </small>
                                </div>
                            </td>
                            <td>
                                <div>
                                    <i class="fas fa-envelope me-1 text-muted"></i>
                                    <a href="mailto:{{ paciente.email }}">{{ paciente.email }}</a>
                                </div>
                                {% if paciente.telefono %}
                                <div class="mt-1">
                                    <i class="fas fa-phone me-1 text-muted"></i>
                                    <a href="tel:{{ paciente.telefono }}">{{ paciente.telefono }}</a>
                                </div>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if paciente.estado_historial == 'pendiente' %}
                                    <span class="badge estado-badge badge-pendiente">
                                        <i class="fas fa-clock me-1"></i>Pendiente
                                    </span>
                                {% elif paciente.estado_historial == 'completo' %}
                                    <span class="badge estado-badge badge-completo">
                                        <i class="fas fa-check-circle me-1"></i>Completo
                                    </span>
                                {% elif paciente.estado_historial == 'actualizar' %}
                                    <span class="badge estado-badge badge-actualizar">
                                        <i class="fas fa-refresh me-1"></i>Actualizar
                                    </span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if paciente.tiene_acceso_portal %}
                                    <span class="portal-access">
                                        <i class="fas fa-check-circle me-1"></i>Activo
                                    </span>
                                {% else %}
                                    <span class="no-portal">
                                        <i class="fas fa-times-circle me-1"></i>No
                                    </span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if paciente.saldo_global > 0 %}
                                    <span class="saldo-positivo">
                                        ${{ paciente.saldo_global|floatformat:2 }}
                                    </span>
                                {% else %}
                                    <span class="saldo-cero">
                                        $0.00
                                    </span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="acciones-container d-flex flex-wrap gap-1 justify-content-center align-items-center">
                                    <!-- Botón Ver -->
                                    <a href="{% tenant_url 'core:paciente_detail' paciente.pk %}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye me-1"></i>Ver
                                    </a>
                                    
                                    <!-- Botón Historial -->
                                    {% if paciente.estado_historial == 'pendiente' %}
                                        <a href="{% tenant_url 'core:paciente_historial_mejorado' paciente.pk %}" 
                                           class="btn btn-sm btn-success">
                                            <i class="fas fa-plus me-1"></i>Crear
                                        </a>
                                    {% elif paciente.estado_historial == 'actualizar' %}
                                        <a href="{% tenant_url 'core:paciente_historial_mejorado' paciente.pk %}" 
                                           class="btn btn-sm btn-warning">
                                            <i class="fas fa-sync-alt me-1"></i>Actualizar
                                        </a>
                                    {% else %}
                                        <a href="{% tenant_url 'core:paciente_historial_mejorado' paciente.pk %}" 
                                           class="btn btn-sm btn-info">
                                            <i class="fas fa-clipboard-list me-1"></i>Historial
                                        </a>
                                    {% endif %}
                                    
                                    <!-- Botón Portal -->
                                    {% if not paciente.tiene_acceso_portal %}
                                        <a href="{% tenant_url 'core:paciente_invitar' paciente.pk %}" 
                                           class="btn btn-sm btn-secondary">
                                            <i class="fas fa-envelope me-1"></i>Portal
                                        </a>
                                    {% endif %}
                                    
                                    <!-- Menú desplegable -->
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                type="button" 
                                                data-bs-toggle="dropdown">
                                            <i class="fas fa-cog me-1"></i>Más
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="{% tenant_url 'core:paciente_edit' paciente.pk %}">
                                                    <i class="fas fa-edit me-2"></i>Editar Datos
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="{% tenant_url 'core:odontograma_48' paciente.pk %}">
                                                    <i class="fas fa-tooth me-2"></i>Odontograma
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="{% tenant_url 'core:paciente_history' paciente.pk %}">
                                                    <i class="fas fa-history me-2"></i>Historial Completo
                                                </a>
                                            </li>
                                            {% if paciente.saldo_global > 0 %}
                                            <li>
                                                <a class="dropdown-item" href="{% tenant_url 'core:registrar_pago_paciente' paciente.pk %}">
                                                    <i class="fas fa-dollar-sign me-2"></i>Registrar Pago
                                                </a>
                                            </li>
                                            {% endif %}
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="{% tenant_url 'core:paciente_delete' paciente.pk %}">
                                                    <i class="fas fa-trash me-2"></i>Eliminar
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No se encontraron pacientes</h5>
                                {% if request.GET %}
                                    <p class="text-muted">Intenta ajustar los filtros de búsqueda</p>
                                    <a href="{% tenant_url 'core:paciente_list' %}" class="btn btn-outline-primary">
                                        <i class="fas fa-times me-2"></i>Limpiar filtros
                                    </a>
                                {% else %}
                                    <p class="text-muted">Comienza registrando tu primer paciente</p>
                                    <a href="{% tenant_url 'core:paciente_create' %}" class="btn btn-primary">
                                        <i class="fas fa-user-plus me-2"></i>Añadir Paciente
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Paginación -->
    {% if is_paginated %}
    <nav aria-label="Paginación de pacientes" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            {% endif %}
        </ul>
        
        <div class="text-center text-muted mt-2">
            Mostrando {{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ page_obj.paginator.count }} pacientes
        </div>
    </nav>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-envío del formulario cuando cambian los selectores
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('#filtros-collapse select');
    const checkboxes = document.querySelectorAll('#filtros-collapse input[type="checkbox"]');
    
    selects.forEach(select => {
        select.addEventListener('change', function() {
            // Pequeño delay para mejor UX
            setTimeout(() => {
                this.closest('form').submit();
            }, 100);
        });
    });
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            setTimeout(() => {
                this.closest('form').submit();
            }, 100);
        });
    });
    
    // Búsqueda con delay
    const busquedaInput = document.querySelector('input[name="busqueda"]');
    if (busquedaInput) {
        let searchTimeout;
        busquedaInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                this.closest('form').submit();
            }, 500);
        });
    }
});
</script>
{% endblock %}
