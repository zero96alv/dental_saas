{% extends 'core/base.html' %}
{% load tenant_urls %}
{% load static %}
{% load custom_tags %}

{% block title %}Trabajos de Laboratorio{% endblock %}

{% block extra_css %}
<style>
    .badge-estado-trabajo {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
    .badge-SOLICITADO { background-color: #0dcaf0; color: #000; }
    .badge-EN_PROCESO { background-color: #ffc107; color: #000; }
    .badge-ENTREGADO { background-color: #198754; color: #fff; }
    .badge-COLOCADO { background-color: #0d6efd; color: #fff; }
    .badge-PAGADO { background-color: #6c757d; color: #fff; }
    .badge-CANCELADO { background-color: #dc3545; color: #fff; }

    .trabajo-card {
        border-left: 5px solid;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .trabajo-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .trabajo-SOLICITADO { border-left-color: #0dcaf0; }
    .trabajo-EN_PROCESO { border-left-color: #ffc107; }
    .trabajo-ENTREGADO { border-left-color: #198754; }
    .trabajo-COLOCADO { border-left-color: #0d6efd; }
    .trabajo-PAGADO { border-left-color: #6c757d; }
    .trabajo-CANCELADO { border-left-color: #dc3545; }

    .trabajo-retrasado {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
    }

    .stats-card {
        border-radius: 10px;
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: scale(1.02);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-0">
                <i class="bi bi-hospital me-2"></i>Trabajos de Laboratorio Dental
            </h1>
            <p class="text-muted mb-0">Total: {{ total_trabajos }} trabajos</p>
        </div>
        <div>
            <a href="{% tenant_url 'core:trabajo_laboratorio_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Nueva Solicitud
            </a>
        </div>
    </div>

    <!-- Estadísticas Rápidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card text-center border-primary">
                <div class="card-body py-2">
                    <small class="text-muted">Total Trabajos</small>
                    <h4 class="mb-0 text-primary">{{ total_trabajos }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card text-center border-warning">
                <div class="card-body py-2">
                    <small class="text-muted">Pendientes</small>
                    <h4 class="mb-0 text-warning">{{ trabajos_pendientes }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card text-center border-danger">
                <div class="card-body py-2">
                    <small class="text-muted">Retrasados</small>
                    <h4 class="mb-0 text-danger">{{ trabajos_retrasados }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card text-center border-success">
                <div class="card-body py-2">
                    <small class="text-muted">Margen Total</small>
                    <h4 class="mb-0 text-success">${{ total_margen|floatformat:2 }}</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="bi bi-funnel me-2"></i>Filtros
            </h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    {{ filtro_form.busqueda }}
                </div>
                <div class="col-md-2">
                    {{ filtro_form.estado }}
                </div>
                <div class="col-md-2">
                    {{ filtro_form.laboratorio }}
                </div>
                <div class="col-md-2">
                    {{ filtro_form.tipo_trabajo }}
                </div>
                <div class="col-md-1">
                    {{ filtro_form.fecha_desde }}
                </div>
                <div class="col-md-1">
                    {{ filtro_form.fecha_hasta }}
                </div>
                <div class="col-md-1 d-flex gap-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i>
                    </button>
                    <a href="{% tenant_url 'core:trabajo_laboratorio_list' %}" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i>
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Listado de Trabajos -->
    {% if trabajos %}
        <div class="row">
            {% for trabajo in trabajos %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card trabajo-card trabajo-{{ trabajo.estado }} {% if trabajo.esta_retrasado %}trabajo-retrasado{% endif %} h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-clipboard-data me-1"></i>
                                {{ trabajo.tipo_trabajo.nombre }}
                            </h5>
                            <span class="badge badge-estado-trabajo badge-{{ trabajo.estado }}">
                                {{ trabajo.get_estado_display }}
                            </span>
                        </div>

                        {% if trabajo.esta_retrasado %}
                        <div class="alert alert-warning py-1 px-2 mb-2">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i>
                            <small><strong>Retrasado</strong></small>
                        </div>
                        {% endif %}

                        <p class="mb-2">
                            <i class="bi bi-person-fill text-primary me-1"></i>
                            <strong>Paciente:</strong> {{ trabajo.paciente.nombre }} {{ trabajo.paciente.apellido }}
                        </p>

                        <p class="mb-2">
                            <i class="bi bi-building text-info me-1"></i>
                            <strong>Laboratorio:</strong> {{ trabajo.laboratorio.nombre }}
                        </p>

                        <p class="mb-2">
                            <i class="bi bi-tooth text-secondary me-1"></i>
                            <strong>Dientes:</strong> {{ trabajo.dientes }}
                        </p>

                        <p class="mb-2">
                            <i class="bi bi-palette text-warning me-1"></i>
                            <strong>Material:</strong> {{ trabajo.material|default:"N/A" }}
                            {% if trabajo.color %} / Color: {{ trabajo.color }}{% endif %}
                        </p>

                        <hr>

                        <div class="row text-center mb-2">
                            <div class="col-6">
                                <small class="text-muted">Costo Lab</small>
                                <div><strong>${{ trabajo.costo_laboratorio|floatformat:2 }}</strong></div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Precio Pac</small>
                                <div class="text-success"><strong>${{ trabajo.precio_paciente|floatformat:2 }}</strong></div>
                            </div>
                        </div>

                        <div class="text-center mb-2">
                            <small class="text-muted">Margen</small>
                            <div class="text-primary"><strong>${{ trabajo.margen|floatformat:2 }}</strong></div>
                        </div>

                        <hr>

                        <div class="mb-2">
                            <small class="text-muted d-block">Solicitado</small>
                            <small>{{ trabajo.fecha_solicitud|date:"d/m/Y" }} ({{ trabajo.dias_transcurridos }} días)</small>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted d-block">Entrega estimada</small>
                            <small><strong>{{ trabajo.fecha_entrega_estimada|date:"d/m/Y" }}</strong></small>
                        </div>

                        <div class="d-grid gap-2">
                            <a href="{% tenant_url 'core:trabajo_laboratorio_detail' trabajo.pk %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye me-1"></i>Ver Detalles
                            </a>
                        </div>
                    </div>

                    <div class="card-footer bg-light">
                        <small class="text-muted">
                            <i class="bi bi-person-badge me-1"></i>
                            Dr. {{ trabajo.dentista_solicitante.nombre }} {{ trabajo.dentista_solicitante.apellido }}
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Paginación -->
        {% if is_paginated %}
        <nav aria-label="Paginación de trabajos">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.busqueda %}&busqueda={{ request.GET.busqueda }}{% endif %}">Primera</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.busqueda %}&busqueda={{ request.GET.busqueda }}{% endif %}">Anterior</a>
                    </li>
                {% endif %}

                <li class="page-item active">
                    <span class="page-link">
                        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                    </span>
                </li>

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.busqueda %}&busqueda={{ request.GET.busqueda }}{% endif %}">Siguiente</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.busqueda %}&busqueda={{ request.GET.busqueda }}{% endif %}">Última</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

    {% else %}
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle me-2"></i>
            No se encontraron trabajos de laboratorio.
            <a href="{% tenant_url 'core:trabajo_laboratorio_create' %}" class="alert-link">Crear la primera solicitud</a>
        </div>
    {% endif %}
</div>
{% endblock %}
