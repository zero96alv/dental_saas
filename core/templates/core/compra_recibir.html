{% extends "core/base.html" %}
{% load tenant_urls %}
{% load crispy_forms_tags %}

{% block title %}Recibir Compra #{{ compra.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-success text-white">
            <h2 class="mb-0">
                <i class="bi bi-box-arrow-in-down me-2"></i>Recibir Mercanc√≠a de Compra #{{ compra.id }}
            </h2>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <p><strong>Proveedor:</strong> {{ compra.proveedor|default:"Compra sin proveedor espec√≠fico" }}</p>
                    <p><strong>Fecha de Compra:</strong> {{ compra.fecha_compra|date:"d/m/Y H:i" }}</p>
                    <p><strong>Tipo:</strong> <span class="badge bg-info">{{ compra.get_tipo_compra_display }}</span></p>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-info mb-0">
                        <h6><i class="bi bi-info-circle me-2"></i>Instrucciones:</h6>
                        <ul class="mb-0 small">
                            <li>Seleccione la <strong>Unidad Dental</strong> donde se almacenar√° cada insumo</li>
                            <li>Complete los campos de <strong>Lote y Caducidad</strong> para insumos COFEPRIS</li>
                            <li>Para dividir entre unidades, cree m√∫ltiples l√≠neas en la compra original</li>
                        </ul>
                    </div>
                </div>
            </div>

            <hr>

            <form method="post">
                {% csrf_token %}
                {{ formset.management_form }}

                <h4 class="mb-3">
                    <i class="bi bi-clipboard-check me-2"></i>Detalles de la Recepci√≥n
                </h4>

                {% for form in formset %}
                    <div class="card mb-3 border-start border-primary border-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="card-title mb-1">
                                        <i class="bi bi-box-seam me-2 text-primary"></i>
                                        {{ form.instance.insumo.nombre }}
                                    </h5>
                                    {% if form.instance.insumo.descripcion %}
                                        <p class="text-muted small mb-2">{{ form.instance.insumo.descripcion }}</p>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="badge bg-success fs-6 mb-2">
                                        Cantidad: {{ form.instance.cantidad }}
                                        {% if form.instance.insumo.unidad_empaque %}
                                            {{ form.instance.insumo.unidad_empaque }}s
                                            <small class="d-block">({{ form.instance.insumo.cantidad_por_empaque }} {{ form.instance.insumo.unidad_medida }}s por {{ form.instance.insumo.unidad_empaque }})</small>
                                        {% else %}
                                            {{ form.instance.insumo.unidad_medida }}{% if form.instance.cantidad > 1 %}s{% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            {{ form.id }}
                            {{ form.insumo }}
                            {{ form.cantidad }}

                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="alert alert-light border-start border-warning border-4 mb-3">
                                        <i class="bi bi-building me-2"></i>
                                        <strong>Distribuir entre Unidades Dentales:</strong>
                                        <small class="d-block text-muted">Puede dividir la cantidad entre varias unidades. Total disponible: <span class="fw-bold">{{ form.instance.cantidad }}</span></small>
                                    </div>

                                    <!-- Contenedor de asignaciones din√°micas -->
                                    <div class="asignaciones-container" data-detalle-idx="{{ forloop.counter0 }}" data-cantidad-total="{{ form.instance.cantidad }}">
                                        <!-- Primera asignaci√≥n (por defecto) -->
                                        <div class="asignacion-row card mb-2 border-info" data-asignacion-idx="0">
                                            <div class="card-body py-2">
                                                <div class="row align-items-center">
                                                    <div class="col-md-6">
                                                        <label class="form-label small mb-1">Unidad Dental:</label>
                                                        <select class="form-select form-select-sm unidad-select" name="detalle_{{ forloop.counter0 }}_unidades[]" required>
                                                            <option value="">Seleccione unidad...</option>
                                                            {% for unidad in form.fields.unidad_dental.queryset %}
                                                                <option value="{{ unidad.id }}">{{ unidad.nombre }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label small mb-1">Cantidad:</label>
                                                        <input type="number" class="form-control form-control-sm cantidad-input"
                                                               name="detalle_{{ forloop.counter0 }}_cantidades[]"
                                                               min="1" max="{{ form.instance.cantidad }}"
                                                               value="{{ form.instance.cantidad }}" required>
                                                    </div>
                                                    <div class="col-md-2 text-end">
                                                        <label class="form-label small mb-1 text-white">.</label>
                                                        <button type="button" class="btn btn-sm btn-danger eliminar-asignacion" style="display:none;">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Bot√≥n agregar + resumen -->
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary agregar-destino" data-detalle-idx="{{ forloop.counter0 }}">
                                            <i class="bi bi-plus-circle me-1"></i>Agregar Otro Destino
                                        </button>
                                        <div class="badge bg-secondary restante-badge">
                                            Restante: <span class="restante-valor">0</span> / {{ form.instance.cantidad }}
                                        </div>
                                    </div>

                                    <!-- Campos ocultos del formset original (mantener compatibilidad) -->
                                    <input type="hidden" name="{{ form.prefix }}-unidad_dental" class="unidad-dental-hidden">
                                </div>

                                {% if form.instance.insumo.requiere_lote_caducidad %}
                                    <div class="col-12 mt-3">
                                        <div class="alert alert-warning border-start border-danger border-4 mb-2">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            <strong>Insumo con Seguimiento COFEPRIS</strong>
                                            <small class="d-block">Este insumo requiere n√∫mero de lote y fecha de caducidad</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.numero_lote|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.fecha_caducidad|as_crispy_field }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}

                <hr>
                <div class="d-flex justify-content-end gap-2">
                    <a href="{% tenant_url 'core:compra_list' %}" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle me-1"></i>Confirmar Recepci√≥n y Actualizar Stock
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Sistema de divisi√≥n din√°mica de compras cargado');

    // Configurar todos los contenedores de asignaciones
    document.querySelectorAll('.asignaciones-container').forEach(container => {
        const detalleIdx = container.dataset.detalleIdx;
        const cantidadTotal = parseInt(container.dataset.cantidadTotal);

        // Funci√≥n para actualizar el restante y validaciones
        function actualizarRestante() {
            let sumaAsignada = 0;
            container.querySelectorAll('.cantidad-input').forEach(input => {
                sumaAsignada += parseInt(input.value) || 0;
            });

            const restante = cantidadTotal - sumaAsignada;
            const badgeRestante = container.parentElement.querySelector('.restante-badge');
            const valorRestante = badgeRestante.querySelector('.restante-valor');

            valorRestante.textContent = restante;

            // Cambiar color del badge seg√∫n el restante
            badgeRestante.classList.remove('bg-secondary', 'bg-success', 'bg-warning', 'bg-danger');
            if (restante === 0) {
                badgeRestante.classList.add('bg-success');
            } else if (restante > 0) {
                badgeRestante.classList.add('bg-warning');
            } else {
                badgeRestante.classList.add('bg-danger');
            }

            // Habilitar/deshabilitar bot√≥n agregar
            const btnAgregar = container.parentElement.querySelector('.agregar-destino');
            if (restante <= 0) {
                btnAgregar.disabled = true;
                btnAgregar.classList.add('disabled');
            } else {
                btnAgregar.disabled = false;
                btnAgregar.classList.remove('disabled');
            }

            // Actualizar max de todos los inputs
            container.querySelectorAll('.cantidad-input').forEach(input => {
                const valorActual = parseInt(input.value) || 0;
                input.max = valorActual + restante;
            });
        }

        // Funci√≥n para actualizar botones de eliminar
        function actualizarBotonesEliminar() {
            const asignaciones = container.querySelectorAll('.asignacion-row');
            asignaciones.forEach((row, idx) => {
                const btnEliminar = row.querySelector('.eliminar-asignacion');
                if (asignaciones.length > 1) {
                    btnEliminar.style.display = 'inline-block';
                } else {
                    btnEliminar.style.display = 'none';
                }
            });
        }

        // Event listeners para cambios en cantidad
        container.addEventListener('input', function(e) {
            if (e.target.classList.contains('cantidad-input')) {
                actualizarRestante();
            }
        });

        // Event listener para bot√≥n agregar destino
        const btnAgregar = container.parentElement.querySelector('.agregar-destino');
        btnAgregar.addEventListener('click', function() {
            const asignaciones = container.querySelectorAll('.asignacion-row');
            const ultimaAsignacion = asignaciones[asignaciones.length - 1];
            const nuevoIdx = asignaciones.length;

            // Clonar la √∫ltima asignaci√≥n
            const nuevaAsignacion = ultimaAsignacion.cloneNode(true);
            nuevaAsignacion.dataset.asignacionIdx = nuevoIdx;

            // Limpiar valores
            const select = nuevaAsignacion.querySelector('.unidad-select');
            const input = nuevaAsignacion.querySelector('.cantidad-input');

            select.selectedIndex = 0;
            input.value = Math.max(1, parseInt(container.parentElement.querySelector('.restante-valor').textContent));

            // Agregar al contenedor
            container.appendChild(nuevaAsignacion);

            actualizarRestante();
            actualizarBotonesEliminar();

            console.log(`‚ûï Agregada asignaci√≥n #${nuevoIdx} para detalle ${detalleIdx}`);
        });

        // Event listener para botones eliminar (delegaci√≥n)
        container.addEventListener('click', function(e) {
            if (e.target.closest('.eliminar-asignacion')) {
                e.preventDefault();
                const row = e.target.closest('.asignacion-row');
                const asignaciones = container.querySelectorAll('.asignacion-row');

                if (asignaciones.length > 1) {
                    row.remove();
                    actualizarRestante();
                    actualizarBotonesEliminar();
                    console.log(`üóëÔ∏è Eliminada asignaci√≥n`);
                }
            }
        });

        // Inicializar
        actualizarRestante();
        actualizarBotonesEliminar();
    });

    // Validaci√≥n antes de enviar el formulario
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        let errores = [];

        document.querySelectorAll('.asignaciones-container').forEach(container => {
            const detalleIdx = container.dataset.detalleIdx;
            const cantidadTotal = parseInt(container.dataset.cantidadTotal);
            const restanteValor = parseInt(container.parentElement.querySelector('.restante-valor').textContent);

            if (restanteValor !== 0) {
                errores.push(`Detalle #${parseInt(detalleIdx) + 1}: Debe asignar exactamente ${cantidadTotal} unidades (restante: ${restanteValor})`);
            }

            // Validar que no haya unidades duplicadas
            const unidades = [];
            container.querySelectorAll('.unidad-select').forEach(select => {
                if (select.value && unidades.includes(select.value)) {
                    errores.push(`Detalle #${parseInt(detalleIdx) + 1}: No puede asignar a la misma unidad dos veces`);
                }
                unidades.push(select.value);
            });
        });

        if (errores.length > 0) {
            e.preventDefault();
            alert('‚ùå Errores de validaci√≥n:\n\n' + errores.join('\n'));
            return false;
        }

        console.log('‚úÖ Validaci√≥n exitosa, enviando formulario...');
    });

    console.log('‚úÖ Sistema de divisi√≥n din√°mica inicializado correctamente');
});
</script>
{% endblock %}
