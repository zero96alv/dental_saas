{% extends "core/base.html" %}
{% load tenant_urls %}
{% load crispy_forms_tags %}

{% block title %}Procesar Pago de Cita{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">Procesar Pago</h2>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h5 class="mb-2">Paciente</h5>
          <p class="mb-1"><strong>{{ paciente.nombre }} {{ paciente.apellido }}</strong></p>
          <p class="mb-0 text-muted">Email: {{ paciente.email|default:"N/D" }}</p>
        </div>
        <div class="col-md-6 text-md-end">
          <h5 class="mb-2">Cita</h5>
          <p class="mb-1">#{{ cita.id }} â€¢ {{ cita.fecha_hora|date:"d/m/Y H:i" }}</p>
          <p class="mb-0">Servicios realizados: {{ cita.servicios_realizados|length }}</p>
        </div>
      </div>
      <hr>
      <div class="row">
        <div class="col-md-4">
          <div class="alert alert-info mb-0">
            <div><strong>Saldo del paciente:</strong></div>
            <div class="fs-5">${{ paciente.saldo_global|floatformat:2 }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        {{ form|crispy }}

        <!-- Indicador de cambio -->
        <div id="cambioIndicador" class="alert alert-success mt-2" style="display:none;">
          <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-cash-stack me-2"></i><strong>Cambio a devolver:</strong></span>
            <span class="fs-5 fw-bold" id="cambioMonto">$0.00</span>
          </div>
        </div>

        <div id="datosFiscalesBox" class="mt-3" style="display:none;">
          <div class="alert alert-secondary py-2 mb-2">
            Complete los datos fiscales para emitir factura
          </div>
          {{ datos_fiscales_form|crispy }}
        </div>

        <div class="d-flex justify-content-between mt-3">
          <a href="{% tenant_url 'core:citas_pendientes_pago' %}" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-cash-coin me-1"></i> Registrar Pago
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    // Manejo de datos fiscales
    const chk = document.getElementById('id_desea_factura');
    const box = document.getElementById('datosFiscalesBox');
    function toggle(){ box.style.display = chk && chk.checked ? '' : 'none'; }
    if(chk){
      chk.addEventListener('change', toggle);
      toggle();
    }

    // Manejo de cambio para pagos en efectivo
    const metodoPagoField = document.getElementById('id_metodo_pago');
    const montoField = document.getElementById('id_monto');
    const montoRecibidoField = document.getElementById('id_monto_recibido');
    const cambioIndicador = document.getElementById('cambioIndicador');
    const cambioMonto = document.getElementById('cambioMonto');
    const montoRecibidoWrapper = montoRecibidoField ? montoRecibidoField.closest('.mb-3') : null;

    function toggleMontoRecibido() {
      if (!metodoPagoField || !montoRecibidoWrapper) return;

      const esEfectivo = metodoPagoField.value === 'Efectivo';

      if (esEfectivo) {
        montoRecibidoWrapper.style.display = '';
      } else {
        montoRecibidoWrapper.style.display = 'none';
        if (montoRecibidoField) montoRecibidoField.value = '';
        cambioIndicador.style.display = 'none';
      }
    }

    function calcularCambio() {
      if (!montoField || !montoRecibidoField || !metodoPagoField) return;

      const esEfectivo = metodoPagoField.value === 'Efectivo';
      const monto = parseFloat(montoField.value) || 0;
      const montoRecibido = parseFloat(montoRecibidoField.value) || 0;

      if (esEfectivo && montoRecibido > 0 && montoRecibido >= monto) {
        const cambio = montoRecibido - monto;
        cambioMonto.textContent = '$' + cambio.toFixed(2);
        cambioIndicador.style.display = '';
      } else {
        cambioIndicador.style.display = 'none';
      }
    }

    if (metodoPagoField) {
      metodoPagoField.addEventListener('change', function() {
        toggleMontoRecibido();
        calcularCambio();
      });
      toggleMontoRecibido(); // Inicializar al cargar
    }

    if (montoRecibidoField) {
      montoRecibidoField.addEventListener('input', calcularCambio);
    }

    if (montoField) {
      montoField.addEventListener('input', calcularCambio);
    }
  });
</script>
{% endblock %}

