{% extends "core/base.html" %}
{% load tenant_urls %}
{% load crispy_forms_tags %}

{% block title %}Procesar Pago de Cita{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">Procesar Pago</h2>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h5 class="mb-2">Paciente</h5>
          <p class="mb-1"><strong>{{ paciente.nombre }} {{ paciente.apellido }}</strong></p>
          <p class="mb-0 text-muted">Email: {{ paciente.email|default:"N/D" }}</p>
        </div>
        <div class="col-md-6 text-md-end">
          <h5 class="mb-2">Cita</h5>
          <p class="mb-1">#{{ cita.id }} â€¢ {{ cita.fecha_hora|date:"d/m/Y H:i" }}</p>
          <p class="mb-0">Servicios realizados: {{ cita.servicios_realizados.all|length }}</p>
        </div>
      </div>
      <hr>
      <div class="row">
        <div class="col-md-4">
          <div class="alert alert-info mb-0">
            <div><strong>Saldo del paciente:</strong></div>
            <div class="fs-5">${{ paciente.saldo_global|floatformat:2 }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        {{ form|crispy }}

        <div id="datosFiscalesBox" class="mt-3" style="display:none;">
          <div class="alert alert-secondary py-2 mb-2">
            Complete los datos fiscales para emitir factura
          </div>
          {{ datos_fiscales_form|crispy }}
        </div>

        <div class="d-flex justify-content-between mt-3">
          <a href="{% tenant_url 'core:citas_pendientes_pago' %}" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-cash-coin me-1"></i> Registrar Pago
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    const chk = document.getElementById('id_desea_factura');
    const box = document.getElementById('datosFiscalesBox');
    function toggle(){ box.style.display = chk && chk.checked ? '' : 'none'; }
    if(chk){
      chk.addEventListener('change', toggle);
      toggle();
    }
  });
</script>
{% endblock %}

