# Sesión de Desarrollo - 23 Octubre 2025

## Resumen Ejecutivo
Refactorización arquitectural del sistema de servicios realizados + integración completa de odontograma con gestión de citas.

## Problemas Resueltos

### 1. Redundancia de Datos - servicios_realizados
**Problema**: Servicios almacenados en dos lugares creando inconsistencias
- `Cita.servicios_realizados` (M2M a Servicio)
- `TratamientoCita.servicios` (M2M a Servicio)

**Solución**:
- Eliminado campo `Cita.servicios_realizados`
- Convertido a `@property` que calcula desde `TratamientoCita.servicios`
- Migración: `0033_eliminar_servicios_realizados.py`

### 2. Error ProgrammingError en /demo/citas/
**Problema**:
```
relation "core_cita_servicios_realizados" does not exist
```

**Causa**: Múltiples vistas intentaban `prefetch_related('servicios_realizados')`

**Solución**:
- Actualizar todos los `prefetch_related` a `'tratamientos_realizados__servicios'`
- Remover `.all()` de templates (la property ya retorna QuerySet)
- Archivos corregidos: `core/views.py` (5 lugares), 8 templates

### 3. Falta de Integración Odontograma-Servicios
**Problema**: No había forma de vincular servicios realizados con dientes tratados en UI

**Solución**: Implementación completa en `/citas/X/gestionar/`:
- Selector multi-servicio con servicios planeados pre-seleccionados
- Botón "Copiar dientes seleccionados" desde odontograma
- Procesamiento automático en backend
- Visualización de servicios en lista de tratamientos

## Archivos Modificados

### Modelos (core/models.py)
```python
# Líneas 492-498: Eliminado campo servicios_realizados
# Líneas 512-529: Agregado @property servicios_realizados
# Líneas 73-75: Simplificado Paciente.actualizar_saldo_global()
```

### Vistas (core/views.py)
```python
# CitaListView (línea 1426): Actualizado prefetch_related
# Reporte facturación (línea 2462): Actualizado prefetch_related
# CitasPendientesPagoListView (línea 1555-1557): Usar properties
# ReciboPagoView (línea 2158, 2240): Remover .all()
# CitaManageView (línea 3627): Agregar servicios_disponibles
# _handle_tratamiento (línea 3710-3719): Procesar servicios_ids
```

### Templates
- `core/templates/core/cita_manage.html`: Selector servicios + botón copiar
- 8 templates: Remover `.all()` de `servicios_realizados`

### Scripts de Datos
- `generar_datos_completos.py`: 5 escenarios completos (Carlos, María, Juan, Ana, Luis)

## Commits Realizados

1. **649c5b4**: Refactorizar: Eliminar campo servicios_realizados
2. **126948a**: Fix: Corregir referencias en vistas y templates
3. **00d6150**: Feature: Integrar selección de servicios y dientes

## Comandos Ejecutados

```bash
# Crear migración
python manage.py makemigrations --name eliminar_servicios_realizados

# Aplicar a demo schema
python manage.py migrate_schemas --schema=demo

# Generar datos de prueba
python generar_datos_completos.py

# Reiniciar servidor
sudo systemctl restart dental-saas.service
```

## Estructura de Datos Resultante

```
Cita
  ├─ servicios_planeados (M2M) ← Lo que se PLANEA hacer
  └─ servicios_realizados (@property) ← Calculado desde tratamientos
       └─ Calcula desde: TratamientoCita.servicios

TratamientoCita (FUENTE DE VERDAD)
  ├─ cita (FK)
  ├─ dientes_tratados (CharField: "16,17,18")
  ├─ servicios (M2M a Servicio) ← AQUÍ se guardan servicios realizados
  ├─ descripcion (TextField)
  ├─ diagnostico_final (FK a Diagnostico)
  └─ fecha_registro (DateTimeField)

HistorialEstadoDiente (Para cada diente)
  ├─ paciente (FK)
  ├─ numero_diente (IntegerField)
  ├─ diagnostico_anterior (FK)
  ├─ diagnostico_nuevo (FK)
  └─ tratamiento_cita (FK, optional)

EstadoDiente (Estado ACTUAL de cada diente)
  ├─ paciente (FK)
  ├─ numero_diente (IntegerField, unique per patient)
  └─ diagnostico (FK) ← Estado actual
```

## Flujo de Usuario Implementado

1. **Dentista abre cita**: `/demo/citas/1/gestionar/`
2. **Pestaña Tratamientos**: Ve odontograma interactivo
3. **Selecciona dientes**: Click múltiple en odontograma (se marcan con borde azul)
4. **Copia dientes**: Click "Copiar dientes seleccionados" → campo se llena: "16,17,18"
5. **Selecciona servicios**: Ctrl+Click en multi-select (pre-poblado con servicios planeados)
6. **Completa formulario**:
   - Descripción del tratamiento
   - Estado inicial de dientes
   - Estado final de dientes
   - Diagnóstico final (ej: OBTURACION)
7. **Registra tratamiento**: Click "Registrar Tratamiento"

**Resultado automático**:
- ✅ Odontograma actualizado con nuevo diagnóstico
- ✅ `HistorialEstadoDiente` creado para cada diente
- ✅ `EstadoDiente` actualizado a diagnóstico final
- ✅ `TratamientoCita` creado con servicios vinculados
- ✅ `cita.servicios_realizados` ahora retorna los servicios
- ✅ `cita.costo_real` recalculado automáticamente
- ✅ Lista de tratamientos muestra servicios con badges verdes

## Testing Manual Realizado

✅ `/demo/citas/` - Lista de citas funciona sin error
✅ `/demo/citas/1/gestionar/` - Gestión de cita con odontograma
✅ Selección múltiple de dientes en odontograma
✅ Botón copiar dientes con feedback visual
✅ Selector multi-servicio con validación
✅ Registro de tratamiento completo
✅ Visualización de servicios en tratamientos existentes
✅ Cálculo correcto de saldo pendiente

## Próximas Tareas (No realizadas en esta sesión)

1. Modificar `cita_manage.html` de 4 tabs a vista única (propuesta aprobada pero no implementada)
2. Agregar alertas de trabajo pendiente
3. Integrar fotos/evidencia de tratamientos
4. Sistema de prescripciones
5. Notificaciones de seguimiento automáticas

## Notas para Futuras Sesiones

### Importante recordar
- **NUNCA** usar `prefetch_related('servicios_realizados')` - ya no es campo DB
- **SIEMPRE** usar `prefetch_related('tratamientos_realizados__servicios')`
- **Templates**: `cita.servicios_realizados` (sin .all())
- **Servidor**: Reiniciar después de cambios de código

### Debugging común
```bash
# Ver logs del servidor
sudo journalctl -u dental-saas.service -f

# Verificar migración aplicada
python manage.py showmigrations core | grep 0033

# Acceder a shell de demo tenant
python manage.py shell
from tenants.models import Clinica
from django.db import connection
tenant = Clinica.objects.get(schema_name='demo')
connection.set_tenant(tenant)
```

### Archivos clave para modificaciones futuras
- **Modelo Cita**: `core/models.py:470-555`
- **Vista CitaManageView**: `core/views.py:3595-3768`
- **Template gestión**: `core/templates/core/cita_manage.html`
- **Odontograma API**: `core/views.py:2850-2950`

## Datos de Prueba Generados

Script `generar_datos_completos.py` creó:
- 5 pacientes con escenarios diferentes
- 24 citas en varios estados
- 14 tratamientos registrados
- 19 cambios dentales en historial
- 14 pagos procesados

Pacientes:
1. **Carlos Rodríguez**: Historial extenso (3 citas completadas, $-2000 crédito)
2. **María González**: Endodoncia activa (2 completadas, 1 mañana, $3000 pendiente)
3. **Juan Pérez**: Casos complejos (1 cita EN ATENCIÓN, $1200 pendiente)
4. **Ana Martínez**: Paciente nuevo (1 cita programada, $0)
5. **Luis Sánchez**: Con deuda ($4200 pendiente por implante)

---

**Fecha**: 23 Octubre 2025
**Duración**: ~3 horas
**Commits**: 3 commits, 190+ líneas cambiadas
**Estado**: ✅ Todo funcionando en producción
